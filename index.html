<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1e40af">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="נוכחות">
  <title>מערכת נוכחות - תעשיידע</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192x192.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    /* iOS and Mobile Touch Fixes */
    html {
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Heebo', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #eef2f7 100%);
      color: #1e293b;
      direction: rtl;
      font-size: 14px;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      max-width: 100vw;
      position: relative;
    }
    
    html {
      overflow-x: hidden;
      max-width: 100vw;
    }
    
    #mainApp, #loginScreen {
      max-width: 100vw;
      overflow-x: hidden;
    }
    
    /* Prevent iOS zoom on input focus */
    input, select, textarea {
      font-size: 16px !important;
    }
    
    /* Better touch targets */
    a, button, input, select, textarea, .nav-item, .btn {
      touch-action: manipulation;
    }
    
    /* Safe area padding for notched phones */
    .mobile-bottom-nav {
      padding-bottom: max(env(safe-area-inset-bottom), 8px);
    }
    
    .main-content {
      padding-bottom: max(env(safe-area-inset-bottom), 20px);
    }
    
    /* Smooth transitions for all interactive elements */
    button, .btn, input, select, .nav-item, .stat-card, .card {
      transition: all 0.2s ease;
    }

    .hidden { display: none !important; }

    /* ============= Login Screen ============= */
    #loginScreen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #e8eef5 0%, #f1f5f9 50%, #e2e8f0 100%);
      padding: 20px;
    }

    .login-card {
      background: white;
      padding: 35px 30px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0;
      max-width: 360px;
      width: 100%;
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .login-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(0,0,0,0.15), 0 5px 15px rgba(0,0,0,0.1);
    }

    .login-logo {
      max-width: 160px;
      margin-bottom: 20px;
    }

    .login-card h2 {
      color: #1e293b;
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .login-card p {
      color: #64748b;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .form-group {
      margin-bottom: 14px;
      text-align: right;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: #475569;
      font-weight: 500;
      font-size: 13px;
    }

    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Heebo', sans-serif;
      transition: all 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-login {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Heebo', sans-serif;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 8px;
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-height: 48px; /* Extra height for primary action */
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-login:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(30, 64, 175, 0.3);
    }

    .btn-login:active {
      transform: translateY(0);
    }

    .login-error {
      color: #ef4444;
      background: #fee2e2;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
      display: none;
    }

    .login-error.show {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* ============= Main App Layout ============= */
    #mainApp {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
      border-left: 1px solid #e8ecf1;
      display: flex;
      flex-direction: column;
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      z-index: 100;
      box-shadow: -4px 0 20px rgba(0,0,0,0.04), -1px 0 6px rgba(0,0,0,0.02);
    }

    .sidebar-header {
      padding: 16px 14px;
      border-bottom: 1px solid #e2e8f0;
      text-align: center;
    }

    .sidebar-logo {
      max-width: 130px;
    }

    .sidebar-user {
      padding: 14px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 38px;
      height: 38px;
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
    }

    .user-info h3 {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .user-info p {
      font-size: 12px;
      color: #64748b;
    }

    .sidebar-nav {
      flex: 1;
      padding: 12px 10px;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 12px;
      color: #64748b;
      text-decoration: none;
      border-radius: 10px;
      margin-bottom: 3px;
      transition: all 0.25s ease;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
      position: relative;
      min-height: 44px; /* Touch target minimum */
      gap: 10px;
    }

    .nav-item:hover {
      background: linear-gradient(135deg, #f1f5f9 0%, #e8ecf1 100%);
      transform: translateX(-2px);
      color: #3b82f6;
    }

    .nav-item.active {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: #3b82f6;
    }

    .nav-item i {
      margin-left: 10px;
      font-size: 15px;
      width: 20px;
    }

    .sidebar-footer {
      padding: 12px;
      border-top: 1px solid #e2e8f0;
    }

    .btn-logout {
      width: 100%;
      padding: 10px;
      background: #fee2e2;
      color: #dc2626;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Heebo', sans-serif;
    }

    .btn-logout:hover {
      background: #fecaca;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-right: 240px;
      padding: 20px;
    }

    .page-header {
      margin-bottom: 20px;
    }

    .page-header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 4px;
    }

    .page-header p {
      color: #64748b;
      font-size: 13px;
    }

    /* Dashboard Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.8);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, rgba(59,130,246,0.3), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08), 0 16px 32px rgba(0,0,0,0.06);
      border-color: #e2e8f0;
    }
    
    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .stat-card-title {
      color: #64748b;
      font-size: 12px;
      font-weight: 500;
    }

    .stat-card-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .stat-card.blue .stat-card-icon {
      background: #eff6ff;
      color: #3b82f6;
    }

    .stat-card.purple .stat-card-icon {
      background: #f3e8ff;
      color: #a855f7;
    }

    .stat-card.green .stat-card-icon {
      background: #ecfdf5;
      color: #10b981;
    }

    .stat-card.orange .stat-card-icon {
      background: #fff7ed;
      color: #f59e0b;
    }

    .stat-card-value {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .stat-card-label {
      font-size: 11px;
      color: #94a3b8;
    }

    /* Content Card */
    .content-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.04);
      border: 1px solid #f1f5f9;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .content-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .card-header {
      padding: 16px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(180deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.4) 100%);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
    }

    .card-body {
      padding: 16px;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    table thead {
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
    }

    table th {
      padding: 10px 12px;
      text-align: right;
      font-weight: 600;
      color: #475569;
      font-size: 12px;
    }

    table td {
      padding: 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      color: #64748b;
      font-size: 12px;
    }

    table tbody tr:hover {
      background: #f8fafc;
    }

    /* Buttons - Uniform Size */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Heebo', sans-serif;
      transition: all 0.2s;
      box-shadow: 0 3px 10px rgba(0,0,0,0.12);
      min-height: 48px;
      min-width: 140px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.18);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* כחול - ראשי */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }

    /* ירוק - הצלחה/אישור */
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .btn-success:hover {
      background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
    }

    /* כחול כהה - אישור */
    .btn-approve {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn-approve:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    /* סגול - פעולה מיוחדת */
    .btn-purple {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
    }
    .btn-purple:hover {
      background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
    }

    /* כתום - אזהרה */
    .btn-warning {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      color: white;
    }
    .btn-warning:hover {
      background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
    }

    /* אדום - מחיקה/סכנה */
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    .btn-danger:hover {
      background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
    }

    /* תכלת - מידע */
    .btn-info {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: white;
    }
    .btn-info:hover {
      background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%);
    }

    /* אפור - משני */
    .btn-secondary {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      color: white;
    }
    .btn-secondary:hover {
      background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    }

    /* Searchable Dropdown */
    .searchable-dropdown {
      position: relative;
      width: 100%;
    }
    
    .searchable-dropdown-toggle {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Heebo', sans-serif;
      background: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 44px;
      text-align: right;
    }
    
    .searchable-dropdown-toggle:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .searchable-dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      left: 0;
      background: white;
      border: 2px solid #e2e8f0;
      border-top: none;
      border-radius: 0 0 10px 10px;
      max-height: 280px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .searchable-dropdown-menu.open {
      display: block;
    }
    
    .searchable-dropdown-search {
      position: sticky;
      top: 0;
      background: #f8fafc;
      padding: 10px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .searchable-dropdown-search input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Heebo', sans-serif;
    }
    
    .searchable-dropdown-search input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .searchable-dropdown-option {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid #f1f5f9;
      font-size: 14px;
    }
    
    .searchable-dropdown-option:hover {
      background: #eff6ff;
      color: #3b82f6;
    }
    
    .searchable-dropdown-option.selected {
      background: #dbeafe;
      color: #1e40af;
      font-weight: 600;
    }
    
    .searchable-dropdown-option.hidden {
      display: none;
    }

    /* כפתור אייקון בלבד */
    .btn-icon {
      min-width: 48px;
      width: 48px;
      padding: 0;
    }

    /* Alert */
    .alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s;
    }

    .alert.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .alert.success {
      background: #dcfce7;
      color: #16a34a;
    }

    .alert.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .alert.info {
      background: #dbeafe;
      color: #3b82f6;
    }

    .mobile-info-banner {
      display: none;
      align-items: center;
      gap: 8px;
      background: #e0f2fe;
      color: #0f172a;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      border: 1px solid #bae6fd;
      margin: 0 0 12px 0;
      position: sticky;
      top: 56px;
      z-index: 180;
      min-height: 44px;
    }

    .mobile-info-banner span {
      line-height: 1.4;
    }

    .mobile-menu-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      background: rgba(255, 255, 255, 0.15);
      color: white;
      cursor: pointer;
      flex-shrink: 0;
    }

    .mobile-greeting-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-bottom: 14px;
      padding: 16px;
    }
    
    @media (max-width: 1200px) {
      .form-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      .hide-mobile {
        display: none !important;
      }
    }

    .form-field label {
      display: block;
      margin-bottom: 4px;
      color: #475569;
      font-weight: 500;
      font-size: 13px;
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
      width: 100%;
      max-width: 350px;
      padding: 8px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Heebo', sans-serif;
      transition: all 0.25s ease;
      background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }
    
    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1), inset 0 1px 2px rgba(0,0,0,0.04);
      outline: none;
    }

    .form-field textarea {
      max-width: 100%;
    }

    .form-field input[type="time"] {
      cursor: pointer;
      -webkit-appearance: listbox;
      position: relative;
    }
    
    /* Fix for time input odd behavior on some mobile browsers */
    input[type="time"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
    }

    /* Time picker dropdowns - RTL aligned with LTR internal display */
    .time-picker-row {
      display: flex;
      flex-direction: row-reverse;
      gap: 6px;
      align-items: center;
      width: 180px;
      max-width: 180px;
    }

    .time-picker-row select {
      width: 72px;
      min-width: 72px;
      max-width: 72px;
      flex-shrink: 0;
      text-align: center;
      font-weight: 600;
      font-size: 15px;
      max-height: 200px;
      overflow-y: auto;
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      border: 1.5px solid #cbd5e1;
      border-radius: 10px;
      padding: 10px 8px;
      color: #1e40af;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .time-picker-row select:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
    }
    
    .time-picker-row select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .time-picker-row .time-separator {
      font-size: 20px;
      font-weight: bold;
      color: #3b82f6;
      width: 12px;
      text-align: center;
    }

    @media (max-width: 768px) {
      .time-picker-row select {
        min-height: 50px;
        font-size: 18px;
      }

      .time-picker-row .time-separator {
        font-size: 24px;
      }
    }

    .form-field input:-moz-read-only {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    .form-field input:read-only {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    /* Page */
    .page {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .silent-loading {
      opacity: 0.5;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    @keyframes subtleLoadBar {
      0% { width: 5%; opacity: 0.7; }
      50% { width: 70%; opacity: 1; }
      100% { width: 95%; opacity: 0.7; }
    }

    .loading-bar {
      position: fixed;
      top: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      z-index: 99999;
      animation: subtleLoadBar 1.8s ease-in-out infinite;
    }

    /* Hide floating submit on desktop */
    .mobile-floating-submit {
      display: none;
    }

    /* Mobile Greeting Header */
    .mobile-greeting {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 54px;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      padding: 0 16px;
      z-index: 199;
      align-items: center;
      font-weight: 600;
      font-size: 16px;
      gap: 12px;
      justify-content: space-between;
    }
    
    .mobile-greeting .mobile-logo {
      height: 32px;
      width: auto;
      display: none;
    }

    /* Mobile Menu Toggle */
    /* Responsive - Tablet */
    @media (max-width: 1024px) {
      .sidebar {
        width: 220px;
      }
      .main-content {
        margin-right: 220px;
        padding: 16px;
      }
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Add Record Page - Desktop Compact */
    @media (min-width: 769px) {
      #addRecordPage .card {
        max-width: 95%;
        margin: 0 auto;
        transform: scale(0.95);
        transform-origin: top center;
      }
    }

    /* Add Record Page - Mobile Responsive */
    @media (max-width: 900px) {
      #addRecordPage > div[style*="grid-template-columns: repeat(2"] {
        grid-template-columns: 1fr !important;
      }
    }
    
    @media (max-width: 768px) {
      #addRecordPage .page-header {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 12px !important;
      }
      
      #addRecordPage .page-header > div:first-child {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 10px !important;
      }
      
      #addRecordPage .page-header h1 {
        font-size: 20px !important;
      }
      
      #formUserInfoHeader {
        width: 100% !important;
        justify-content: center !important;
        font-size: 13px !important;
        padding: 8px 12px !important;
      }
      
      #addRecordPage .page-header > div:last-child {
        justify-content: center !important;
      }
    }

    /* ============= Desktop default - hide mobile, show desktop ============= */
    .admin-mobile-view {
      display: none;
    }
    .admin-desktop-view {
      display: block;
    }
    
    /* ============= MOBILE RESPONSIVE - 768px ============= */
    @media (max-width: 768px) {
      /* Base */
      body {
        font-size: 16px;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
      }

      /* Mobile Header */
      .mobile-greeting {
        display: flex;
        height: 56px;
        right: 0;
        padding-right: 16px;
      }

      .mobile-info-banner {
        display: none;
      }

      .mobile-menu-btn {
        display: inline-flex;
      }
      
      /* ===== הצגת לוגו במובייל ===== */
      .mobile-greeting .mobile-logo {
        display: block !important;
      }
      
      /* Sidebar Mobile - מוסתר לגמרי */
      .sidebar {
        position: fixed;
        right: -280px;
        width: 280px;
        max-width: 85vw;
        height: 100vh;
        max-height: 100vh;
        overflow-y: auto;
        overflow-x: hidden;
        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 150;
        box-shadow: -8px 0 30px rgba(0,0,0,0.15);
        -webkit-overflow-scrolling: touch;
      }

      .sidebar.open {
        right: 0;
      }
      
      .sidebar-header {
        padding: 20px 16px;
      }
      
      .sidebar-user {
        padding: 16px;
      }
      
      .user-avatar {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }
      
      .user-info h3 {
        font-size: 16px;
      }
      
      .user-info p {
        font-size: 13px;
      }

      .sidebar-nav .nav-item {
        padding: 16px 18px;
        font-size: 16px;
        min-height: 54px;
        border-radius: 12px;
        margin-bottom: 4px;
      }

      .sidebar-nav .nav-item i {
        font-size: 20px;
        width: 24px;
        margin-left: 12px;
      }
      
      .sidebar-footer {
        padding: 16px;
      }
      
      .btn-logout {
        padding: 14px;
        font-size: 15px;
        border-radius: 10px;
        min-height: 48px;
        width: auto;
        margin: 0 auto;
      }

      /* Main Content */
      .main-content {
        margin-right: 0;
        padding: 84px 12px 100px 12px;
      }

      .page-header {
        margin-bottom: 16px;
      }

      .page-header h1 {
        font-size: 22px;
        line-height: 1.3;
      }

      .page-header p {
        font-size: 14px;
      }

      /* Stats Cards */
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .stat-card {
        padding: 14px 12px;
        border-radius: 12px;
      }

      .stat-card-value {
        font-size: 20px;
      }

      .stat-card-title {
        font-size: 11px;
      }
      
      .stat-card-label {
        font-size: 10px;
      }

      .stat-card-icon {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }

      /* Content Cards */
      .content-card {
        border-radius: 12px;
        margin-bottom: 12px;
      }

      .card-header {
        padding: 14px;
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .card-header h2,
      .card-title {
        font-size: 16px;
      }

      .card-body {
        padding: 12px;
      }

      /* Forms */
      .form-grid {
        grid-template-columns: 1fr;
        padding: 14px;
        gap: 14px;
      }

      .form-field {
        margin-bottom: 0;
      }

      .form-field label {
        font-size: 14px;
        margin-bottom: 8px;
        font-weight: 600;
        display: block;
      }

      .form-field input,
      .form-field select,
      .form-field textarea {
        width: 100%;
        max-width: 100%;
        padding: 14px 16px;
        font-size: 16px;
        min-height: 52px;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
      }
      
      .form-field input:focus,
      .form-field select:focus,
      .form-field textarea:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59,130,246,0.15);
      }
      
      .form-field textarea {
        min-height: 100px;
      }

      .form-field select {
        -webkit-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: left 16px center;
        padding-left: 40px;
      }
      
      /* Time Picker Mobile */
      .time-picker-row {
        width: 100%;
        max-width: 100%;
        justify-content: center;
        gap: 8px;
      }
      
      .time-picker-row select {
        width: 80px;
        min-width: 80px;
        max-width: 80px;
        min-height: 52px;
        font-size: 18px;
        padding: 12px 10px;
        border-radius: 12px;
        border: 2px solid #cbd5e1;
      }
      
      .time-picker-row .time-separator {
        font-size: 26px;
        width: 20px;
      }

      /* Buttons */
      .btn {
        padding: 14px 18px;
        font-size: 15px;
        width: auto;
        min-width: 140px;
        min-height: 48px;
        border-radius: 12px;
        font-weight: 600;
      }

      .btn-back {
        min-height: 48px;
        font-size: 15px;
        padding: 12px 16px;
      }

      .form-actions {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
      }
      
      /* Dashboard buttons */
      #dashboardPage .btn {
        width: auto !important;
        max-width: none !important;
      }
      
      #dashboardPage > div[style*="display: flex"][style*="gap"] {
        flex-direction: column !important;
      }

      /* Tables - Scrollable */
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
        border-radius: 8px;
      }

      table th,
      table td {
        padding: 10px 8px;
        font-size: 12px;
      }
      
      table th {
        font-weight: 600;
        background: #f1f5f9;
      }
      
      /* Records Table Compact */
      #recordsPage table,
      #teamRecordsPage table {
        font-size: 11px;
      }
      
      #recordsPage table th,
      #recordsPage table td,
      #teamRecordsPage table th,
      #teamRecordsPage table td {
        padding: 8px 6px;
        min-width: 50px;
      }
      
      /* Admin/Payroll Tables - Compact for mobile */
      .admin-table {
        font-size: 10px !important;
        min-width: 600px !important;
      }
      
      .admin-table th,
      .admin-table td {
        padding: 8px 4px !important;
        white-space: nowrap;
      }
      
      #payrollDashboard .card-header,
      #adminControllerDashboard .card-header {
        flex-direction: column !important;
        gap: 12px !important;
        align-items: stretch !important;
      }
      
      #payrollDashboard .card-header .btn,
      #adminControllerDashboard .card-header .btn {
        width: auto !important;
        justify-content: center;
      }
      
      #recordsPage .page-header,
      #teamRecordsPage .page-header {
        padding: 8px 0;
      }
      
      #recordsPage .card-header,
      #teamRecordsPage .card-header {
        flex-direction: column;
        gap: 10px;
        padding: 12px;
      }
      
      #recordsPage .card-header .btn,
      #teamRecordsPage .card-header .btn {
        font-size: 14px;
        padding: 10px 14px;
        min-height: 44px;
        width: auto;
      }

      .records-summary-card,
      .team-summary-card {
        border-radius: 12px;
        padding: 12px;
      }

      /* Modal */
      .modal {
        padding: 8px;
        align-items: flex-start;
        overflow-y: auto;
      }
      
      .modal-content {
        padding: 16px;
        margin: 8px auto;
        max-height: none;
        border-radius: 16px;
        width: 100%;
        max-width: 100%;
      }
      
      .modal-header {
        margin-bottom: 16px;
        padding-bottom: 12px;
      }

      .modal-header h3 {
        font-size: 18px;
      }
      
      .close-btn {
        width: 40px;
        height: 40px;
        font-size: 22px;
      }
      
      .modal-footer {
        margin-top: 16px;
        padding-top: 16px;
        flex-direction: column;
        gap: 10px;
      }
      
      .modal-footer .btn {
        width: auto;
      }
      
      /* Edit Modal specific */
      #editModal .form-grid {
        grid-template-columns: 1fr;
      }

      /* Floating Submit Button */
      .mobile-floating-submit {
        display: block;
        position: fixed;
        bottom: 80px;
        left: 12px;
        right: 12px;
        z-index: 180;
        padding: 10px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 -4px 24px rgba(0,0,0,0.18);
      }
      
      .mobile-floating-submit .btn {
        margin: 0 auto;
        width: auto;
        min-width: 180px;
      }

      /* Alert */
      .alert {
        font-size: 14px;
        padding: 14px 16px;
        left: 12px;
        right: 12px;
        top: 72px;
        transform: translateY(-100px);
        width: auto;
        border-radius: 12px;
      }
      
      .alert.show {
        transform: translateY(0);
      }
      
      /* Login Card Mobile */
      .login-card {
        padding: 28px 24px;
        margin: 12px;
        border-radius: 20px;
      }
      
      .login-card h1 {
        font-size: 28px !important;
      }
      
      .login-logo {
        max-width: 70px !important;
      }
      
      .login-card .form-group input {
        padding: 16px;
        font-size: 16px;
        min-height: 54px;
        border-radius: 12px;
      }
      
      .btn-login {
        padding: 16px;
        font-size: 17px;
        min-height: 56px;
        border-radius: 12px;
        width: auto;
        min-width: 180px;
        margin: 0 auto;
      }
      
      /* Reports Page filters */
      #reportsPage .card-header {
        padding: 12px;
      }
      
      #reportsPage .form-group {
        min-width: 100% !important;
        width: 100% !important;
      }
      
      /* ===== הקטנת תיבות select בדוחות ===== */
      #reportsPage select {
        width: 100%;
        min-height: 38px !important;
        font-size: 13px !important;
        padding: 8px 10px !important;
      }
      
      /* Admin Dashboard filters */
      #adminDashboardFilters {
        flex-direction: column !important;
        align-items: stretch !important;
      }
      
      #adminDashboardFilters > div {
        width: 100% !important;
        flex-direction: column !important;
      }
      
      #adminDashboardFilters select {
        width: 100% !important;
        min-height: 48px;
      }
      
      #adminDashboardFilters button {
        width: auto !important;
        min-width: 120px;
        min-height: 48px;
        margin: 0 auto;
      }
      
      /* File upload */
      .file-upload-container {
        padding: 24px 16px;
      }
      
      .file-item {
        padding: 12px;
      }
      
      .file-item-name {
        font-size: 14px;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .file-item-remove {
        width: 32px;
        height: 32px;
        min-width: 32px;
      }
    }

    /* Mobile Bottom Navigation */
    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
      z-index: 200;
      padding: 8px 0;
      padding-bottom: env(safe-area-inset-bottom, 8px);
      border-top: 1px solid #e2e8f0;
    }

    .mobile-bottom-nav-inner {
      display: flex;
      justify-content: space-around;
      align-items: center;
      max-width: 500px;
      margin: 0 auto;
    }

    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 6px 4px;
      border: none;
      background: none;
      color: #64748b;
      font-size: 9px;
      font-family: inherit;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 48px;
      flex: 1;
      max-width: 70px;
      border-radius: 8px;
      -webkit-tap-highlight-color: transparent;
    }

    .mobile-nav-item i {
      font-size: 18px;
      transition: transform 0.2s ease;
    }

    .mobile-nav-item.active {
      color: #2563eb;
      background: rgba(37, 99, 235, 0.08);
    }
    
    .mobile-nav-item.active i {
      transform: scale(1.1);
    }

    .mobile-nav-item:active {
      background: rgba(37, 99, 235, 0.12);
      transform: scale(0.95);
    }

    @media (max-width: 768px) {
      /* ===== הסתרת סיידבר במובייל ===== */
      .sidebar {
        display: none !important;
      }
      
      /* ===== הצגת תפריט תחתון ===== */
      .mobile-bottom-nav {
        display: block;
      }
      
      /* ===== תצוגת אדמין למובייל ===== */
      .admin-desktop-view {
        display: none !important;
      }
      .admin-mobile-view {
        display: block !important;
      }
      #adminDashboardFilters {
        flex-direction: column;
        gap: 10px;
      }
      #adminDashboardFilters select {
        width: 100%;
      }
      
      /* ===== בורר חודש למדריכים במובייל ===== */
      #instructorMonthSelector,
      #recordsMonthSelector {
        gap: 6px;
        padding: 0 10px;
      }
      #instructorMonthSelector select,
      #recordsMonthSelector select {
        padding: 6px 8px;
        font-size: 13px;
      }
      #instructorMonthSelector button,
      #recordsMonthSelector button {
        padding: 6px 10px;
        font-size: 14px;
      }

      /* ===== תיקון main-content ללא margin ===== */
      .main-content {
        margin-right: 0 !important;
        padding: 15px;
        padding-bottom: 90px;
        max-width: 100vw;
        overflow-x: hidden;
      }
      
      /* ===== תיקון page-header למובייל ===== */
      .page-header {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 10px !important;
      }
      
      .page-header > div {
        width: 100% !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 8px !important;
      }
      
      .page-header button {
        width: auto !important;
        min-width: 120px;
        max-width: none !important;
      }
      
      /* כפתורי אייקון נשארים קטנים במובייל */
      .page-header button.btn-icon {
        width: 48px !important;
        min-width: 48px !important;
        max-width: 48px !important;
        flex-shrink: 0 !important;
      }
      
      /* ===== הזזת הודעות למעלה כדי לא לכסות שם משתמש ===== */
      .alert {
        top: calc(56px + 44px + 12px) !important;
        font-size: 13px !important;
        padding: 10px 16px !important;
        z-index: 9999 !important;
      }
      
      /* ===== הקטנת כל תיבות ה-select במובייל ===== */
      select, .form-field select {
        min-height: 38px !important;
        font-size: 13px !important;
        padding: 8px 10px !important;
      }
      
      /* ===== תיקון form-groups בעמוד דוחות ===== */
      #reportsPage .form-group {
        min-width: 0 !important;
        width: 100% !important;
        flex: 1 1 auto !important;
      }
      
      #reportsPage .card-body > div {
        flex-direction: column !important;
      }
      
      /* ===== הקטנת כל ה-inputs במובייל ===== */
      input:not([type="checkbox"]):not([type="radio"]), 
      .form-field input:not([type="checkbox"]):not([type="radio"]) {
        min-height: 38px !important;
        font-size: 14px !important;
        padding: 8px 10px !important;
      }
      
      /* Hide start/end time columns on mobile - keep only total hours */
      #recordsPage table th:nth-child(2),
      #recordsPage table td:nth-child(2),
      #recordsPage table th:nth-child(3),
      #recordsPage table td:nth-child(3) {
        display: none;
      }
    }

    /* ============= SMALL MOBILE - 480px ============= */
    @media (max-width: 480px) {
      .main-content {
        padding: 78px 10px 95px 10px;
      }
      
      .mobile-greeting {
        font-size: 14px;
        height: 52px;
      }

      /* Stats single column */
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .stat-card {
        padding: 12px;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }

      .stat-card-header {
        flex-direction: row-reverse;
        gap: 12px;
      }
      
      .stat-card-value {
        font-size: 22px;
      }
      
      .stat-card-title {
        font-size: 12px;
      }
      
      .stat-card-icon {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }

      /* Login */
      .login-card {
        padding: 24px 20px;
        margin: 8px;
        border-radius: 16px;
      }

      .login-card h1 {
        font-size: 24px !important;
      }

      .login-card h2 {
        font-size: 20px;
      }

      .login-card p {
        font-size: 13px;
      }
      
      .login-logo {
        max-width: 60px !important;
      }

      .form-group input,
      .login-card .form-group input {
        padding: 14px;
        font-size: 16px;
        min-height: 52px;
      }

      .btn-login {
        padding: 16px;
        font-size: 16px;
        min-height: 52px;
      }
      
      /* Page header */
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 12px;
      }

      .page-header h1 {
        font-size: 18px;
        line-height: 1.3;
      }
      
      .page-header p {
        font-size: 13px;
      }
      
      .page-header > div:last-child {
        width: 100%;
        justify-content: flex-start;
      }

      /* Forms */
      .form-grid {
        padding: 10px;
        gap: 12px;
      }
      
      .form-field label {
        font-size: 13px;
        margin-bottom: 6px;
      }
      
      .form-field input,
      .form-field select,
      .form-field textarea {
        padding: 12px 14px;
        font-size: 16px;
        min-height: 50px;
      }

      .card-header,
      .card-body {
        padding: 12px;
      }
      
      .card-header h2 {
        font-size: 15px;
      }
      
      /* Time picker smaller */
      .time-picker-row select {
        width: 70px;
        min-width: 70px;
        max-width: 70px;
        min-height: 48px;
        font-size: 16px;
        padding: 10px 8px;
      }
      
      .time-picker-row .time-separator {
        font-size: 22px;
        width: 16px;
      }

      /* Mobile Table Scroll */
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        font-size: 11px;
        -webkit-overflow-scrolling: touch;
      }
      
      table th, table td {
        padding: 6px 5px;
        min-width: 45px;
      }
      
      table th:first-child, table td:first-child {
        position: sticky;
        right: 0;
        background: #f8fafc;
        z-index: 2;
        box-shadow: -2px 0 4px rgba(0,0,0,0.1);
      }
      
      /* Mobile buttons - הקטנה משמעותית */
      .btn {
        padding: 8px 12px !important;
        font-size: 12px !important;
        min-height: 38px !important;
      }
      
      .btn-back {
        font-size: 12px !important;
        padding: 7px 10px !important;
        min-height: 36px !important;
      }
      
      /* ===== הקטנת כפתורים בעמוד צוות ===== */
      #teamRecordsPage .btn,
      #teamPage .btn,
      #managementPage .btn {
        padding: 6px 10px !important;
        font-size: 11px !important;
        min-height: 34px !important;
      }
      
      /* Modal small mobile */
      .modal {
        padding: 4px;
      }
      
      .modal-content {
        padding: 14px;
        margin: 4px;
        border-radius: 14px;
      }
      
      .modal-header h3 {
        font-size: 16px;
      }
      
      .close-btn {
        width: 36px;
        height: 36px;
        font-size: 20px;
      }
      
      /* Floating submit */
      .mobile-floating-submit {
        bottom: 75px;
        left: 8px;
        right: 8px;
        padding: 8px;
        border-radius: 14px;
      }
      
      /* Alert */
      .alert {
        font-size: 13px;
        padding: 12px 14px;
        left: 8px;
        right: 8px;
      }
      
      /* Mobile bottom nav */
      .mobile-bottom-nav {
        padding: 6px 0;
      }
      
      .mobile-nav-item {
        padding: 6px 10px;
        font-size: 10px;
        min-width: 56px;
      }
      
      .mobile-nav-item i {
        font-size: 18px;
      }
    }

    /* File Upload Styles */
    .file-upload-container {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      background: #f8fafc;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .file-upload-container:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    
    .file-upload-container.dragover {
      border-color: #3b82f6;
      background: #dbeafe;
    }
    
    .file-list {
      margin-top: 10px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-top: 8px;
    }
    
    .file-item-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .file-item-remove {
      background: #fee2e2;
      color: #dc2626;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Edit Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e2e8f0;
    }

    .modal-header h3 {
      margin: 0;
      color: #1e293b;
      font-size: 22px;
    }

    .close-btn {
      background: #fee2e2;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      color: #dc2626;
      font-size: 20px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: #fecaca;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 2px solid #e2e8f0;
    }

    .required-label::after {
      content: ' *';
      color: #dc2626;
      font-weight: bold;
    }

    #recordsPage table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      direction: rtl;
    }

    #recordsPage table th,
    #recordsPage table td {
      text-align: right;
      vertical-align: middle;
    }

    #recordsPage table th:nth-child(2),
    #recordsPage table td:nth-child(2),
    #recordsPage table th:nth-child(3),
    #recordsPage table td:nth-child(3),
    #recordsPage table th:nth-child(4),
    #recordsPage table td:nth-child(4),
    #recordsPage table th:nth-child(8),
    #recordsPage table td:nth-child(8),
    #recordsPage table th:last-child,
    #recordsPage table td:last-child {
      text-align: center;
    }

    .records-summary-list,
    .team-summary-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .records-summary-card,
    .team-summary-card {
      background: white;
      border: 1px solid #e2e8f0;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      border-radius: 14px;
      padding: 14px;
    }

    .records-summary-card h4,
    .team-summary-card h4 {
      font-size: 15px;
      margin-bottom: 8px;
      color: #1e40af;
    }

    .records-summary-row,
    .team-summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #475569;
      padding: 4px 0;
      gap: 12px;
    }

    .mobile-report-summary {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      color: #475569;
      text-align: center;
      font-size: 14px;
    }
</style>
</head>
<body>
<!-- =============== Login Screen =============== -->
<div id="loginScreen">
  <div class="login-card">
    <img src="./logo.png" alt="תעשיידע" style="max-width: 80px; margin-bottom: 15px;">
    <h1 style="font-size: 32px; font-weight: 800; color: #1e293b; margin: 0 0 5px 0; letter-spacing: -0.5px;">תעשיידע</h1>
    <p style="font-size: 16px; color: #64748b; margin: 0 0 20px 0;">מערכת נוכחות</p>
    
    <form onsubmit="return doLogin(event);" id="loginForm">
      <div class="form-group">
        <label for="loginEmpNum">מספר עובד</label>
        <input type="text" id="loginEmpNum" placeholder="הזן מספר עובד" required>
      </div>
      
      <div class="form-group">
        <label for="empCode">קוד אישי</label>
        <input type="password" id="empCode" placeholder="הזן קוד אישי" required>
      </div>
      
      <button type="submit" class="btn-login" id="loginBtn">
        <i class="fas fa-sign-in-alt"></i>
        כניסה למערכת
      </button>
    </form>
    
    <div class="login-error" id="loginError">
      <i class="fas fa-exclamation-circle"></i>
      <span>מספר עובד או קוד שגויים</span>
    </div>
  </div>
</div>

<!-- =============== Main App =============== -->
<div id="mainApp" class="hidden">
  
  <!-- Mobile Header with Greeting -->
  <div class="mobile-greeting" id="mobileGreeting">
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="תפריט">
      <i class="fas fa-bars"></i>
    </button>
    <div class="mobile-greeting-content">
      <img src="./logo.png" alt="לוגו" class="mobile-logo">
      <span id="mobileUserGreeting">שלום</span>
    </div>
  </div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="./logo.png" alt="תעשיידע" style="max-width: 50px; margin-bottom: 8px;">
      <h2 style="font-size: 18px; font-weight: 700; color: #1e293b; margin: 0;">תעשיידע</h2>
      <span style="font-size: 12px; color: #64748b;">מערכת נוכחות</span>
    </div>
    
    <div class="sidebar-user">
      <div class="user-avatar" id="userAvatar">ע</div>
      <div class="user-info">
        <h3 id="userName">עידן נחום</h3>
        <p id="userRole">מנהל מערכת</p>
      </div>
    </div>
    
    <nav class="sidebar-nav" id="sidebarNav">
      <a href="#" class="nav-item active" onclick="showPage(event, 'dashboard')" data-roles="all">
        <i class="fas fa-chart-line"></i>
        <span>לוח בקרה</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'add-record')" data-roles="instructor">
        <i class="fas fa-plus-circle"></i>
        <span>הוספת רשומה</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'records')" data-roles="instructor">
        <i class="fas fa-list"></i>
        <span>הרשומות שלי</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'reports')" data-roles="manager,operations_controller,system_admin,payroll_officer">
        <i class="fas fa-file-alt"></i>
        <span>דוחות</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'admin')" data-roles="system_admin">
        <i class="fas fa-cog"></i>
        <span>הגדרות מערכת</span>
      </a>
    </nav>
    
    <div class="sidebar-footer">
      <button class="btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        יציאה מהמערכת
      </button>
    </div>
  </div>
  
  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-bottom-nav" id="mobileBottomNav">
    <div class="mobile-bottom-nav-inner">
      <button class="mobile-nav-item active" onclick="mobileNavTo('dashboard')" id="mobileNavDashboard" data-roles="all">
        <i class="fas fa-home"></i>
        <span>ראשי</span>
      </button>
      <button class="mobile-nav-item" onclick="mobileNavTo('add-record')" id="mobileNavAdd" data-roles="instructor">
        <i class="fas fa-plus-circle"></i>
        <span>הוספה</span>
      </button>
      <button class="mobile-nav-item" onclick="mobileNavTo('records')" id="mobileNavRecords" data-roles="instructor">
        <i class="fas fa-list"></i>
        <span>רשומות</span>
      </button>
      <button class="mobile-nav-item" onclick="mobileNavTo('reports')" id="mobileNavReports" data-roles="manager,operations_controller,system_admin,payroll_officer">
        <i class="fas fa-chart-bar"></i>
        <span>דוחות</span>
      </button>
      <button class="mobile-nav-item" onclick="mobileNavTo('admin')" id="mobileNavAdmin" data-roles="system_admin">
        <i class="fas fa-cog"></i>
        <span>ניהול</span>
      </button>
      <button class="mobile-nav-item" onclick="logout()" style="color: #dc2626;" data-roles="all">
        <i class="fas fa-sign-out-alt"></i>
        <span>יציאה</span>
      </button>
    </div>
  </nav>
  
  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Alert -->
    <div class="alert" id="alertBox">
      <i class="fas fa-check-circle"></i>
      <span id="alertText"></span>
    </div>

    
    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page">
      <div class="page-header">
        <h1>לוח בקרה</h1>
        <p id="dashboardMonthLabel">סקירה כללית</p>
      </div>
      
      <!-- Payroll Officer Dashboard -->
      <div id="payrollDashboard" style="display: none;">
        <div class="content-card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <h2 class="card-title"><i class="fas fa-users" style="margin-left: 8px; color: #3b82f6;"></i>סיכום לפי מדריך</h2>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
              <select id="payrollMonth" onchange="loadPayrollSummary()" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px;">
                <option value="1">ינואר</option>
                <option value="2">פברואר</option>
                <option value="3">מרץ</option>
                <option value="4">אפריל</option>
                <option value="5">מאי</option>
                <option value="6">יוני</option>
                <option value="7">יולי</option>
                <option value="8">אוגוסט</option>
                <option value="9">ספטמבר</option>
                <option value="10">אוקטובר</option>
                <option value="11">נובמבר</option>
                <option value="12">דצמבר</option>
              </select>
              <select id="payrollYear" onchange="loadPayrollSummary()" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px;">
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
              </select>
              <button class="btn btn-success hide-mobile" onclick="exportPayrollToExcel()">
                <i class="fas fa-file-excel"></i>
                ייצוא ל-Excel
              </button>
            </div>
          </div>
          <div class="card-body" style="overflow-x: auto;">
            <table id="payrollSummaryTable" class="admin-table" style="width: 100%;">
              <thead>
                <tr>
                  <th style="text-align: right; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">שם המדריך</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">צוות</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ שעות קורס</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ שעות הכשרה</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ שעות ביטול</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">קילומטר-סה"כ</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ הוצאות</th>
                </tr>
              </thead>
              <tbody id="payrollSummaryTableBody">
                <!-- יתמלא ע"י JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Admin/Controller Dashboard (All Employees Summary) -->
      <div id="adminControllerDashboard" style="display: none;">
        <!-- Monthly Approvals Status Card (moved from teamRecordsPage) -->
        <div class="content-card" id="dashboardApprovalsCard" style="margin-bottom: 20px;">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <h2 class="card-title"><i class="fas fa-user-check" style="margin-left: 8px; color: #3b82f6;"></i>סטטוס אישורי חודש</h2>
            <button class="btn btn-primary" onclick="loadApprovalsStatusPage()">
              <i class="fas fa-sync-alt"></i>
              רענן סטטוס
            </button>
          </div>
          <div class="card-body">
            <div id="dashboardApprovalsContent">
              <p style="text-align: center; color: #94a3b8; padding: 30px;">טוען סטטוס אישורים...</p>
            </div>
          </div>
        </div>

        <div class="content-card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <h2 class="card-title"><i class="fas fa-users-cog" style="margin-left: 8px; color: #3b82f6;"></i>סיכום כל העובדים - חודש נוכחי</h2>
            <button class="btn btn-success hide-mobile" onclick="exportAdminDashboardToExcel()">
              <i class="fas fa-file-excel"></i>
              ייצוא ל-Excel
            </button>
          </div>
          
          <!-- Filters (Admin and Payroll only) -->
          <div id="adminDashboardFilters" class="card-body" style="background: #f8fafc; padding: 15px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-weight: 500; color: #475569; font-size: 14px;">סינון:</label>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <select id="dashboardMonth" onchange="loadAdminDashboard()" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px;">
                <option value="1">ינואר</option>
                <option value="2">פברואר</option>
                <option value="3">מרץ</option>
                <option value="4">אפריל</option>
                <option value="5">מאי</option>
                <option value="6">יוני</option>
                <option value="7">יולי</option>
                <option value="8">אוגוסט</option>
                <option value="9">ספטמבר</option>
                <option value="10">אוקטובר</option>
                <option value="11">נובמבר</option>
                <option value="12">דצמבר</option>
              </select>
              <select id="dashboardYear" onchange="loadAdminDashboard()" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px;">
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
              </select>
              <select id="filterEmploymentType" onchange="updateAdminDashboard()" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px;">
                <option value="all">כל סוגי ההעסקה</option>
                <option value="תעשיידע">תעשיידע</option>
                <option value="מעוף">מעוף</option>
                <option value="מנפאואר">מנפאואר</option>
                <option value="עצמאי">עצמאי</option>
              </select>
              <select id="filterTeam" onchange="updateAdminDashboard()" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px;">
                <option value="all">כל הצוותים</option>
                <option value="גיל">גיל</option>
                <option value="לינוי">לינוי</option>
              </select>
              <button onclick="clearAdminFilters()" style="padding: 8px 16px; background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer; font-size: 14px;">
                <i class="fas fa-redo"></i> אפס סינונים
              </button>
            </div>
          </div>

          <!-- Desktop Table -->
          <div class="card-body admin-desktop-view" style="overflow-x: auto;">
            <table id="adminDashboardTable" class="admin-table" style="width: 100%;">
              <thead>
                <tr>
                  <th style="width: 30px; text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;"></th>
                  <th style="text-align: right; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">מספר עובד</th>
                  <th style="text-align: right; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">שם עובד</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">צוות</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סוג העסקה</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ שעות</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ ק"מ</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ הוצאות</th>
                </tr>
              </thead>
              <tbody id="adminDashboardTableBody">
                <!-- יתמלא ע"י JavaScript -->
              </tbody>
            </table>
          </div>
          
          <!-- Mobile Cards View -->
          <div id="adminMobileCardsContainer" class="admin-mobile-view" style="padding: 15px;">
            <!-- יתמלא ע"י JavaScript -->
          </div>
        </div>
        
        <!-- Admin Approval Section (Mobile & Desktop) -->
        <div class="content-card" id="adminApprovalCard" style="margin-top: 20px;">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-check-double" style="margin-left: 8px; color: #10b981;"></i>אישור חודשי לצוות</h2>
          </div>
          <div class="card-body" style="display: flex; flex-wrap: wrap; gap: 12px; padding: 20px;">
            <button class="btn btn-approve" onclick="approveTeamMonth('גיל')">
              <i class="fas fa-check"></i>
              אשר צוות גיל
            </button>
            <button class="btn btn-info" onclick="approveTeamMonth('לינוי')">
              <i class="fas fa-check"></i>
              אשר צוות לינוי
            </button>
            <button class="btn btn-purple" onclick="approveTeamMonth('all')">
              <i class="fas fa-check-double"></i>
              אשר את כולם
            </button>
          </div>
        </div>
      </div>
      
      <!-- Regular Dashboard Content -->
      <div id="regularDashboardContent">
      
      <!-- Instructor Month Selection -->
      <div id="instructorMonthSelector" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
        <button onclick="changeInstructorMonth(-1)" style="padding: 8px 12px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer; font-size: 16px;">
          <i class="fas fa-chevron-right"></i>
        </button>
        <select id="instructorMonth" onchange="loadInstructorMonthData()" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px;">
          <option value="1">ינואר</option>
          <option value="2">פברואר</option>
          <option value="3">מרץ</option>
          <option value="4">אפריל</option>
          <option value="5">מאי</option>
          <option value="6">יוני</option>
          <option value="7">יולי</option>
          <option value="8">אוגוסט</option>
          <option value="9">ספטמבר</option>
          <option value="10">אוקטובר</option>
          <option value="11">נובמבר</option>
          <option value="12">דצמבר</option>
        </select>
        <select id="instructorYear" onchange="loadInstructorMonthData()" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px;">
          <option value="2025">2025</option>
          <option value="2026">2026</option>
          <option value="2027">2027</option>
        </select>
        <button onclick="changeInstructorMonth(1)" style="padding: 8px 12px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer; font-size: 16px;">
          <i class="fas fa-chevron-left"></i>
        </button>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card pastel-blue" onclick="showPage(event, 'records')" style="cursor: pointer; transition: transform 0.2s; background: linear-gradient(145deg, #e0f2fe 0%, #bae6fd 100%); border: 1px solid #7dd3fc;"
             onmouseover="this.style.transform='translateY(-5px)'"
             onmouseout="this.style.transform='translateY(0)'">
          <div class="stat-card-header">
            <span class="stat-card-title">הרשומות שלי</span>
            <div class="stat-card-icon">
              <i class="fas fa-calendar-check"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalRecordsStat">0</div>
          <div class="stat-card-label">תאריכים שונים בחודש</div>
        </div>
        
        <div class="stat-card purple">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ שעות</span>
            <div class="stat-card-icon">
              <i class="fas fa-clock"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalHoursStat">0</div>
          <div class="stat-card-label">שעות עבודה</div>
        </div>
        
        <div class="stat-card green">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ הוצאות</span>
            <div class="stat-card-icon">
              <i class="fas fa-shekel-sign"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalExpensesStat">0 ₪</div>
          <div class="stat-card-label">הוצאות והחזרים</div>
        </div>
        
        <div class="stat-card orange" onclick="showPage(event, 'records')" style="cursor: pointer; transition: transform 0.2s;"
             onmouseover="this.style.transform='translateY(-5px)'"
             onmouseout="this.style.transform='translateY(0)'">
          <div class="stat-card-header">
            <span class="stat-card-title">קילומטרים</span>
            <div class="stat-card-icon">
              <i class="fas fa-road"></i>
            </div>
          </div>
          <div class="stat-card-value" id="pendingRecordsStat">0</div>
          <div class="stat-card-label">סה"כ נסיעות</div>
        </div>
      </div>

      <!-- Monthly Approval Cards Container -->
      <div id="monthlyApprovalContainer" style="display: none; margin-top: 24px; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
        <!-- Current Month Card -->
        <div class="content-card" id="monthlyApprovalCard" style="margin: 0; padding: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h3 style="font-size: 14px; color: #1e293b; margin: 0;"><i class="fas fa-calendar-check" style="margin-left: 6px; color: #3b82f6;"></i>סיום דיווח חודשי (עד 2 בחודש)</h3>
            <span id="monthlyApprovalMonthLabel" style="color: #64748b; font-size: 12px;"></span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap;">
            <div id="monthlyApprovalStatus" style="color: #475569; font-size: 13px;">טוען...</div>
            <button class="btn btn-approve" id="monthlyApprovalBtn" onclick="approveMonthlyReport('current')" style="padding: 6px 12px; font-size: 12px;">
              <i class="fas fa-check-circle"></i>
              סיום דיווח
            </button>
          </div>
        </div>
        
        <!-- Previous Month Card (Grace Period) -->
        <div class="content-card" id="previousMonthApprovalCard" style="margin: 0; padding: 12px; display: none; border: 2px solid #f97316; background: linear-gradient(135deg, #fff7ed 0%, #ffffff 100%);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h3 style="font-size: 14px; color: #ea580c; margin: 0;"><i class="fas fa-exclamation-triangle" style="margin-left: 6px; color: #f97316;"></i>חודש קודם</h3>
            <span id="previousMonthApprovalMonthLabel" style="color: #ea580c; font-size: 12px; font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap;">
            <div id="previousMonthApprovalStatus" style="color: #c2410c; font-size: 13px;">
              <i class="fas fa-clock" style="margin-left: 4px;"></i>
              <span id="gracePeriodDaysLeft"></span>
            </div>
            <button class="btn btn-warning" id="previousMonthApprovalBtn" onclick="approveMonthlyReport('previous')" style="background: #f97316; border-color: #ea580c; padding: 6px 12px; font-size: 12px;">
              <i class="fas fa-check-circle"></i>
              אשר חודש
            </button>
          </div>
        </div>
      </div>
      
      <!-- כפתורי פעולות -->
      <div style="text-align: center; margin-top: 40px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <button id="dashboardAddRecordBtn" class="btn btn-primary" onclick="showPage(event, 'add-record')">
          <i class="fas fa-plus"></i>
          הוסף רשומה חדשה
        </button>
        <button class="btn btn-success hide-mobile" onclick="exportToExcel()">
          <i class="fas fa-file-excel"></i>
          ייצוא ל-Excel
        </button>
      </div>

      <!-- טבלת סיכום -->
      <div class="content-card" style="margin-top: 40px;">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-list-alt" style="margin-left: 8px; color: #3b82f6;"></i>סיכום פעילות</h2>
        </div>
        <div class="card-body">
          <table id="summaryTable">
            <thead>
              <tr>
                <th>סוג פעילות</th>
                <th>סה"כ שעות</th>
                <th>סה"כ קילומטר</th>
              </tr>
            </thead>
            <tbody id="summaryTableBody">
              <!-- יתמלא ע"י JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
      </div><!-- End regularDashboardContent -->
    </div>

    <!-- Add Record Page -->
    <div id="addRecordPage" class="page hidden">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 20px;">
          <h1 style="margin: 0; font-size: 24px;">הוספת רשומה חדשה</h1>
          <div id="formUserInfoHeader" style="display: flex; gap: 15px; background: #f1f5f9; padding: 6px 16px; border-radius: 10px; font-size: 14px; font-weight: 600; color: #475569; border: 1px solid #e2e8f0;">
            <span>מספר עובד: <span id="displayEmpNum"></span></span>
            <span>שם עובד: <span id="displayEmpName"></span></span>
          </div>
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-success btn-icon" onclick="addRecord()" title="הוסף רשומה">
            <i class="fas fa-check" style="font-size: 18px;"></i>
          </button>
          <button class="btn btn-secondary btn-icon" onclick="showPage(event, 'dashboard')" title="חזור ללוח בקרה">
            <i class="fas fa-arrow-right" style="font-size: 18px;"></i>
          </button>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
        
        <div class="content-card">
          <div class="card-header" style="padding: 12px 16px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
            <h3 class="card-title" style="font-size: 15px; color: #1e40af; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-clock"></i>
              זמנים
            </h3>
          </div>
          <div class="card-body" style="padding: 16px;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; align-items: end;">
              <!-- תאריך -->
              <div class="form-field" style="margin: 0;">
                <label for="recDate" style="display: block; margin-bottom: 6px;">תאריך <span style="color: #ef4444;">*</span></label>
                <input type="date" id="recDate" required style="width: 100%; max-width: 160px;">
              </div>
              <!-- סה"כ שעות -->
              <div class="form-field" style="margin: 0; text-align: center;">
                <label for="hoursField" style="display: block; margin-bottom: 6px;">סה"כ שעות</label>
                <div style="display: inline-flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 2px solid #cbd5e1; border-radius: 12px; padding: 8px 20px; min-width: 80px;">
                  <span id="hoursDisplay" style="font-size: 22px; font-weight: 700; color: #1e40af;">0:00</span>
                </div>
                <input type="hidden" id="hoursField" step="0.01" min="0" max="24" readonly>
              </div>
              <!-- שעת התחלה -->
              <div class="form-field" style="margin: 0;">
                <label style="display: block; margin-bottom: 6px;">שעת התחלה <span style="color: #ef4444;">*</span></label>
                <div class="time-picker-row">
                  <select id="startHour" onchange="updateTimeField('start'); calculateHours()" required>
                    <option value="">שעה</option>
                  </select>
                  <span class="time-separator">:</span>
                  <select id="startMinute" onchange="updateTimeField('start'); calculateHours()" required>
                    <option value="">דקות</option>
                  </select>
                  <input type="hidden" id="startTime">
                </div>
              </div>
              <!-- שעת סיום -->
              <div class="form-field" style="margin: 0;">
                <label style="display: block; margin-bottom: 6px;">שעת סיום <span style="color: #ef4444;">*</span></label>
                <div class="time-picker-row">
                  <select id="endHour" onchange="updateTimeField('end'); calculateHours()" required>
                    <option value="">שעה</option>
                  </select>
                  <span class="time-separator">:</span>
                  <select id="endMinute" onchange="updateTimeField('end'); calculateHours()" required>
                    <option value="">דקות</option>
                  </select>
                  <input type="hidden" id="endTime">
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="content-card">
          <div class="card-header" style="padding: 12px 16px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
            <h3 class="card-title" style="font-size: 15px; color: #166534; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-briefcase"></i>
              פרטי פעילות
            </h3>
          </div>
          <div class="card-body" style="padding: 16px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <div class="form-field">
                <label for="activityType">סוג פעילות <span style="color: #ef4444;">*</span></label>
                <select id="activityType" required style="max-width: 100%;">
                  <option value="">בחר</option>
                  <option value="ביטול זמן">ביטול זמן</option>
                  <option value="הכשרה">הכשרה</option>
                  <option value="סדנה">סדנה</option>
                  <option value="סיור">סיור</option>
                  <option value="קורס">קורס</option>
                  <option value="תפעול">תפעול</option>
                </select>
              </div>
              <div class="form-field">
                <label for="schoolField">בית ספר <span style="color: #ef4444;">*</span></label>
                <div class="searchable-dropdown" id="schoolDropdown">
                  <div class="searchable-dropdown-toggle" onclick="toggleSearchableDropdown('schoolDropdown')" tabindex="0">
                    <span id="schoolFieldDisplay">בחר בית ספר</span>
                    <i class="fas fa-chevron-down" style="color: #94a3b8;"></i>
                  </div>
                  <div class="searchable-dropdown-menu" id="schoolDropdownMenu">
                    <div class="searchable-dropdown-search">
                      <input type="text" id="schoolSearchInput" placeholder="🔍 חפש בית ספר..." oninput="filterSchoolDropdown(this.value)">
                    </div>
                    <div id="schoolDropdownOptions">
                      <!-- Options will be populated by JavaScript -->
                    </div>
                  </div>
                </div>
                <input type="hidden" id="schoolField" required>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <div class="form-field">
                <label for="municipality">רשות <span style="color: #ef4444;">*</span></label>
                <input type="text" id="municipality" readonly required style="background: #f1f5f9; max-width: 100%;">
              </div>
              <div class="form-field">
                <label for="programField">תוכנית <span style="color: #ef4444;">*</span></label>
                <select id="programField" required style="max-width: 100%;">
                  <option value="">בחר תוכנית</option>
                  <option value="השמיים אינם הגבול">השמיים אינם הגבול</option>
                  <option value="התנסות בתעשייה">התנסות בתעשייה</option>
                  <option value="ביומימיקרי">ביומימיקרי</option>
                  <option value="ביומימיקרי לחטיבות">ביומימיקרי לחטיבות</option>
                  <option value="בינה מלאכותית">בינה מלאכותית</option>
                  <option value="יישומי AI">יישומי AI</option>
                  <option value="מייקרים טכנו-כיף">מייקרים טכנו-כיף</option>
                  <option value="מנהיגות ירוקה">מנהיגות ירוקה</option>
                  <option value="מקורות">מקורות</option>
                  <option value="משחקי קופסה">משחקי קופסה</option>
                  <option value="פורצות דרך">פורצות דרך</option>
                  <option value="רוקחים עולם">רוקחים עולם</option>
                  <option value="טכנולוגיות החלל">טכנולוגיות החלל</option>
                  <option value="תמיר">תמיר</option>
                </select>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div class="form-field">
                <label for="sessionNum">מספר מפגש <span style="color: #ef4444;">*</span></label>
                <select id="sessionNum" required style="max-width: 120px;">
                  <option value="">בחר</option>
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                  <option value="13">13</option>
                  <option value="14">14</option>
                  <option value="15">15</option>
                  <option value="16">16</option>
                </select>
              </div>
              <div class="form-field">
                <label for="kmField">קילומטר</label>
                <input type="number" id="kmField" step="0.1" min="0" placeholder="הלוך חזור" style="max-width: 120px;">
              </div>
            </div>
          </div>
        </div>
        
        <div class="content-card">
          <div class="card-header" style="padding: 12px 16px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
            <h3 class="card-title" style="font-size: 15px; color: #92400e; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-receipt"></i>
              הוצאות
            </h3>
          </div>
          <div class="card-body" style="padding: 16px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <div class="form-field">
                <label for="totalExpenses">סה"כ הוצאות (₪)</label>
                <input type="number" id="totalExpenses" step="0.01" min="0" placeholder="0.00" style="max-width: 120px;">
              </div>
              <div class="form-field">
                <label for="expensesDetail">פירוט הוצאות</label>
                <input type="text" id="expensesDetail" placeholder="פרט את ההוצאות" style="max-width: 100%;">
              </div>
            </div>
            <div class="form-field">
              <label for="attachments">צרף מסמכים/תמונות</label>
              <div class="file-upload-container" onclick="document.getElementById('attachments').click()" id="fileDropZone" style="padding: 12px;">
                <i class="fas fa-cloud-upload-alt" style="font-size: 24px; color: #3b82f6; margin-bottom: 6px;"></i>
                <p style="margin: 0; color: #64748b; font-size: 13px;">לחץ או גרור קבצים לכאן</p>
                <small style="color: #94a3b8; font-size: 11px;">תמונות, PDF, Word - עד 5MB לקובץ</small>
              </div>
              <input type="file" id="attachments" multiple accept="image/*,.pdf,.doc,.docx,.xlsx" style="display: none;" onchange="handleFileSelect(event)">
              <div id="fileList" class="file-list"></div>
            </div>
          </div>
        </div>
        
        <div class="content-card">
          <div class="card-header" style="padding: 12px 16px; background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);">
            <h3 class="card-title" style="font-size: 15px; color: #6b21a8; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-sticky-note"></i>
              הערות
            </h3>
          </div>
          <div class="card-body" style="padding: 16px;">
            <div class="form-field">
              <label for="notesField">הערות נוספות</label>
              <textarea id="notesField" rows="4" style="height: 100px; max-width: 100%;"></textarea>
            </div>
          </div>
        </div>
        
      </div>
      
      <!-- Mobile Floating Submit Button -->
      <div class="mobile-floating-submit">
        <button class="btn btn-success" onclick="addRecord()">
          <i class="fas fa-check"></i>
          שלח רשומה
        </button>
      </div>
    </div>

    <!-- Records Page -->
    <div id="recordsPage" class="page hidden">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>הרשומות שלי</h1>
          <p>צפייה ברשומות לפי שבוע</p>
        </div>
        <button class="btn btn-secondary btn-icon" onclick="showPage(event, 'dashboard')" title="חזור ללוח בקרה">
          <i class="fas fa-arrow-right" style="font-size: 18px;"></i>
        </button>
      </div>
      
      <div class="content-card">
        <div class="card-header" style="flex-direction: column; gap: 15px;">
          <!-- Month Navigation for Records -->
          <div id="recordsMonthSelector" style="display: flex; justify-content: center; gap: 10px; width: 100%; flex-wrap: wrap; align-items: center;">
            <button onclick="changeRecordsMonth(-1)" style="padding: 8px 12px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer; font-size: 16px;">
              <i class="fas fa-chevron-right"></i>
            </button>
            <select id="recordsMonth" onchange="loadRecordsForMonth()" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px;">
              <option value="1">ינואר</option>
              <option value="2">פברואר</option>
              <option value="3">מרץ</option>
              <option value="4">אפריל</option>
              <option value="5">מאי</option>
              <option value="6">יוני</option>
              <option value="7">יולי</option>
              <option value="8">אוגוסט</option>
              <option value="9">ספטמבר</option>
              <option value="10">אוקטובר</option>
              <option value="11">נובמבר</option>
              <option value="12">דצמבר</option>
            </select>
            <select id="recordsYear" onchange="loadRecordsForMonth()" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px;">
              <option value="2025">2025</option>
              <option value="2026">2026</option>
              <option value="2027">2027</option>
            </select>
            <button onclick="changeRecordsMonth(1)" style="padding: 8px 12px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer; font-size: 16px;">
              <i class="fas fa-chevron-left"></i>
            </button>
          </div>
          
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <h2 class="card-title">סה"כ <span id="totalRecordsCount">0</span> ימי עבודה</h2>
            <div style="display: flex; gap: 10px;">
            <button class="btn btn-success hide-mobile" onclick="exportToExcel()">
              <i class="fas fa-file-excel"></i>
              ייצוא ל-Excel
            </button>
            <button class="btn btn-primary" onclick="syncFromSharePoint(JSON.parse(localStorage.getItem('currentUser') || '{}').empNum)">
              <i class="fas fa-sync"></i>
              רענן נתונים
            </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="recordsTable">
            <p style="text-align: center; color: #94a3b8; padding: 40px;">אין ימי עבודה להצגה</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Team Records Page (for manager, operations_controller, system_admin, payroll_officer) -->
    <div id="teamRecordsPage" class="page hidden">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>סיכום נוכחות</h1>
          <p id="teamRecordsSubtitle">סיכום לפי עובד - לחץ על שם לפירוט</p>
        </div>
        <button class="btn btn-secondary btn-icon" onclick="showPage(event, 'dashboard')" title="חזור ללוח בקרה">
          <i class="fas fa-arrow-right" style="font-size: 18px;"></i>
        </button>
      </div>

      <!-- Monthly Approvals Status (Manager/System Admin) -->
      <div class="content-card" id="monthlyApprovalsCard" style="margin-bottom: 20px; display: none;">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
          <h2 class="card-title"><i class="fas fa-user-check" style="margin-left: 8px; color: #3b82f6;"></i>סטטוס אישורי חודש</h2>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="loadMonthlyApprovalsTable()">
              <i class="fas fa-sync-alt"></i>
              רענן סטטוס
            </button>
            <button class="btn btn-success" id="approveToPayrollBtn" onclick="approveMonthToPayroll()" style="display: none;">
              <i class="fas fa-check-double"></i>
              אישור נוכחות חודשית
            </button>
            <button class="btn btn-warning" id="resetMonthBtn" onclick="resetTeamMonth()" style="display: none;">
              <i class="fas fa-unlock"></i>
              איפוס חודש
            </button>
            <button class="btn btn-danger" id="unlockMonthBtn" onclick="unlockTeamMonth()" style="display: none;">
              <i class="fas fa-lock-open"></i>
              פתיחת חודש
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="monthlyApprovalsTable">
            <p style="text-align: center; color: #94a3b8; padding: 30px;">טוען סטטוס אישורים...</p>
          </div>
        </div>
      </div>

      <div class="content-card">
        <div class="card-header" style="flex-direction: column; gap: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 10px;">
            <h2 class="card-title">סיכום צוות <span id="teamName"></span></h2>
            <button class="btn btn-success hide-mobile" onclick="exportTeamToExcel()">
              <i class="fas fa-file-excel"></i>
              ייצוא ל-Excel
            </button>
          </div>
          <!-- Month/Year/Team Filter -->
          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; background: #f8fafc; padding: 12px; border-radius: 8px; width: 100%;">
            <label style="font-weight: 500; color: #475569;">תקופה:</label>
            <select id="teamMonthFilter" onchange="loadTeamRecords()" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; background: white;">
              <option value="1">ינואר</option>
              <option value="2">פברואר</option>
              <option value="3">מרץ</option>
              <option value="4">אפריל</option>
              <option value="5">מאי</option>
              <option value="6">יוני</option>
              <option value="7">יולי</option>
              <option value="8">אוגוסט</option>
              <option value="9">ספטמבר</option>
              <option value="10">אוקטובר</option>
              <option value="11">נובמבר</option>
              <option value="12">דצמבר</option>
            </select>
            <select id="teamYearFilter" onchange="loadTeamRecords()" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; background: white;">
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
            </select>
            <select id="teamRecordsTeamFilter" onchange="loadTeamRecords()" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; display: none;">
              <option value="all">כל הצוותים</option>
              <option value="גיל">גיל</option>
              <option value="לינוי">לינוי</option>
            </select>
            <button class="btn btn-primary" onclick="loadTeamRecords()">
              <i class="fas fa-sync-alt"></i>
              רענן
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="teamRecordsTable">
            <p style="text-align: center; color: #94a3b8; padding: 40px;">בחר חודש ושנה לצפייה בסיכום</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Page (for manager, operations_controller, system_admin) -->
    <div id="reportsPage" class="page hidden">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <div>
          <h1>דוחות</h1>
          <p>סיכומים וסטטיסטיקות</p>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn btn-success hide-mobile" onclick="openExportModal()">
            <i class="fas fa-file-excel"></i>
            ייצוא ל-Excel
          </button>
          <button class="btn btn-secondary btn-icon" onclick="showPage(event, 'dashboard')" title="חזור ללוח בקרה">
            <i class="fas fa-arrow-right" style="font-size: 18px;"></i>
          </button>
        </div>
      </div>
      
      <!-- Filters Section -->
      <div class="content-card" style="margin-bottom: 20px;">
        <div class="card-body" style="padding: 15px;">
          <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <div class="form-group" style="margin: 0; min-width: 120px;">
              <label style="font-size: 12px; margin-bottom: 4px;">חודש</label>
              <select id="reportMonth" class="form-input" onchange="loadReportData()" style="padding: 8px;">
                <option value="1">ינואר</option>
                <option value="2">פברואר</option>
                <option value="3">מרץ</option>
                <option value="4">אפריל</option>
                <option value="5">מאי</option>
                <option value="6">יוני</option>
                <option value="7">יולי</option>
                <option value="8">אוגוסט</option>
                <option value="9">ספטמבר</option>
                <option value="10">אוקטובר</option>
                <option value="11">נובמבר</option>
                <option value="12">דצמבר</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0; min-width: 100px;">
              <label style="font-size: 12px; margin-bottom: 4px;">שנה</label>
              <select id="reportYear" class="form-input" onchange="loadReportData()" style="padding: 8px;">
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0; min-width: 120px;">
              <label style="font-size: 12px; margin-bottom: 4px;">צוות</label>
              <select id="reportTeam" class="form-input" onchange="loadReportData()" style="padding: 8px;">
                <option value="all">הכל</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0; min-width: 140px;" id="employmentTypeFilterContainer">
              <label style="font-size: 12px; margin-bottom: 4px;">סוג העסקה</label>
              <select id="reportEmploymentType" class="form-input" onchange="loadReportData()" style="padding: 8px;">
                <option value="all">הכל</option>
                <option value="תעשיידע">תעשיידע</option>
                <option value="מעוף">מעוף</option>
                <option value="מנפאואר">מנפאואר</option>
                <option value="עצמאי">עצמאי</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0; min-width: 120px;">
              <label style="font-size: 12px; margin-bottom: 4px;">סוג פעילות</label>
              <select id="reportActivityType" class="form-input" onchange="loadReportData()" style="padding: 8px;">
                <option value="all">הכל</option>
                <option value="ביטול זמן">ביטול זמן</option>
                <option value="הכשרה">הכשרה</option>
                <option value="סדנה">סדנה</option>
                <option value="סיור">סיור</option>
                <option value="קורס">קורס</option>
                <option value="תפעול">תפעול</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="loadReportData()" style="margin-top: 18px;">
              <i class="fas fa-sync-alt"></i>
              רענן
            </button>
          </div>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card purple">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ שעות הצוות</span>
            <div class="stat-card-icon"><i class="fas fa-clock"></i></div>
          </div>
          <div class="stat-card-value" id="teamTotalHours">0</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ ק"מ</span>
            <div class="stat-card-icon"><i class="fas fa-road"></i></div>
          </div>
          <div class="stat-card-value" id="teamTotalKm">0</div>
        </div>
        <div class="stat-card green">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ הוצאות הצוות</span>
            <div class="stat-card-icon"><i class="fas fa-shekel-sign"></i></div>
          </div>
          <div class="stat-card-value" id="teamTotalExpenses">0 ₪</div>
        </div>
      </div>
      
      <div class="content-card" style="margin-top: 20px;">
        <div class="card-header">
          <h2 class="card-title">סיכום לפי עובד</h2>
        </div>
        <div class="card-body">
          <div id="reportsByEmployee">
            <p style="text-align: center; color: #94a3b8; padding: 40px;">טוען נתונים...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Page (for system_admin only) -->
    <div id="adminPage" class="page hidden">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>הגדרות מערכת</h1>
          <p>ניהול משתמשים והגדרות</p>
        </div>
        <button class="btn btn-secondary btn-icon" onclick="showPage(event, 'dashboard')" title="חזור ללוח בקרה">
          <i class="fas fa-arrow-right" style="font-size: 18px;"></i>
        </button>
      </div>
      
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">פעולות מנהל</h2>
        </div>
        <div class="card-body">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <button class="btn btn-primary" onclick="viewAllRecords()">
              <i class="fas fa-database"></i>
              צפייה בכל ימי העבודה
            </button>
            <button class="btn btn-success hide-mobile" onclick="exportAllToExcel()">
              <i class="fas fa-file-excel"></i>
              ייצוא כל הנתונים
            </button>
            <button class="btn btn-info" onclick="syncFromSharePoint()">
              <i class="fas fa-sync-alt"></i>
              סנכרון מ-SharePoint
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Approvals Status Page (Admin Only) -->
    <div id="approvalsStatusPage" class="page hidden">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>סטטוס אישורים</h1>
          <p>מעקב אחר אישורי מדריכים ומנהלים</p>
        </div>
        <button class="btn btn-secondary btn-icon" onclick="showPage(event, 'dashboard')" title="חזור ללוח בקרה">
          <i class="fas fa-arrow-right" style="font-size: 18px;"></i>
        </button>
      </div>
      
      <div class="content-card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
          <h2 class="card-title">סטטוס אישורים חודשי</h2>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="approvalsMonthFilter" onchange="loadApprovalsStatusPage()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
              <option value="1">ינואר</option>
              <option value="2">פברואר</option>
              <option value="3">מרץ</option>
              <option value="4">אפריל</option>
              <option value="5">מאי</option>
              <option value="6">יוני</option>
              <option value="7">יולי</option>
              <option value="8">אוגוסט</option>
              <option value="9">ספטמבר</option>
              <option value="10">אוקטובר</option>
              <option value="11">נובמבר</option>
              <option value="12">דצמבר</option>
            </select>
            <select id="approvalsYearFilter" onchange="loadApprovalsStatusPage()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
              <option value="2025">2025</option>
              <option value="2026" selected>2026</option>
              <option value="2027">2027</option>
            </select>
            <button class="btn btn-primary" onclick="loadApprovalsStatusPage()">
              <i class="fas fa-sync-alt"></i> רענן
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="approvalsStatusTable" style="overflow-x: auto;">
            <p style="text-align: center; color: #94a3b8; padding: 30px;">טוען נתונים...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>עריכת רשומה</h3>
          <button class="close-btn" onclick="closeEditModal()">×</button>
        </div>
        
        <div class="form-grid">
          <div class="form-field">
            <label for="editDate" class="required-label">תאריך</label>
            <input type="date" id="editDate" required>
          </div>
          <div class="form-field">
            <label class="required-label">שעת התחלה</label>
            <div class="time-picker-row">
              <select id="editStartHour" onchange="updateTimeField('editStart'); calculateEditHours()" required>
                <option value="">שעה</option>
              </select>
              <span class="time-separator">:</span>
              <select id="editStartMinute" onchange="updateTimeField('editStart'); calculateEditHours()" required>
                <option value="">דקות</option>
              </select>
              <input type="hidden" id="editStartTime">
            </div>
          </div>
          <div class="form-field">
            <label class="required-label">שעת סיום</label>
            <div class="time-picker-row">
              <select id="editEndHour" onchange="updateTimeField('editEnd'); calculateEditHours()" required>
                <option value="">שעה</option>
              </select>
              <span class="time-separator">:</span>
              <select id="editEndMinute" onchange="updateTimeField('editEnd'); calculateEditHours()" required>
                <option value="">דקות</option>
              </select>
              <input type="hidden" id="editEndTime">
            </div>
          </div>
          <div class="form-field">
            <label for="editHours">סה"כ שעות</label>
            <input type="number" id="editHours" step="0.01" min="0" max="24" readonly style="background: #f1f5f9; cursor: not-allowed;">
          </div>
          <div class="form-field">
            <label for="editActivity" class="required-label">סוג פעילות</label>
            <select id="editActivity" required>
              <option value="">בחר</option>
              <option value="ביטול זמן">ביטול זמן</option>
              <option value="הכשרה">הכשרה</option>
              <option value="סדנה">סדנה</option>
              <option value="סיור">סיור</option>
              <option value="קורס">קורס</option>
              <option value="תפעול">תפעול</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editSchool" class="required-label">בית ספר</label>
            <select id="editSchool" onchange="updateEditMunicipality()" required>
              <option value="">בחר בית ספר</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editMunicipality" class="required-label">רשות</label>
            <input type="text" id="editMunicipality" readonly style="background: #f1f5f9;" required>
          </div>
          <div class="form-field">
            <label for="editProgram" class="required-label">תוכנית</label>
            <select id="editProgram" required>
              <option value="">בחר תוכנית</option>
              <option value="השמיים אינם הגבול">השמיים אינם הגבול</option>
              <option value="התנסות בתעשייה">התנסות בתעשייה</option>
              <option value="ביומימיקרי">ביומימיקרי</option>
              <option value="ביומימיקרי לחטיבות">ביומימיקרי לחטיבות</option>
              <option value="בינה מלאכותית">בינה מלאכותית</option>
              <option value="יישומי AI">יישומי AI</option>
              <option value="מייקרים טכנו-כיף">מייקרים טכנו-כיף</option>
              <option value="מנהיגות ירוקה">מנהיגות ירוקה</option>
              <option value="מקורות">מקורות</option>
              <option value="משחקי קופסה">משחקי קופסה</option>
              <option value="פורצות דרך">פורצות דרך</option>
              <option value="רוקחים עולם">רוקחים עולם</option>
              <option value="טכנולוגיות החלל">טכנולוגיות החלל</option>
              <option value="תמיר">תמיר</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editSession" class="required-label">מספר מפגש</label>
            <select id="editSession" required>
              <option value="">בחר</option>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editKm">קילומטר</label>
            <input type="number" id="editKm" step="0.1" min="0" placeholder="לדוגמה: 25.5">
          </div>
          <div class="form-field">
            <label for="editTotalExpenses">סה"כ הוצאות (₪)</label>
            <input type="number" id="editTotalExpenses" step="0.01" min="0" placeholder="0.00">
          </div>
          <div class="form-field">
            <label for="editExpensesDetail">פירוט הוצאות</label>
            <textarea id="editExpensesDetail" rows="2" placeholder="פרט את ההוצאות"></textarea>
          </div>
          <div class="form-field">
            <label for="editNotes">הערות</label>
            <textarea id="editNotes" rows="3"></textarea>
          </div>
          <div class="form-field">
            <label for="editAttachments">קבצים מצורפים</label>
            <input type="file" id="editAttachments" multiple accept=".pdf,.png,.jpg,.jpeg,.doc,.docx">
            <small style="color: #64748b; font-size: 12px;">ניתן לצרף מספר קבצים (PDF, תמונות, מסמכים)</small>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="btn" onclick="closeEditModal()" style="background: #e2e8f0; color: #475569;">
            <i class="fas fa-times"></i>
            ביטול
          </button>
          <button class="btn btn-success" onclick="saveEdit()">
            <i class="fas fa-save"></i>
            שמירה
          </button>
        </div>
      </div>
    </div>

    <!-- Employee Details Modal -->
    <div id="employeeDetailsModal" class="modal">
      <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
          <h3 id="employeeDetailsTitle">פירוט שעות</h3>
          <button class="close-btn" onclick="closeEmployeeDetailsModal()">×</button>
        </div>

        <div id="employeeDetailsContent" style="padding: 20px; max-height: 70vh; overflow-y: auto;"></div>

        <div class="modal-footer">
          <button class="btn" onclick="closeEmployeeDetailsModal()" style="background: #e2e8f0; color: #475569;">
            <i class="fas fa-times"></i>
            סגירה
          </button>
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <h3>ייצוא לאקסל</h3>
          <button class="close-btn" onclick="closeExportModal()">×</button>
        </div>
        
        <div style="padding: 20px;">
          <p style="margin-bottom: 15px; color: #64748b;">בחר סוג ייצוא:</p>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn" onclick="exportReportToExcel('all')" style="background: #3b82f6; color: white; padding: 15px;">
              <i class="fas fa-list"></i>
              כל השורות (מפורט)
            </button>
            <button class="btn" onclick="exportReportToExcel('grouped')" style="background: #10b981; color: white; padding: 15px;">
              <i class="fas fa-chart-bar"></i>
              מקובץ לפי עובד (סיכום)
            </button>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="btn" onclick="closeExportModal()" style="background: #e2e8f0; color: #475569;">
            <i class="fas fa-times"></i>
            ביטול
          </button>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
      <div class="modal-content" style="max-width: 340px; margin: 16px; padding: 0; border-radius: 20px; overflow: hidden;">
        <div class="modal-header" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 20px; border-radius: 0;">
          <h3 style="color: #dc2626; margin: 0; font-size: 18px;">
            <i class="fas fa-sign-out-alt" style="margin-left: 8px;"></i>
            יציאה מהמערכת
          </h3>
          <button class="close-btn" onclick="closeLogoutModal()" style="background: rgba(220,38,38,0.1); color: #dc2626;">×</button>
        </div>
        
        <div style="padding: 28px 24px; text-align: center; background: white;">
          <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
            <i class="fas fa-question" style="font-size: 24px; color: #dc2626;"></i>
          </div>
          <p style="color: #475569; font-size: 16px; margin-bottom: 0; line-height: 1.6;">האם אתה בטוח שברצונך להתנתק?</p>
        </div>
        
        <div class="modal-footer" style="justify-content: center; gap: 12px; padding: 20px; background: #f8fafc; border-top: 1px solid #e2e8f0;">
          <button class="btn" onclick="closeLogoutModal()" style="background: white; color: #475569; min-width: 110px; border: 1px solid #e2e8f0; padding: 12px 20px; font-size: 15px;">
            <i class="fas fa-times"></i>
            ביטול
          </button>
          <button class="btn" onclick="confirmLogout()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; min-width: 110px; padding: 12px 20px; font-size: 15px; box-shadow: 0 4px 12px rgba(239,68,68,0.3);">
            <i class="fas fa-sign-out-alt"></i>
            אישור
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
// =============== Configuration ===============

const CONFIG = {
  LOGIC_APP_URL: "https://prod-01.israelcentral.logic.azure.com:443/workflows/04031e5e47bd4f6e90abfd3e95b1768b/triggers/manual/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=HrWXi-vhW2ni_HyFDpZWof0aFU3dGwTrZ-CHiKuwe5Q",
  MAX_RETRY: 3,
  RETRY_DELAY: 1000
};

// For backwards compatibility
const LOGIC_APP_URL = CONFIG.LOGIC_APP_URL;

const API_FEATURES = {
  approvals: true,
  recordUpdates: true,
  recordDeletes: true,
  exports: true
};

function isApprovalsSupported() {
  return API_FEATURES.approvals;
}

function isRecordUpdateSupported() {
  return API_FEATURES.recordUpdates;
}

function isRecordDeleteSupported() {
  return API_FEATURES.recordDeletes;
}

function isExportSupported() {
  return API_FEATURES.exports;
}

// =============== Fixed Lists (Constant Values) ===============
const TEAMS_LIST = [
  'גיל',
  'לינוי',
  'הכל'
];

const EMPLOYMENT_TYPES = [
  'תעשיידע',
  'מעוף',
  'מנפאואר',
  'עצמאי'
];

const ACTIVITY_TYPES = [
  'ביטול זמן',
  'הכשרה',
  'סדנה',
  'סיור',
  'קורס',
  'תפעול'
];

const PROGRAMS_LIST = [
  'השמיים אינם הגבול',
  'התנסות בתעשייה',
  'ביומימיקרי',
  'ביומימיקרי לחטיבות',
  'בינה מלאכותית',
  'יישומי AI',
  'מייקרים טכנו-כיף',
  'מנהיגות ירוקה',
  'מקורות',
  'משחקי קופסה',
  'פורצות דרך',
  'רוקחים עולם',
  'טכנולוגיות החלל',
  'תמיר'
];

// =============== State ===============
let records = [];
let currentUser = '';
let editingIndex = -1;

// =============== Helper: Decimal Hours to HH:MM Format ===============
function formatHoursDisplay(decimalHours) {
  const num = parseFloat(decimalHours) || 0;
  const hours = Math.floor(num);
  const minutes = Math.round((num - hours) * 60);
  return `${hours}:${minutes.toString().padStart(2, '0')}`;
}

// =============== Helper: Extract Status Value (handles string, object, and Choice fields) ===============
function extractStatusValue(statusField, defaultValue = 'pending') {
  if (!statusField) return defaultValue;
  if (typeof statusField === 'object' && statusField.Value) return statusField.Value;
  if (typeof statusField === 'string') return statusField;
  return defaultValue;
}

function deriveRecordStatus(record) {
  const statusVal = extractStatusValue(record?.status || record?.Status, '').toLowerCase();
  if (statusVal === 'approved' || statusVal === 'מאושר') return 'approved';
  if (statusVal === 'rejected' || statusVal === 'נדחה') return 'rejected';
  const approvedBy = record?.approvedBy || record?.ApprovedBy || '';
  if (approvedBy && String(approvedBy).trim() !== '') return 'approved';
  return 'pending';
}

function getStatusDisplayText(statusFieldOrRecord) {
  if (statusFieldOrRecord && typeof statusFieldOrRecord === 'object' && ('approvedBy' in statusFieldOrRecord || 'ApprovedBy' in statusFieldOrRecord || 'employeeId' in statusFieldOrRecord)) {
    const val = deriveRecordStatus(statusFieldOrRecord);
    if (val === 'approved') return 'מאושר';
    if (val === 'rejected') return 'נדחה';
    return 'ממתין';
  }
  const val = extractStatusValue(statusFieldOrRecord, 'pending').toLowerCase();
  if (val === 'approved' || val === 'מאושר') return 'מאושר';
  if (val === 'rejected' || val === 'נדחה') return 'נדחה';
  return 'ממתין';
}

function isStatusApproved(statusFieldOrRecord) {
  if (statusFieldOrRecord && typeof statusFieldOrRecord === 'object' && ('approvedBy' in statusFieldOrRecord || 'ApprovedBy' in statusFieldOrRecord || 'employeeId' in statusFieldOrRecord)) {
    return deriveRecordStatus(statusFieldOrRecord) === 'approved';
  }
  const val = extractStatusValue(statusFieldOrRecord, '').toLowerCase();
  return val === 'מאושר' || val === 'approved';
}

// =============== Helper: Extract SharePoint Lookup Value ===============
function extractLookupValue(field, defaultValue = '') {
  if (!field) return defaultValue;
  if (typeof field === 'string') {
    try {
      const parsed = JSON.parse(field);
      if (parsed && parsed.Value) return parsed.Value;
      return field;
    } catch (e) {
      return field;
    }
  }
  if (typeof field === 'object' && field.Value) {
    return field.Value;
  }
  return defaultValue;
}

// =============== Helper: Normalize Employment Type ===============
function normalizeEmploymentType(source, defaultValue = '') {
  if (!source) return defaultValue;

  let extractedValue = '';

  // Helper to extract value from SharePoint lookup/choice field objects
  const extractFromFieldObject = (obj) => {
    if (!obj) return '';
    if (typeof obj === 'string') return obj;
    if (typeof obj !== 'object') return '';
    // Try all possible object formats from SharePoint lookup/choice fields
    const val = obj.Value || obj.value || obj.Label || obj.label || 
                obj.LookupValue || obj.lookupValue ||
                obj.results?.[0] || obj.Results?.[0] || '';
    if (typeof val === 'object') {
      // Nested object - try again
      return extractFromFieldObject(val);
    }
    return val ? String(val) : '';
  };

  if (typeof source === 'object') {
    // Check known employmentType fields only (don't extract from whole record)
    const possibleFields = [
      source.employmentType,
      source.EmploymentType,
      source.EmployeeType,
      source.employeeType,
      source['Employment_x0020_Type'],
      source.SogHaasaka,
      source.field_OData_EmploymentType,
      source.OData__EmploymentType,
      source.OData__x0045_mploymentType,
      source['OData__EmploymentType'],
      source['field@odata.EmploymentType'],
      source.Title_EmploymentType
    ];

    for (const field of possibleFields) {
      const value = extractFromFieldObject(field) || extractLookupValue(field, '');
      if (value && typeof value === 'string' && value.trim()) {
        extractedValue = value;
        break;
      }
    }
  } else {
    extractedValue = extractLookupValue(source, '');
  }

  if (extractedValue && extractedValue.trim()) {
    if (!EMPLOYMENT_TYPES.includes(extractedValue)) {
      console.warn('Employment type not in list:', extractedValue, '- using as-is');
    }
    return extractedValue;
  }

  return defaultValue;
}

// =============== Helper: Validate Activity Type ===============
function isValidActivityType(activityType) {
  if (!activityType) return false;
  return ACTIVITY_TYPES.includes(activityType);
}

// =============== Payload Normalization ===============
/**
 * Normalize payload between Employee table (PascalCase) and Attendance table (camelCase)
 * 
 * Employee table fields: EmployeeName, Team, EmploymentType (PascalCase)
 * Attendance table fields: employeeName, team, employmentType (camelCase)
 */
function normalizePayload(action, data) {
  const cleanPayload = (payload) => {
    // Replace null/undefined with empty string, keep all fields for SharePoint
    const cleaned = {};
    for (const [key, value] of Object.entries(payload)) {
      if (value === null || value === undefined) {
        cleaned[key] = '';
      } else {
        cleaned[key] = value;
      }
    }
    return cleaned;
  };

  const normalizedAction = String(action || '').toLowerCase();

  switch (normalizedAction) {
    case 'auth':
      return {
        action: 'auth',
        employeeId: data.employeeId,
        personalCode: data.personalCode
      };
      
    case 'submit':
      return cleanPayload({
        action: 'submit',
        // Identity fields
        employeeId: data.employeeId,
        employeeName: data.employeeName,
        role: data.role,
        team: String(data.team || ''),
        employmentType: String(data.employmentType || ''),
        
        // Attendance Data
        attendanceDate: data.attendanceDate,
        ...(data.startTime ? { startTime: data.startTime } : {}),
        ...(data.endTime ? { endTime: data.endTime } : {}),
        workHours: Number(data.workHours || 0),
        
        // Categorization & Location (Choice/Lookup as Strings)
        activityType: String(data.activityType || ''),
        schoolName: String(data.schoolName || ''),
        municipality: String(data.municipality || ''),
        programName: String(data.programName || ''),
        
        // Metrics & Expenses
        sessionNumber: Number(data.sessionNumber || 0),
        kilometers: Number(data.kilometers || 0),
        totalExpenses: Number(data.totalExpenses || 0),
        expensesDetails: String(data.expensesDetails || ''),
        
        // Notes & Attachments
        notes: String(data.notes || ''),
        ...(data.attachmentsNames ? { attachmentsNames: data.attachmentsNames } : {})
      });
      
    case 'getsummary':
      return {
        action: 'getsummary'
      };
      
    case 'getemployeerecords':
      return {
        action: 'getemployeerecords',
        employeeId: data.employeeId
      };
      
    case 'getteamapprovalstatus':
      return {
        action: 'getteamapprovalstatus',
        team: data.team || 'all',
        monthKey: data.monthKey || data.month || ''
      };
      
    case 'getallemployees':
      return {
        action: 'getallemployees'
      };
      
    case 'updaterecord':
      return cleanPayload({
        action: 'updaterecord',
        recordId: data.recordId,
        employeeId: String(data.employeeId || ''),
        employeeName: String(data.employeeName || ''),
        team: String(data.team || ''),
        employmentType: String(data.employmentType || ''),
        attendanceDate: data.attendanceDate,
        startTime: data.startTime || '',
        endTime: data.endTime || '',
        workHours: Number(data.workHours || 0),
        activityType: String(data.activityType || ''),
        schoolName: String(data.schoolName || ''),
        municipality: String(data.municipality || ''),
        programName: String(data.programName || ''),
        sessionNumber: Number(data.sessionNumber || 0),
        kilometers: Number(data.kilometers || 0),
        totalExpenses: Number(data.totalExpenses || 0),
        expensesDetails: String(data.expensesDetails || ''),
        notes: String(data.notes || ''),
        status: data.status || 'pending',
        approvedBy: String(data.approvedBy || ''),
        approvedDate: String(data.approvedDate || ''),
        attachmentsNames: String(data.attachmentsNames || '')
      });
      
    case 'deleterecord':
      return {
        action: 'deleterecord',
        recordId: data.recordId
      };
      
    case 'exportdata':
      return {
        action: 'exportdata'
      };
      
    case 'getmonthlyapproval':
      return {
        action: 'getmonthlyapproval',
        employeeId: data.employeeId,
        monthKey: data.month || data.monthKey,
        team: data.team
      };
      
    case 'resetteammonth':
      return {
        action: 'resetteammonth',
        team: data.team,
        month: data.month,
        year: data.year
      };
      
    case 'approvemonthrecords':
      return cleanPayload({
        action: 'approvemonthrecords',
        employeeId: data.employeeId,
        team: data.team,
        month: data.month,
        year: data.year,
        approvedBy: data.approvedBy,
        approverName: data.approverName
      });
      
    case 'setinstructorapproval':
      return {
        action: 'setinstructorapproval',
        employeeId: data.employeeId,
        employeeName: data.employeeName,
        monthKey: data.monthKey || data.month,
        team: data.team
      };
      
    case 'setmanagerapproval':
      return {
        action: 'setmanagerapproval',
        employeeId: data.employeeId,
        monthKey: data.monthKey || data.month
      };
      
    case 'cancelinstructorapproval':
      return {
        action: 'cancelinstructorapproval',
        employeeId: data.employeeId,
        monthKey: data.monthKey || data.month
      };
      
    default:
      throw new Error(`Unsupported action: ${normalizedAction}`);
  }
}

/**
 * Convert Employee table response (PascalCase) to frontend format
 */
function normalizeEmployeeFromServer(emp) {
  if (!emp) return null;
  
  const empType = normalizeEmploymentType(emp, '');
  
  // Extract employee name - try all possible field names from SharePoint
  const empName = emp.EmployeeName || emp.employeeName || emp.Title || emp.title || '';
  
  // Extract employee ID - try all possible field names
  const empId = emp.employeeId || emp.EmployeeId || emp.ID || emp.Id || emp.id || '';
  
  return {
    employeeId: empId,
    empName: empName,
    role: emp.role || 'instructor',
    team: extractLookupValue(emp.Team || emp.team || '', ''),
    employmentType: empType
  };
}

/**
 * Convert Attendance table response (camelCase) to frontend format
 */
function normalizeRecordFromServer(rec) {
  if (!rec) return null;
  return {
    id: rec.ID || rec.Id || rec.id,
    empNum: rec.employeeId || rec.EmployeeId,
    empName: rec.employeeName || rec.EmployeeName,  // Support camelCase + PascalCase
    date: rec.attendanceDate || rec.AttendanceDate,
    start: rec.startTime || rec.StartTime || '',
    end: rec.endTime || rec.EndTime || '',
    hours: Number(rec.workHours || rec.WorkHours || 0),
    activity: rec.activityType || rec.ActivityType,
    school: rec.schoolName || rec.SchoolName || '',
    municipality: rec.municipality || rec.Municipality,
    program: rec.programName || rec.ProgramName || '',
    session: Number(rec.sessionNumber || rec.SessionNumber || 0),
    km: Number(rec.kilometers || rec.Kilometers || 0),
    totalExpenses: Number(rec.totalExpenses || rec.TotalExpenses || 0),
    expensesDetail: rec.expensesDetails || rec.ExpensesDetails || '',
    notes: rec.notes || rec.Notes || '',
    team: rec.team || rec.Team || '',
    employmentType: normalizeEmploymentType(rec, ''),
    attachmentsNames: rec.attachmentsNames || rec.AttachmentsNames || '',
    status: deriveRecordStatus(rec),
    approvedBy: rec.approvedBy || rec.ApprovedBy || '',
    approvedDate: rec.approvedDate || rec.ApprovedDate || '',
    rejectReason: rec.rejectReason || rec.RejectReason || '',
    MonthApproved: rec.MonthApproved || '',
    ApprovalDate: rec.ApprovalDate || ''
  };
}

/**
 * API Request with retry logic
 */
async function apiRequest(action, data, retryCount = 0) {
  let payload;
  try {
    payload = normalizePayload(action, data);
  } catch (error) {
    console.error('Unsupported action:', action, error);
    throw error;
  }
  // Sanitize payload for logging (remove sensitive data like personalCode)
  const sanitizedPayload = { ...payload };
  if (sanitizedPayload.personalCode) sanitizedPayload.personalCode = '***';

  try {
    const response = await fetch(CONFIG.LOGIC_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      console.error(`=== API ERROR (${response.status}) ===`);
      console.error('Action:', action);
      console.error('Payload:', JSON.stringify(sanitizedPayload, null, 2));
      console.error('Response:', response.status, response.statusText);
      console.error('Error data:', errorData);
      throw new Error(errorData.message || `Server error: ${response.status}`);
    }

    return await response.json();

  } catch (error) {
    // Retry logic for network errors
    if (retryCount < CONFIG.MAX_RETRY &&
        (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
      console.warn(`🔄 Retry ${retryCount + 1}/${CONFIG.MAX_RETRY} for ${action}`);
      await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * (retryCount + 1)));
      return apiRequest(action, data, retryCount + 1);
    }
    // Log final error after all retries
    if (retryCount >= CONFIG.MAX_RETRY) {
      console.error('=== API REQUEST FAILED (all retries exhausted) ===');
      console.error('Action:', action);
      console.error('Payload:', JSON.stringify(sanitizedPayload, null, 2));
      console.error('Error:', error.message || error);
    }
    throw error;
  }
}

// =============== Users ===============
// Authentication moved to server-side for security

// =============== Schools Data ===============
const schoolsData = [
  {"רשות":"בנימינה","בית ספר":"מתנ\"ס"},
  {"רשות":"בנימינה","בית ספר":"בראשית"},
  {"רשות":"בנימינה","בית ספר":"אשכולות"},
  {"רשות":"בנימינה","בית ספר":"אמירים"},
  {"רשות":"בנימינה","בית ספר":"גבע"},
  {"רשות":"ג'דיידה מכר","בית ספר":"ג'דיידה יסודי"},
  {"רשות":"הרצליה","בית ספר":"ויצו פנינים אילנות"},
  {"רשות":"חיפה","בית ספר":"לאובק"},
  {"רשות":"ירושלים","בית ספר":"ביכורים"},
  {"רשות":"כיסרא סמיה","בית ספר":"כיסרא סמיה"},
  {"רשות":"כסרא סמיע","בית ספר":"כסרא סמיע"},
  {"רשות":"ירכא","בית ספר":"ירכא אל-רואי"},
  {"רשות":"ירכא","בית ספר":"ירכא אל-אמין"},
  {"רשות":"ירכא","בית ספר":"אלרואיא"},
  {"רשות":"ג'וליס","בית ספר":"דרכא"},
  {"רשות":"ג'וליס","בית ספר":"ג'וליס"},
  {"רשות":"עין קיניה","בית ספר":"עין קיניה"},
  {"רשות":"בוקעתא","בית ספר":"בוקעתא"},
  {"רשות":"מג'דל שמס","בית ספר":"מג'דל שמס"},
  {"רשות":"דלית אל-כרמל","בית ספר":"אלאשראק"},
  {"רשות":"יהוד","בית ספר":"הרצל"},
  {"רשות":"יהוד","בית ספר":"יהודה הלוי"},
  {"רשות":"יהוד","בית ספר":"היובל"},
  {"רשות":"אשכול","בית ספר":"נופי הבשור"},
  {"רשות":"מנשה","בית ספר":"נטעים"},
  {"רשות":"מטה יהודה","בית ספר":"אלון"},
  {"רשות":"מטה יהודה","בית ספר":"מתיתיהו"},
  {"רשות":"מטה יהודה","בית ספר":"האלה"},
  {"רשות":"מטה יהודה","בית ספר":"הרטוב היסודי"},
  {"רשות":"מטה יהודה","בית ספר":"עין הרים"},
  {"רשות":"מטה יהודה","בית ספר":"השחר"},
  {"רשות":"מטה יהודה","בית ספר":"יסודי עין נקובא-ראפה"},
  {"רשות":"מטה יהודה","בית ספר":"קרוב"},
  {"רשות":"מטה יהודה","בית ספר":"נווה שלום"},
  {"רשות":"מטה יהודה","בית ספר":"קסם"},
  {"רשות":"מסעדה","בית ספר":"מסעדה יסודי"},
  {"רשות":"נהריה","בית ספר":"גולדה"},
  {"רשות":"נהריה","בית ספר":"ישיבת אבירי יעקב"},
  {"רשות":"נהריה","בית ספר":"מדעים"},
  {"רשות":"נהריה","בית ספר":"רמב\"ם"},
  {"רשות":"נתניה","בית ספר":"בר אילן"},
  {"רשות":"נתניה","בית ספר":"אלדד"},
  {"רשות":"נתניה","בית ספר":"ריגלר"},
  {"רשות":"נתניה","בית ספר":"אלתרמן"},
  {"רשות":"נתניה","בית ספר":"אורט גוטמן"},
  {"רשות":"נתניה","בית ספר":"שחפים חנ\"מ (אלומות לשעבר)"},
  {"רשות":"עין אלאסד","בית ספר":"עין אלאסד"},
  {"רשות":"עכו","בית ספר":"גורדון"},
  {"רשות":"עכו","בית ספר":"העליה השניה"},
  {"רשות":"עכו","בית ספר":"חילמי"},
  {"רשות":"עמק הירדן - אפיקים","בית ספר":"אפיקי ירדן"},
  {"רשות":"עמק הירדן - אשדות יעקב","בית ספר":"מול גלעד"},
  {"רשות":"עמק הירדן - גינוסר","בית ספר":"נופי ארבל"},
  {"רשות":"עמק הירדן - דגניה א'","בית ספר":"בית חינוך דגניה"},
  {"רשות":"עמק הירדן - כנרת","בית ספר":"כנרת"},
  {"רשות":"קריית טבעון","בית ספר":"כפר הנוער רמת הדסה"},
  {"רשות":"קריית שמונה","בית ספר":"מתנ\"ס קריית שמונה"},
  {"רשות":"קריית שמונה","בית ספר":"עוזיאל"},
  {"רשות":"קריית שמונה","בית ספר":"המגינים"},
  {"רשות":"קריית שמונה","בית ספר":"רמב\"ם"},
  {"רשות":"קריית שמונה","בית ספר":"תל-חי"},
  {"רשות":"ראשון לציון","בית ספר":"גימנסיה"},
  {"רשות":"ראשון לציון","בית ספר":"תיכון המעיין"},
  {"רשות":"רחובות","בית ספר":"בכור לוי"},
  {"רשות":"רחובות","בית ספר":"נבון רחובות"},
  {"רשות":"רחובות","בית ספר":"קציר"},
  {"רשות":"בוסתן הגליל","בית ספר":"מיטר"},
  {"רשות":"אופקים","בית ספר":"בן גוריון"},
  {"רשות":"אשדוד","בית ספר":"חווה חקלאית - אשכול"},
  {"רשות":"אשדוד","בית ספר":"חווה חקלאית - יחד"},
  {"רשות":"אשדוד","בית ספר":"מקיף ה'"},
  {"רשות":"אשדוד","בית ספר":"מקיף ט'"},
  {"רשות":"אשכול","בית ספר":"מרחבי אשכול"},
  {"רשות":"אשכול","בית ספר":"שדות אשכול"},
  {"רשות":"אשכול","בית ספר":"שמש גבולות"},
  {"רשות":"אשקלון","בית ספר":"אילנות"},
  {"רשות":"אשקלון","בית ספר":"בראשית"},
  {"רשות":"אשקלון","בית ספר":"דרכא מקיף ה'"},
  {"רשות":"אשקלון","בית ספר":"נוף ים ב'"},
  {"רשות":"באר יעקב","בית ספר":"צאלון"},
  {"רשות":"באר שבע","בית ספר":"התומר"},
  {"רשות":"באר שבע","בית ספר":"חווה חקלאית - התומר"},
  {"רשות":"באר שבע","בית ספר":"שובו"},
  {"רשות":"באר שבע","בית ספר":"חווה חקלאית - רננות"},
  {"רשות":"באר שבע","בית ספר":"מקיף ג'"},
  {"רשות":"גדרה","בית ספר":"דרכא רמון"},
  {"רשות":"דימונה","בית ספר":"נווה עמרם"},
  {"רשות":"יבנה","בית ספר":"ביאליק"},
  {"רשות":"יבנה","בית ספר":"נבון יבנה"},
  {"רשות":"יבנה","בית ספר":"פרדס צפוני"},
  {"רשות":"יד בנימין","בית ספר":"יד בנימין"},
  {"רשות":"לכיש","בית ספר":"רבקה גובר"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"באר גנים"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"חופים"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"מורשה"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"ניצן"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"ניצני קליף"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"שדות סילבר"},
  {"רשות":"מודיעין","בית ספר":"תיכון ב'"},
  {"רשות":"נס ציונה","בית ספר":"בן גוריון"},
  {"רשות":"קריית גת","בית ספר":"אורט גרוס"},
  {"רשות":"קריית גת","בית ספר":"אורט מאיר"},
  {"רשות":"קריית גת","בית ספר":"בן צבי"},
  {"רשות":"קריית גת","בית ספר":"דוד אלעזר"},
  {"רשות":"קריית גת","בית ספר":"משואה"},
  {"רשות":"קריית מלאכי","בית ספר":"דרור"},
  {"רשות":"קריית מלאכי","בית ספר":"עמל גבעתי"},
  {"רשות":"רמלה","בית ספר":"חטיבת עידנים"},
  {"רשות":"רמלה","בית ספר":"מקיף יגאל אלון"},
  {"רשות":"רמלה","בית ספר":"תיכון פרופ נגר"},
  {"רשות":"רמלה","בית ספר":"שמיר"},
  {"רשות":"שדרות","בית ספר":"חניתה ב'"},
  {"רשות":"אבן שמואל","בית ספר":"שפיר"},
  {"רשות":"שפיר","בית ספר":"תתמ\"ד"},
  {"רשות":"שער הנגב","בית ספר":"שדות רוחמה"}
];

// Sort and add Zoom at beginning
schoolsData.sort((a, b) => a['בית ספר'].localeCompare(b['בית ספר'], 'he'));
schoolsData.unshift({"רשות":"זום","בית ספר":"זום"});

// =============== Role Management ===============
function normalizeRole(role) {
  if (!role) return 'instructor';
  
  // Handle SharePoint object format: {"Value": "System Admin", ...}
  let roleValue = role;
  if (typeof role === 'object' && role.Value) {
    roleValue = role.Value;
  } else if (typeof role === 'string' && role.includes('"Value"')) {
    try {
      const parsed = JSON.parse(role);
      roleValue = parsed.Value || role;
    } catch(e) {
      roleValue = role;
    }
  }
  
  const roleMap = {
    // System Admin variations
    'System Admin': 'system_admin',
    'system admin': 'system_admin',
    'system_admin': 'system_admin',
    'Admin': 'system_admin',
    'admin': 'system_admin',
    'Administrator': 'system_admin',
    'administrator': 'system_admin',
    'מנהל מערכת': 'system_admin',
    'אדמין': 'system_admin',
    // Manager variations
    'Manager': 'manager',
    'manager': 'manager',
    'מנהל': 'manager',
    'מנהלת': 'manager',
    'מנהל פעילות': 'manager',
    'מנהלת פעילות': 'manager',
    'מנהל/ת פעילות': 'manager',
    'מנהל פעילויות': 'manager',
    'מנהלת פעילויות': 'manager',
    'מנהל/ת פעילויות': 'manager',
    'מנהל צוות': 'manager',
    'מנהלת צוות': 'manager',
    'מנהל/ת צוות': 'manager',
    // Payroll Officer variations
    'Payroll Officer': 'payroll_officer',
    'payroll officer': 'payroll_officer',
    'payroll_officer': 'payroll_officer',
    'Payroll': 'payroll_officer',
    'payroll': 'payroll_officer',
    'אחראית שכר': 'payroll_officer',
    'אחראי שכר': 'payroll_officer',
    // Operations Controller variations
    'Operations Controller': 'operations_controller',
    'operations controller': 'operations_controller',
    'operations_controller': 'operations_controller',
    'Controller': 'operations_controller',
    'controller': 'operations_controller',
    'מבקרת תפעול': 'operations_controller',
    'מבקר תפעול': 'operations_controller',
    // Instructor variations
    'Instructor': 'instructor',
    'instructor': 'instructor',
    'מדריך': 'instructor',
    'מדריכה': 'instructor',
    'מדריך/ה': 'instructor'
  };
  
  const normalizedValue = typeof roleValue === 'string' ? roleValue.trim() : String(roleValue);
  return roleMap[normalizedValue] || 'instructor';
}

function getRoleDisplayName(role) {
  const normalizedRole = normalizeRole(role);
  const roleNames = {
    'system_admin': 'מנהל מערכת',
    'manager': 'מנהל/ת פעילויות',
    'payroll_officer': 'אחראית שכר',
    'operations_controller': 'מבקרת תפעול',
    'instructor': 'מדריך/ה'
  };
  return roleNames[normalizedRole] || 'משתמש';
}

function getCurrentUserData() {
  try {
    const saved = localStorage.getItem('currentUser');
    return saved ? JSON.parse(saved) : null;
  } catch(e) {
    return null;
  }
}

function updateMenuByRole(role) {
  // Normalize the role (in case it wasn't normalized earlier)
  const normalizedRole = normalizeRole(role);
  console.log('updateMenuByRole called with:', role, '-> normalized to:', normalizedRole);
  
  // Handle sidebar nav items via data-roles
  const navItems = document.querySelectorAll('#sidebarNav .nav-item');
  navItems.forEach(item => {
    const allowedRoles = item.getAttribute('data-roles');
    if (allowedRoles === 'all') {
      item.style.display = 'flex';
    } else {
      const roles = allowedRoles.split(',').map(r => r.trim());
      const isAllowed = roles.includes(normalizedRole);
      console.log('Menu item:', item.querySelector('span')?.textContent, 'roles:', roles, 'allowed:', isAllowed);
      item.style.display = isAllowed ? 'flex' : 'none';
    }
  });

  // Handle mobile bottom nav items via data-roles
  const mobileNavItems = document.querySelectorAll('#mobileBottomNav .mobile-nav-item');
  mobileNavItems.forEach(item => {
    const allowedRoles = item.getAttribute('data-roles');
    if (!allowedRoles || allowedRoles === 'all') {
      item.style.display = 'flex';
    } else {
      const roles = allowedRoles.split(',').map(r => r.trim());
      item.style.display = roles.includes(normalizedRole) ? 'flex' : 'none';
    }
  });

  // Hide dashboard "add record" button for non-instructors
  const dashboardAddBtn = document.getElementById('dashboardAddRecordBtn');
  if (dashboardAddBtn) {
    dashboardAddBtn.style.display = (role === 'instructor') ? 'flex' : 'none';
  }

  // Show appropriate dashboard based on role
  const payrollDashboard = document.getElementById('payrollDashboard');
  const adminControllerDashboard = document.getElementById('adminControllerDashboard');
  const regularDashboardContent = document.getElementById('regularDashboardContent');
  
  // Hide all dashboards first
  if (payrollDashboard) payrollDashboard.style.display = 'none';
  if (adminControllerDashboard) adminControllerDashboard.style.display = 'none';
  if (regularDashboardContent) regularDashboardContent.style.display = 'none';
  
  // Show the appropriate dashboard
  if (role === 'payroll_officer') {
    if (payrollDashboard) payrollDashboard.style.display = 'block';
  } else if (role === 'system_admin' || role === 'operations_controller') {
    if (adminControllerDashboard) adminControllerDashboard.style.display = 'block';
    // Show filters for admin and operations_controller
    const filters = document.getElementById('adminDashboardFilters');
    if (filters) {
      filters.style.display = 'flex';
    }
    // Show team filter only for system_admin (operations_controller sees all teams without filter)
    const filterTeam = document.getElementById('filterTeam');
    if (filterTeam) {
      // Show team filter for system_admin on all devices
      filterTeam.style.display = role === 'system_admin' ? 'block' : 'none';
    }
    // Show employment type filter for both system_admin and operations_controller
    const filterEmploymentType = document.getElementById('filterEmploymentType');
    if (filterEmploymentType) {
      filterEmploymentType.style.display = 'inline-block';
    }
    // Show approval buttons only for system_admin
    const adminApprovalCard = document.getElementById('adminApprovalCard');
    if (adminApprovalCard) {
      adminApprovalCard.style.display = role === 'system_admin' ? 'block' : 'none';
    }
  } else if (role === 'manager') {
    // Manager sees adminControllerDashboard filtered to their team
    if (adminControllerDashboard) adminControllerDashboard.style.display = 'block';
    // Show month/year filters for manager, hide team filter (they only see their team)
    const filters = document.getElementById('adminDashboardFilters');
    if (filters) filters.style.display = 'flex';
    const filterTeam = document.getElementById('filterTeam');
    if (filterTeam) filterTeam.style.display = 'none';
    // Show employment type filter for managers too (like admin and operations_controller)
    const filterEmploymentType = document.getElementById('filterEmploymentType');
    if (filterEmploymentType) filterEmploymentType.style.display = 'inline-block';
    // Hide approval buttons for managers - only system_admin can approve teams from dashboard
    const adminApprovalCard = document.getElementById('adminApprovalCard');
    if (adminApprovalCard) adminApprovalCard.style.display = 'none';
    // Update the title to show manager's team
    const title = adminControllerDashboard.querySelector('.card-title');
    if (title) {
      const teamName = getCurrentUserData()?.team || '';
      title.innerHTML = `<i class="fas fa-users" style="margin-left: 8px; color: #3b82f6;"></i>סיכום צוות ${teamName} - חודש נוכחי`;
    }
  } else {
    if (regularDashboardContent) regularDashboardContent.style.display = 'block';
  }
  
  // Show month selector for ALL roles (was only instructors before)
  const instructorMonthSelector = document.getElementById('instructorMonthSelector');
  if (instructorMonthSelector) {
    instructorMonthSelector.style.display = 'flex';
  }
  
  // Initialize instructor month selectors
  initInstructorMonthSelectors();

  updateMonthlyApprovalVisibility();
}

function hasPermission(action, targetTeam = null) {
  const user = getCurrentUserData();
  if (!user) return false;
  
  const role = user.role;
  
  switch(action) {
    case 'view_own':
      return true;
    case 'view_team':
      return role === 'manager' || role === 'operations_controller';
    case 'view_all':
      return ['operations_controller', 'system_admin', 'payroll_officer'].includes(role);
    case 'edit_own':
      return role === 'instructor';
    case 'edit_team':
      if (role === 'manager') {
        return user.team === targetTeam;
      }
      if (role === 'operations_controller') {
        return true; // Can edit all teams
      }
      return role === 'system_admin';
    case 'edit_all':
      return role === 'system_admin';
    case 'delete':
      return role === 'system_admin';
    case 'admin':
      return role === 'system_admin';
    default:
      return false;
  }
}

function getRecordMonthKey(record) {
  const recordDateStr = record.date || record.attendanceDate;
  if (!recordDateStr) return null;
  const recordDate = new Date(recordDateStr);
  if (isNaN(recordDate.getTime())) return null;
  return `${recordDate.getFullYear()}-${String(recordDate.getMonth() + 1).padStart(2, '0')}`;
}

function isManagerApprovedForRecord(record) {
  const empId = String(record.empNum || record.employeeId || '').trim();
  const monthKey = getRecordMonthKey(record);
  if (!empId || !monthKey) return false;
  const cacheKey = `${empId}-${monthKey}`;
  return managerApprovalCache.has(cacheKey) && managerApprovalCache.get(cacheKey);
}

function canEditRecord(record) {
  if (!isRecordUpdateSupported()) {
    return false;
  }
  const user = getCurrentUserData();
  if (!user) return false;
  
  const role = user.role;

  // system_admin can edit all records (even after manager approval)
  if (role === 'system_admin') {
    return true;
  }

  // Check manager approval lock - if manager approved this employee+month, only admin can edit
  if (isManagerApprovedForRecord(record)) {
    return false;
  }

  // operations_controller can edit all teams (like manager but no team filter)
  if (role === 'operations_controller') {
    return true;
  }

  // manager can edit team records (bypass instructor approval lock for team management)
  if (role === 'manager') {
    if (!record) return false;
    const recordTeam = record.team || record.Team || '';
    return !recordTeam || recordTeam.trim().toLowerCase() === (user.team || '').trim().toLowerCase();
  }

  // instructor can edit only their own records, unless month is approved
  if (role === 'instructor') {
    const recordEmpNum = record.empNum || record.employeeId;
    const userEmpNum = user.empNum || localStorage.getItem('employeeId');

    // Must be own record
    if (String(recordEmpNum) !== String(userEmpNum)) {
      return false;
    }

    const recordDateStr = record.date || record.attendanceDate;
    if (!recordDateStr) return false;

    if (instructorApprovalInfo && instructorApprovalInfo.approvalDate) {
      const recordDate = new Date(recordDateStr);
      const recordMonthKey = `${recordDate.getFullYear()}-${String(recordDate.getMonth() + 1).padStart(2, '0')}`;
      if (instructorApprovalInfo.monthKey === recordMonthKey) {
        return false;
      }
    }

    return true;
  }

  // payroll_officer and others = view only, no edit
  return false;
}

// Helper function to get detailed reason why editing is blocked
function getEditBlockReason(record) {
  const user = getCurrentUserData();
  if (!user) return 'משתמש לא מחובר';

  if (!isRecordUpdateSupported()) {
    return 'עדכון רשומות אינו נתמך ב-API הנוכחי';
  }

  const role = user.role;

  // Admin can always edit
  if (role === 'system_admin') {
    return null;
  }

  // Check manager approval lock for non-admin roles
  if (isManagerApprovedForRecord(record)) {
    return 'החודש אושר ע"י מנהל - עריכה חסומה';
  }

  // Manager and operations controller can edit (unless manager-approved above)
  if (role === 'manager' || role === 'operations_controller') {
    return null;
  }

  if (role === 'payroll_officer') {
    return 'אחראית שכר - צפייה בלבד';
  }

  if (role === 'instructor') {
    const recordEmpNum = record.empNum || record.employeeId;
    const userEmpNum = user.empNum || localStorage.getItem('employeeId');

    if (String(recordEmpNum) !== String(userEmpNum)) {
      return 'ניתן לערוך רק רשומות שלך';
    }

    const recordDateStr = record.date || record.attendanceDate;
    if (!recordDateStr) return 'תאריך רשומה לא תקין';

    const recordDate = new Date(recordDateStr);
    const recordMonthKey = `${recordDate.getFullYear()}-${String(recordDate.getMonth() + 1).padStart(2, '0')}`;

    if (instructorApprovalInfo && instructorApprovalInfo.approvalDate) {
      if (instructorApprovalInfo.monthKey === recordMonthKey) {
        return 'הדוח החודשי אושר ואינו ניתן לעריכה';
      }
    }

    return null;
  }

  return 'אין הרשאה לערוך';
}

function canDeleteRecord(record) {
  if (!isRecordDeleteSupported()) {
    return false;
  }
  if (!record) return false;
  
  const user = getCurrentUserData();
  if (!user) return false;
  
  const role = user.role;
  
  // payroll_officer = view only, no delete
  if (role === 'payroll_officer') {
    return false;
  }
  
  // system_admin can always delete
  if (role === 'system_admin') {
    return true;
  }
  
  // Check if record has double approval (instructor + manager)
  const hasDoubleApproval = record && isStatusApproved(record) && record.managerApproved;
  
  // After double approval, only admin can delete
  if (hasDoubleApproval) {
    return false;
  }
  
  // Before double approval: instructor, manager, operations_controller can delete
  if (['instructor', 'manager', 'operations_controller'].includes(role)) {
    // Instructor can only delete own records
    if (role === 'instructor') {
      const recordEmpNum = record.empNum || record.employeeId;
      const userEmpNum = user.empNum || localStorage.getItem('employeeId');
      return String(recordEmpNum) === String(userEmpNum);
    }
    // Manager can delete team records
    if (role === 'manager') {
      const recordTeam = record.team || record.Team || '';
      return !recordTeam || recordTeam.trim().toLowerCase() === (user.team || '').trim().toLowerCase();
    }
    // Operations controller can delete all
    return true;
  }
  
  return false;
}

function canAddRecord() {
  const user = getCurrentUserData();
  if (!user) return false;
  return user.role === 'instructor';
}

// =============== Sync from SharePoint ===============
function generateRecordKey(rec) {
  return `${rec.empNum || rec.employeeId}_${rec.date || rec.attendanceDate}_${rec.start || rec.startTime}_${rec.activity || rec.activityType}`;
}

function generateRecordId() {
  return 'rec_' + Date.now() + '_' + Math.random().toString(16).slice(2);
}

async function syncFromSharePoint(employeeId) {
  await loadMyRecordsFromServer();
}

async function loadMyRecordsFromServer() {
  const employeeId = localStorage.getItem("employeeId");
  if (!employeeId) {
    records = [];
    renderRecordsTable();
    updateStats();
    return;
  }

  try {
    console.log('טוען ימי עבודה מהשרת...');
    
    const role = localStorage.getItem("role") || '';
    const team = localStorage.getItem("team") || '';
    
    const data = await apiRequest('getemployeerecords', {
      employeeId: employeeId
    });

    if (!data.success || !Array.isArray(data.records)) {
      console.warn("No records or failed:", data);
      records = [];
      renderRecordsTable();
      updateStats();
      return;
    }

    // Use normalizeRecordFromServer to convert records
    records = data.records.map(rec => {
      const normalized = normalizeRecordFromServer(rec);
      // Add recordId for operations
      normalized.recordId = rec.ID || rec.Id || rec.id || normalized.id;
      return normalized;
    });

    // Initialize month selectors to current month before updating stats
    initInstructorMonthSelectors();
    renderRecordsTable();
    updateStats();
  } catch (error) {
    console.error('Load records error:', error);
    // Don't reset records on error - keep existing data
    showAlert('⚠️ ' + (error.message || 'שגיאה בטעינת ימי עבודה'), 'error');
  }
}

async function updateRecordOnServer(updatedRecord, originalDate, originalStartTime) {
  console.log('updateRecordOnServer called with:', updatedRecord);
  console.log('recordId:', updatedRecord.recordId, 'id:', updatedRecord.id, 'ID:', updatedRecord.ID);
  
  const recordId = updatedRecord.recordId || updatedRecord.id || updatedRecord.ID;
  if (!recordId) {
    console.error('Cannot update record: missing recordId');
    showAlert('שגיאה: חסר מזהה רשומה. נסה לרענן את הדף.', 'error');
    return false;
  }
  
  try {
    const canUpdate = await ensureMonthEditable(
      String(updatedRecord.empNum || localStorage.getItem("employeeId") || ''),
      updatedRecord.date || updatedRecord.attendanceDate
    );
    if (!canUpdate) return false;
    
    showAlert('🔄 מעדכן רשומה...', 'info');
    
    // CRITICAL: For admin/manager edits, we MUST use the original record's employee data
    // Only fall back to localStorage for instructor editing their OWN records
    const isEditingOwnRecord = String(updatedRecord.empNum || updatedRecord.employeeId) === localStorage.getItem("employeeId");
    
    const payload = {
      action: 'updaterecord',
      recordId: String(recordId),
      employeeId: String(updatedRecord.empNum || updatedRecord.employeeId || (isEditingOwnRecord ? localStorage.getItem("employeeId") : '')),
      employeeName: String(updatedRecord.empName || updatedRecord.employeeName || (isEditingOwnRecord ? localStorage.getItem("employeeName") : '')),
      team: String(updatedRecord.team || (isEditingOwnRecord ? localStorage.getItem("team") : '')),
      employmentType: String(updatedRecord.employmentType || (isEditingOwnRecord ? localStorage.getItem("employmentType") : '')),
      attendanceDate: updatedRecord.date || updatedRecord.attendanceDate,
      startTime: updatedRecord.start || updatedRecord.startTime,
      endTime: updatedRecord.end || updatedRecord.endTime,
      workHours: Number(updatedRecord.hours || updatedRecord.workHours) || 0,
      activityType: updatedRecord.activity || updatedRecord.activityType,
      schoolName: updatedRecord.school || updatedRecord.schoolName,
      municipality: updatedRecord.municipality,
      programName: updatedRecord.program || updatedRecord.programName,
      kilometers: Number(updatedRecord.km || updatedRecord.kilometers) || 0,
      sessionNumber: Number(updatedRecord.session || updatedRecord.sessionNumber) || 0,
      totalExpenses: Number(updatedRecord.totalExpenses) || 0,
      expensesDetails: updatedRecord.expensesDetail || updatedRecord.expensesDetails || '',
      notes: updatedRecord.notes || '',
      status: updatedRecord.status || 'pending',
      attachmentsNames: updatedRecord.attachmentsNames || ''
    };
    
    const data = await apiRequest('updaterecord', payload);
    
    if (data.success) {
      showAlert('✅ הרשומה עודכנה בהצלחה', 'success');
      return true;
    } else {
      showAlert('❌ ' + (data.message || data.error || 'שגיאה בעדכון'), 'error');
      return false;
    }
  } catch (error) {
    console.error('Update record error:', error);
    showAlert('❌ שגיאה בעדכון רשומה: ' + (error.message || 'שגיאה לא ידועה'), 'error');
    return false;
  }
}

async function deleteRecordOnServer(record) {
  const recordId = record.recordId || record.id || record.ID;
  if (!recordId) {
    console.error('Cannot delete record: missing recordId');
    showAlert('שגיאה: חסר מזהה רשומה', 'error');
    return false;
  }
  
  try {
    const canDelete = await ensureMonthEditable(
      String(record.empNum || localStorage.getItem("employeeId") || ''),
      record.date || record.attendanceDate
    );
    if (!canDelete) return false;
    
    showLoadingBar();
    
    const payload = {
      action: 'deleterecord',
      recordId: String(recordId)
    };
    
    const data = await apiRequest('deleterecord', payload);
    hideLoadingBar();
    
    if (data.success) {
      showAlert('✅ הרשומה נמחקה בהצלחה', 'success');
      return true;
    } else {
      showAlert('❌ ' + (data.message || data.error || 'שגיאה במחיקה'), 'error');
      return false;
    }
  } catch (error) {
    hideLoadingBar();
    console.error('Delete record error:', error);
    showAlert('❌ שגיאה במחיקת רשומה: ' + (error.message || 'שגיאה לא ידועה'), 'error');
    return false;
  }
}

// =============== Login ===============
async function doLogin(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  
  const employeeId = document.getElementById('loginEmpNum').value.trim();
  const personalCode = document.getElementById('empCode').value.trim();
  const loginBtn = document.querySelector('#loginForm button[type="submit"]');
  const errorEl = document.getElementById('loginError');
  
  errorEl.classList.remove('show');
  
  if (!employeeId || !personalCode) {
    errorEl.textContent = 'נא להזין מספר עובד וקוד אישי';
    errorEl.classList.add('show');
    return false;
  }
  
  if (loginBtn) {
    loginBtn.disabled = true;
    loginBtn.textContent = 'מתחבר...';
  }
  
  try {
    // Use apiRequest with retry logic
    const data = await apiRequest('auth', {
      employeeId: employeeId,
      personalCode: personalCode
    });
    
    console.log('Login response:', JSON.stringify(data));
    
    if (data.success) {
      // Support both formats:
      // 1. New format: {success: true, employee: {...}}
      // 2. Old format: {success: true, employeeName: "...", role: "..."}
      
      let employeeFromServer;
      
      console.log('=== RAW AUTH RESPONSE ===');
      console.log('Full data object:', JSON.stringify(data, null, 2));
      
      if (data.employee) {
        // New format - already has employee object
        employeeFromServer = data.employee;
        console.log('Using new format (employee object)');
        console.log('data.employee keys:', Object.keys(data.employee));
      } else {
        // Old format - create employee object from flat response
        employeeFromServer = {
          employeeId: employeeId,
          EmployeeName: data.employeeName,
          role: data.role,
          Team: data.team,
          EmploymentType: data.employmentType
        };
        console.log('Using old format (flat structure)');
      }
      
      console.log('employeeFromServer:', JSON.stringify(employeeFromServer, null, 2));
      
      // Normalize employee data from server (PascalCase → frontend format)
      const emp = normalizeEmployeeFromServer(employeeFromServer);
      
      console.log('After normalize, emp:', emp);
      
      if (!emp || !emp.empName) {
        errorEl.textContent = 'שגיאה בעיבוד נתוני משתמש';
        errorEl.classList.add('show');
        return false;
      }
      
      currentUser = emp.empName;
      
      // Extract role from the correct location
      let rawRole;
      if (data.employee) {
        // New format - role is in data.employee.role
        rawRole = data.employee.role || employeeFromServer.role || 'instructor';
      } else {
        // Old format - role is in data.role
        rawRole = data.role || 'instructor';
      }
      
      // Handle SharePoint lookup format
      if (typeof rawRole === 'object' && rawRole !== null && rawRole.Value) {
        rawRole = rawRole.Value;
      }
      
      console.log('Raw role from server:', rawRole);
      console.log('Normalized employee:', emp);
      
      const empData = {
        empNum: employeeId,
        empName: emp.empName,
        role: normalizeRole(rawRole),
        team: emp.team,
        employmentType: emp.employmentType
      };
      
      console.log('Final empData:', empData);
      
      // Save to localStorage (as cache only)
      localStorage.setItem('currentUser', JSON.stringify(empData));
      localStorage.setItem('employeeName', emp.empName);
      localStorage.setItem('employeeId', employeeId);
      localStorage.setItem('role', empData.role);
      localStorage.setItem('employmentType', emp.employmentType || 'תעשיידע');
      console.log('Saved employmentType to localStorage:', emp.employmentType || 'תעשיידע');
      localStorage.setItem('team', emp.team);
      
      // Update UI
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      
      document.getElementById('userName').textContent = empData.empName;
      document.getElementById('userRole').textContent = getRoleDisplayName(empData.role);
      document.getElementById('userAvatar').textContent = empData.empName ? empData.empName.charAt(0) : 'ע';
      document.getElementById('mobileUserGreeting').textContent = 'שלום, ' + empData.empName;
      
      updateMenuByRole(empData.role);
      loadFromLocalStorage();
      
      // Reset filter session flags on new login
      const teamMonthFilter = document.getElementById('teamMonthFilter');
      const teamYearFilter = document.getElementById('teamYearFilter');
      if (teamMonthFilter) delete teamMonthFilter.dataset.sessionInit;
      if (teamYearFilter) delete teamYearFilter.dataset.sessionInit;
      
      // Brief success flash
      showAlert('התחברת בהצלחה!', 'success');
      setTimeout(() => {
        const alertBox = document.getElementById('alertBox');
        if (alertBox) alertBox.classList.remove('show');
      }, 1500);
      
      showLoadingBar();
      showPage(null, 'dashboard');
      await syncFromSharePoint(empData.empNum);
      hideLoadingBar();
      
      updateStats();
      initInactivityTimer();
    } else {
      errorEl.textContent = data.message || 'מספר עובד או קוד אישי שגויים';
      errorEl.classList.add('show');
    }
  } catch (error) {
    console.error('Login error:', error);
    errorEl.textContent = error.message || 'שגיאת תקשורת - נסה שוב';
    errorEl.classList.add('show');
  } finally {
    if (loginBtn) {
      loginBtn.disabled = false;
      loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> כניסה למערכת';
    }
  }
  
  return false;
}

function logout() {
  document.getElementById('logoutModal').style.display = 'flex';
}

function closeLogoutModal() {
  document.getElementById('logoutModal').style.display = 'none';
}

function confirmLogout() {
  closeLogoutModal();
  localStorage.removeItem('currentUser');
  localStorage.removeItem('employeeId');
  localStorage.removeItem('employeeName');
  currentUser = '';
  location.reload();
}

// =============== Inactivity Timeout (30 minutes) ===============
let inactivityTimer;
const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    showAlert('⏰ המערכת ננעלה עקב חוסר פעילות', 'info');
    setTimeout(() => {
      localStorage.removeItem('currentUser');
      currentUser = '';
      location.reload();
    }, 2000);
  }, INACTIVITY_TIMEOUT);
}

function initInactivityTimer() {
  // Reset timer on any user activity
  ['click', 'touchstart', 'keypress', 'scroll', 'mousemove'].forEach(event => {
    document.addEventListener(event, resetInactivityTimer, { passive: true });
  });
  resetInactivityTimer();
}

// Start inactivity timer when user is logged in and auto-load records
document.addEventListener('DOMContentLoaded', async () => {
  const savedUser = localStorage.getItem('currentUser');
  const employeeId = localStorage.getItem('employeeId');
  
  if (savedUser && employeeId) {
    initInactivityTimer();
    // Auto-load records from server on page load
    await loadMyRecordsFromServer();
  }
});

// =============== Mobile Menu ===============
function mobileNavTo(pageName) {
  showPage(null, pageName);
  updateMobileNavActive(pageName);
}

function updateMobileNavActive(pageName) {
  document.querySelectorAll('.mobile-nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  if (pageName === 'dashboard') {
    document.getElementById('mobileNavDashboard')?.classList.add('active');
  } else if (pageName === 'add-record') {
    document.getElementById('mobileNavAdd')?.classList.add('active');
  } else if (pageName === 'records') {
    document.getElementById('mobileNavRecords')?.classList.add('active');
  } else if (pageName === 'reports') {
    document.getElementById('mobileNavReports')?.classList.add('active');
  } else if (pageName === 'admin') {
    document.getElementById('mobileNavAdmin')?.classList.add('active');
  }
}

function isMobileView() {
  return window.matchMedia('(max-width: 768px)').matches;
}

// =============== Page Navigation ===============
function showPage(event, pageName) {
  // Handle both showPage(event, 'page') and showPage('page') calling patterns
  if (typeof event === 'string') {
    pageName = event;
    event = null;
  }
  
  if (event && typeof event.preventDefault === 'function') {
    event.preventDefault();
  }
  
  // Redirect deprecated pages to dashboard (approvals-status only)
  if (pageName === 'approvals-status') {
    pageName = 'dashboard';
  }
  
  // Role guard: non-instructors cannot access 'records' page, redirect to dashboard
  const role = localStorage.getItem("role") || '';
  if (pageName === 'records' && role !== 'instructor') {
    pageName = 'dashboard';
  }

  // Role guard: only instructors can access 'add-record' page
  if (pageName === 'add-record' && role !== 'instructor') {
    showAlert('❌ רק מדריכים יכולים להוסיף ימי עבודה', 'error');
    pageName = 'dashboard';
  }

  // Role guard: payroll_officer can access dashboard and reports only
  if (role === 'payroll_officer' && !['dashboard', 'reports'].includes(pageName)) {
    pageName = 'dashboard';
  }
  
  // Close mobile menu when navigating
if (typeof closeMobileMenu === 'function') {
  closeMobileMenu();
}

  
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  
  const pageMap = {
    'dashboard': 'dashboardPage',
    'add-record': 'addRecordPage',
    'records': 'recordsPage',
    'team-records': 'teamRecordsPage',
    'reports': 'reportsPage',
    'admin': 'adminPage'
  };
  
  const pageId = pageMap[pageName];
  if (pageId) {
    document.getElementById(pageId).classList.remove('hidden');
  }
  
  if (event && event.target.closest('.nav-item')) {
    event.target.closest('.nav-item').classList.add('active');
  }
  
  // Update mobile bottom nav
  updateMobileNavActive(pageName);
  
  if (pageName === 'dashboard') {
    updateDashboard();
    renderSummaryTable();
    loadInstructorMonthlyApprovalStatus();
  }
  if (pageName === 'records') loadRecordsForMonth();
  if (pageName === 'team-records') loadTeamRecords(true);
  if (pageName === 'reports') initReportsPage();
  if (pageName === 'add-record') {
    // Populate employee info in header
    const user = getCurrentUserData();
    if (user) {
      document.getElementById('displayEmpNum').textContent = user.empNum || '';
      document.getElementById('displayEmpName').textContent = user.empName || '';
    }
  }
}

// =============== Monthly Approvals Functions ===============
const GRACE_PERIOD_DAYS = 2; // Days at start of month to approve previous month (deadline: 2nd of each month)
let instructorApprovalInfo = null;
let previousMonthApprovalInfo = null;
const managerApprovalCache = new Map();

function getApprovalMonthKey(month, year) {
  const monthValue = String(month).padStart(2, '0');
  return `${year}-${monthValue}`;
}

function getCurrentWorkMonth() {
  const now = new Date();
  let month = now.getMonth() + 1;
  let year = now.getFullYear();
  if (now.getDate() >= 25) {
    month++;
    if (month > 12) {
      month = 1;
      year++;
    }
  }
  return { month, year };
}

function getApprovalMonthLabel(month, year) {
  const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
  return `חודש ${monthNames[Number(month) - 1]} ${year}`;
}

function formatApprovalDate(dateValue) {
  const date = new Date(dateValue);
  if (Number.isNaN(date.getTime())) return '—';
  return date.toLocaleDateString('he-IL');
}

async function fetchMonthStatus(employeeId, monthKey, team) {
  if (!isApprovalsSupported()) {
    return { approved: false, approvalDate: null, released: false, releaseDate: null };
  }
  try {
    const data = await apiRequest('getmonthlyapproval', {
      employeeId,
      monthKey: monthKey,
      team
    });
    if (data && data.success) {
      const approval = data.approval || {};
      return {
        approved: !!(approval.instructorApprovalDate),
        approvalDate: approval.instructorApprovalDate || null,
        released: !!(approval.released || approval.managerApprovalDate),
        releaseDate: approval.managerApprovalDate || null
      };
    }
  } catch (e) {
    console.warn('Error fetching approval status:', e);
  }
  return { approved: false, approvalDate: null, released: false, releaseDate: null };
}

function getMonthKeyFromDate(dateString) {
  if (!dateString) return null;
  const date = new Date(dateString);
  if (Number.isNaN(date.getTime())) return null;
  return getApprovalMonthKey(date.getMonth() + 1, date.getFullYear());
}

async function ensureMonthEditable(employeeId, dateString) {
  const monthKey = getMonthKeyFromDate(dateString);
  if (!monthKey) return true;
  const user = getCurrentUserData();
  const approvalStatus = await fetchMonthStatus(employeeId, monthKey, user?.team || '');
  if (approvalStatus.released && user?.role !== 'system_admin') {
    showAlert('הנוכחות החודשית אושרה. רק מנהל מערכת יכול לערוך.', 'error');
    return false;
  }
  if (approvalStatus.approved && ['instructor', 'payroll_officer'].includes(user?.role)) {
    showAlert('החודש אושר ואינו ניתן לעריכה.', 'error');
    return false;
  }
  return true;
}

function updateMonthlyApprovalVisibility() {
  const user = getCurrentUserData();
  const approvalContainer = document.getElementById('monthlyApprovalContainer');
  const instructorCard = document.getElementById('monthlyApprovalCard');
  const approvalsCard = document.getElementById('monthlyApprovalsCard');
  const resetButton = document.getElementById('resetMonthBtn');
  const unlockButton = document.getElementById('unlockMonthBtn');

  if (!user) {
    if (approvalContainer) approvalContainer.style.display = 'none';
    if (instructorCard) instructorCard.style.display = 'none';
    if (approvalsCard) approvalsCard.style.display = 'none';
    return;
  }

  // Show container with grid for instructors
  if (approvalContainer) {
    approvalContainer.style.display = user.role === 'instructor' ? 'grid' : 'none';
  }

  if (instructorCard) {
    instructorCard.style.display = user.role === 'instructor' ? 'block' : 'none';
  }

  if (approvalsCard) {
    approvalsCard.style.display = ['manager', 'system_admin', 'operations_controller'].includes(user.role) ? 'block' : 'none';
  }

  // Show approve monthly attendance button for managers and operations_controller
  const approveToPayrollBtn = document.getElementById('approveToPayrollBtn');
  if (approveToPayrollBtn) {
    approveToPayrollBtn.style.display = ['manager', 'operations_controller'].includes(user.role) ? 'inline-flex' : 'none';
  }

  // Show reset/unlock buttons for managers and admins
  if (resetButton) {
    resetButton.style.display = ['manager', 'system_admin', 'operations_controller'].includes(user.role) ? 'inline-flex' : 'none';
  }

  if (unlockButton) {
    unlockButton.style.display = user.role === 'system_admin' ? 'inline-flex' : 'none';
  }
}

async function loadInstructorMonthlyApprovalStatus() {
  const user = getCurrentUserData();
  const statusEl = document.getElementById('monthlyApprovalStatus');
  const buttonEl = document.getElementById('monthlyApprovalBtn');
  const monthLabel = document.getElementById('monthlyApprovalMonthLabel');
  const previousMonthCard = document.getElementById('previousMonthApprovalCard');
  const previousMonthLabel = document.getElementById('previousMonthApprovalMonthLabel');
  const previousMonthStatus = document.getElementById('previousMonthApprovalStatus');
  const previousMonthBtn = document.getElementById('previousMonthApprovalBtn');
  const gracePeriodDaysLeft = document.getElementById('gracePeriodDaysLeft');

  // Hide previous month card by default
  if (previousMonthCard) previousMonthCard.style.display = 'none';

  if (!statusEl || !buttonEl || !monthLabel) return;

  if (!isApprovalsSupported()) {
    statusEl.textContent = 'אישורים חודשיים אינם נתמכים כרגע';
    buttonEl.disabled = true;
    return;
  }

  if (!user || user.role !== 'instructor') {
    statusEl.textContent = 'סטטוס אישור לא זמין';
    buttonEl.disabled = true;
    return;
  }

  const now = new Date();
  const currentDay = now.getDate();
  const currentMonth = now.getMonth() + 1;
  const currentYear = now.getFullYear();
  const monthKey = getApprovalMonthKey(currentMonth, currentYear);
  const employeeId = String(user.empNum || localStorage.getItem('employeeId') || '');

  monthLabel.textContent = getApprovalMonthLabel(currentMonth, currentYear);

  const approvalStatus = await fetchMonthStatus(employeeId, monthKey, user.team || '');
  const approvalDate = approvalStatus.approvalDate || null;
  instructorApprovalInfo = { monthKey, approvalDate };

  // Handle current month status
  if (approvalStatus.released) {
    statusEl.textContent = `הנוכחות אושרה ב-${formatApprovalDate(approvalStatus.releaseDate)}`;
    buttonEl.disabled = true;
  } else if (approvalDate) {
    const approvalDateObj = new Date(approvalDate);
    const daysSinceApproval = Math.floor((now - approvalDateObj) / (1000 * 60 * 60 * 24));
    
    if (daysSinceApproval >= 20) {
      statusEl.textContent = 'ניתן לדווח על החודש החדש';
      buttonEl.disabled = false;
      buttonEl.style.background = '';
      buttonEl.style.opacity = '';
    } else {
      const daysRemaining = 20 - daysSinceApproval;
      statusEl.textContent = `אושר בתאריך ${formatApprovalDate(approvalDate)} (ממתין לאישור מנהל)`;
      buttonEl.disabled = true;
      buttonEl.style.background = '#94a3b8';
      buttonEl.style.opacity = '0.7';
    }
  } else {
    statusEl.textContent = 'טרם אושר החודש';
    buttonEl.disabled = false;
    buttonEl.style.background = '';
    buttonEl.style.opacity = '';
  }

  // Check grace period for previous month
  if (currentDay <= GRACE_PERIOD_DAYS && previousMonthCard) {
    // Calculate previous month
    let prevMonth = currentMonth - 1;
    let prevYear = currentYear;
    if (prevMonth === 0) {
      prevMonth = 12;
      prevYear = currentYear - 1;
    }
    const prevMonthKey = getApprovalMonthKey(prevMonth, prevYear);
    
    // Check if previous month was already approved
    const prevApprovalStatus = await fetchMonthStatus(employeeId, prevMonthKey, user.team || '');
    previousMonthApprovalInfo = { monthKey: prevMonthKey, month: prevMonth, year: prevYear };
    
    if (!prevApprovalStatus.approvalDate && !prevApprovalStatus.released) {
      // Previous month not approved - show grace period card
      previousMonthCard.style.display = 'block';
      if (previousMonthLabel) {
        previousMonthLabel.textContent = getApprovalMonthLabel(prevMonth, prevYear);
      }
      const daysLeft = GRACE_PERIOD_DAYS - currentDay + 1;
      if (gracePeriodDaysLeft) {
        gracePeriodDaysLeft.textContent = `נותרו ${daysLeft} ימים לאישור`;
      }
      if (previousMonthBtn) {
        previousMonthBtn.disabled = false;
      }
    }
  }
}

async function approveMonthlyReport(whichMonth = 'current') {
  const user = getCurrentUserData();
  if (!isApprovalsSupported()) {
    showAlert('⚠️ אישורים חודשיים אינם נתמכים ב-API הנוכחי', 'error');
    return;
  }
  if (!user || user.role !== 'instructor') {
    showAlert('אין הרשאה לבצע אישור חודשי', 'error');
    return;
  }

  const now = new Date();
  let monthKey, yearValue;
  
  if (whichMonth === 'previous' && previousMonthApprovalInfo) {
    // Approve previous month (grace period)
    monthKey = previousMonthApprovalInfo.monthKey;
    yearValue = String(previousMonthApprovalInfo.year);
  } else {
    // Approve current month
    monthKey = getApprovalMonthKey(now.getMonth() + 1, now.getFullYear());
    yearValue = String(now.getFullYear());
  }

  const status = await fetchMonthStatus(String(user.empNum || localStorage.getItem('employeeId') || ''), monthKey, user.team || '');
  if (status.released) {
    showAlert('הנוכחות החודשית אושרה ונעולה לקריאה בלבד', 'error');
    return;
  }

  // Disable the appropriate button
  const buttonEl = whichMonth === 'previous' 
    ? document.getElementById('previousMonthApprovalBtn')
    : document.getElementById('monthlyApprovalBtn');
  if (buttonEl) {
    buttonEl.disabled = true;
  }

  const employeeId = String(user.empNum || localStorage.getItem('employeeId') || '');
  showLoadingBar();
  try {
    const data = await apiRequest('setinstructorapproval', {
      employeeId,
      employeeName: user.empName || '',
      monthKey: monthKey,
      team: user.team || ''
    });
    hideLoadingBar();
    if (data.success) {
      showAlert('האישור החודשי נשמר בהצלחה', 'success');
      await loadInstructorMonthlyApprovalStatus();
    } else {
      showAlert(data.message || 'שגיאה בשמירת אישור חודשי', 'error');
    }
  } catch (error) {
    hideLoadingBar();
    showAlert(error.message || 'שגיאה בשמירת אישור חודשי', 'error');
  }

  if (buttonEl) {
    buttonEl.disabled = false;
  }
}

async function loadMonthlyApprovalsTable() {
  const user = getCurrentUserData();
  const container = document.getElementById('monthlyApprovalsTable');

  if (!container) return;
  if (!isApprovalsSupported()) {
    container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 30px;">אישורים חודשיים אינם נתמכים כרגע</p>';
    return;
  }
  if (!user || !['manager', 'system_admin', 'operations_controller'].includes(user.role)) {
    container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 30px;">אין הרשאה לצפייה בסטטוס אישורים</p>';
    return;
  }
  
  const isMobile = isMobileView();

  const monthSelect = document.getElementById('teamMonthFilter');
  const yearSelect = document.getElementById('teamYearFilter');
  const month = monthSelect ? Number(monthSelect.value) : (new Date().getMonth() + 1);
  const year = yearSelect ? Number(yearSelect.value) : new Date().getFullYear();
  const monthKey = getApprovalMonthKey(month, year);
  const team = user.role === 'manager' ? (user.team || '') : 'all';

  let approvalsData = [];
  try {
    const data = await apiRequest('getTeamApprovalStatus', {
      team,
      month: monthKey
    });
    approvalsData = Array.isArray(data.employees) ? data.employees : [];
  } catch (error) {
    console.error('Error loading approval status:', error);
  }

  // Remove duplicates by employeeId (convert to string to handle number/string mismatches)
  const seenIds = new Set();
  approvalsData = approvalsData.filter(emp => {
    const id = String(emp.employeeId || emp.id || '');
    if (!id || seenIds.has(id)) return false;
    seenIds.add(id);
    return true;
  });
  console.log('loadMonthlyApprovalsTable: After duplicate removal:', approvalsData.length, 'employees');

  // For managers - filter to their team first (client-side fallback)
  let teamFilteredData = approvalsData;
  if (user.role === 'manager' && user.team) {
    const managerTeam = user.team.trim().toLowerCase();
    teamFilteredData = approvalsData.filter(emp => {
      const empTeam = (emp.team || '').trim().toLowerCase();
      return empTeam === managerTeam;
    });
    console.log('Manager team filter applied:', user.team, '- Found:', teamFilteredData.length, 'employees');
  }
  
  // Filter only instructors (if role info available)
  const instructorsOnly = teamFilteredData.filter(emp => {
    let roleStr = emp.role || '';
    if (typeof roleStr !== 'string') roleStr = String(roleStr);
    const empRole = roleStr.toLowerCase().replace(/\s+/g, '_');
    // Include if role is instructor or not specified (for backwards compatibility)
    return !emp.role || empRole === 'instructor' || empRole === 'מדריך' || empRole === 'מדריכה';
  });

  if (instructorsOnly.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 30px;">אין מדריכים להצגה</p>';
    return;
  }

  // Group by team for all roles
  const byTeam = {};
  instructorsOnly.forEach(emp => {
    const teamName = emp.team || 'ללא צוות';
    if (!byTeam[teamName]) byTeam[teamName] = [];
    byTeam[teamName].push(emp);
  });

  let html = '';
  Object.keys(byTeam).sort().forEach(teamName => {
    const teamEmps = byTeam[teamName];
    const approvedCount = teamEmps.filter(e => e.approvalDate).length;
    
    html += `
      <div style="margin-bottom: 20px;">
        <h4 style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
          <i class="fas fa-users"></i>${teamName}
          <span style="margin-right: auto; background: ${approvedCount === teamEmps.length ? '#22c55e' : '#fbbf24'}; padding: 2px 8px; border-radius: 12px; font-size: 12px; color: ${approvedCount === teamEmps.length ? 'white' : '#78350f'};">
            ${approvedCount}/${teamEmps.length} סיימו דיווח
          </span>
        </h4>
    `;
    
    if (isMobile) {
      // Mobile: Card view
      const cards = teamEmps.map(emp => {
        const approvalDate = emp.approvalDate || null;
        const isReleased = emp.released || false;
        const formattedDate = approvalDate ? new Date(approvalDate).toLocaleDateString('he-IL') : '';
        
        return `
          <div style="background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <strong style="color: #1e293b;">${emp.name || emp.employeeName || '—'}</strong>
              <span style="font-size: 11px; color: #64748b;">#${emp.employeeId || '—'}</span>
            </div>
            <div style="display: flex; gap: 8px;">
              <div style="flex: 1; background: ${approvalDate ? '#dcfce7' : '#fef3c7'}; padding: 6px 10px; border-radius: 6px; text-align: center;">
                <div style="font-size: 10px; color: ${approvalDate ? '#166534' : '#92400e'};">מדריך</div>
                <div style="font-size: 12px; font-weight: 600; color: ${approvalDate ? '#166534' : '#92400e'};">
                  <i class="fas ${approvalDate ? 'fa-check' : 'fa-clock'}"></i> ${approvalDate ? formattedDate : 'ממתין'}
                </div>
              </div>
              <div style="flex: 1; background: ${isReleased ? '#dcfce7' : '#f1f5f9'}; padding: 6px 10px; border-radius: 6px; text-align: center;">
                <div style="font-size: 10px; color: ${isReleased ? '#166534' : '#64748b'};">מנהל</div>
                <div style="font-size: 12px; font-weight: 600; color: ${isReleased ? '#166534' : '#64748b'};">
                  <i class="fas ${isReleased ? 'fa-check' : 'fa-minus'}"></i> ${isReleased ? 'אושר' : '—'}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      html += `<div>${cards}</div></div>`;
    } else {
      // Desktop: Table view
      const rows = teamEmps.map(emp => {
        const approvalDate = emp.approvalDate || null;
        const isReleased = emp.released || false;
        return `
          <tr>
            <td>${emp.name || emp.employeeName || '—'}</td>
            <td>${emp.employeeId || '—'}</td>
            <td style="font-weight: 600; color: ${approvalDate ? '#16a34a' : '#f97316'};">${approvalDate ? '✓ סיום דיווח' : '⏳ ממתין'}</td>
            <td style="font-weight: 600; color: ${isReleased ? '#16a34a' : '#94a3b8'};">${isReleased ? '✓ אושר' : '—'}</td>
          </tr>
        `;
      }).join('');

      html += `
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>שם עובד</th>
                <th>מספר עובד</th>
                <th>סיום דיווח</th>
                <th>אישור מנהל</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
      `;
    }
  });
  container.innerHTML = html;
}

// Load Approvals Status Page (Admin only - shows both approval statuses)
async function loadApprovalsStatusPage() {
  const user = getCurrentUserData();
  // Support both the old approvalsStatusTable and new dashboardApprovalsContent
  const container = document.getElementById('approvalsStatusTable') || document.getElementById('dashboardApprovalsContent');
  const dashboardContainer = document.getElementById('dashboardApprovalsContent');

  if (!container) return;
  if (!user || !['manager', 'operations_controller', 'payroll_officer', 'system_admin'].includes(user.role)) {
    container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 30px;">עמוד זה זמין למנהלים ומנהלי מערכת בלבד</p>';
    if (dashboardContainer && dashboardContainer !== container) dashboardContainer.innerHTML = container.innerHTML;
    return;
  }

  // Use dashboardMonth/Year if available, fallback to approvalsMonthFilter
  const monthSelect = document.getElementById('dashboardMonth') || document.getElementById('approvalsMonthFilter');
  const yearSelect = document.getElementById('dashboardYear') || document.getElementById('approvalsYearFilter');
  const month = monthSelect ? Number(monthSelect.value) : (new Date().getMonth() + 1);
  const year = yearSelect ? Number(yearSelect.value) : new Date().getFullYear();
  const monthKey = getApprovalMonthKey(month, year);

  // Silent loading - keep existing content visible, dim slightly
  const hasContent = container.innerHTML.trim() && !container.innerHTML.includes('אין מדריכים');
  if (hasContent) {
    setSilentLoading(container.id, true);
    if (dashboardContainer && dashboardContainer !== container) setSilentLoading(dashboardContainer.id, true);
  } else {
    container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 30px;">טוען נתונים...</p>';
    if (dashboardContainer && dashboardContainer !== container) dashboardContainer.innerHTML = container.innerHTML;
  }
  showLoadingBar();

  let approvalsData = [];
  try {
    // Manager sees only their team, others see all
    const teamFilter = user.role === 'manager' ? (user.team || 'all') : 'all';
    const data = await apiRequest('getteamapprovalstatus', {
      team: teamFilter,
      monthKey: monthKey
    });
    approvalsData = Array.isArray(data.employees) ? data.employees : [];
  } catch (error) {
    console.error('Error loading approval status:', error);
    hideLoadingBar();
    setSilentLoading(container.id, false);
    if (dashboardContainer && dashboardContainer !== container) setSilentLoading(dashboardContainer.id, false);
    if (!hasContent) {
      container.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 30px;">שגיאה בטעינת הנתונים</p>';
      if (dashboardContainer && dashboardContainer !== container) dashboardContainer.innerHTML = container.innerHTML;
    }
    return;
  }

  try {

  // Build employment type lookup from teamRecordsCache (which has the data)
  const employmentTypeLookup = {};
  if (typeof teamRecordsCache !== 'undefined' && Array.isArray(teamRecordsCache)) {
    teamRecordsCache.forEach(rec => {
      const empId = String(rec.employeeId || rec.empNum || '').trim();
      if (empId && !employmentTypeLookup[empId]) {
        employmentTypeLookup[empId] = normalizeEmploymentType(rec, '');
      }
    });
  }
  console.log('Employment type lookup built from teamRecordsCache:', Object.keys(employmentTypeLookup).length, 'entries');
  
  // Remove duplicates by employeeId - use Map to aggregate data per employee
  console.log('loadApprovalsStatusPage: Raw data from API:', approvalsData.length, 'records');
  const employeeMap = new Map();
  
  // Helper to parse date strings to Date objects for comparison
  const parseDate = (dateStr) => {
    if (!dateStr) return null;
    const d = new Date(dateStr);
    return isNaN(d.getTime()) ? null : d;
  };
  
  approvalsData.forEach(emp => {
    // Normalize employeeId to string and trim any whitespace
    const rawId = emp.employeeId || emp.id || '';
    const id = String(rawId).trim();
    if (!id) return;
    
    // If employee already seen, merge approval info (keep most recent approval dates)
    if (employeeMap.has(id)) {
      const existing = employeeMap.get(id);
      
      // Keep latest instructor approval date (compare as Date)
      const existingInstDate = parseDate(existing.instructorApprovalDate);
      const newInstDate = parseDate(emp.instructorApprovalDate);
      if (newInstDate && (!existingInstDate || newInstDate > existingInstDate)) {
        existing.instructorApprovalDate = emp.instructorApprovalDate;
      }
      
      // Keep latest manager approval date (compare as Date)
      const existingMgrDate = parseDate(existing.managerApprovalDate);
      const newMgrDate = parseDate(emp.managerApprovalDate);
      if (newMgrDate && (!existingMgrDate || newMgrDate > existingMgrDate)) {
        existing.managerApprovalDate = emp.managerApprovalDate;
      }
      
      // Keep released status if true
      if (emp.released) existing.released = true;
      
      // Keep non-empty values for other fields
      if (!existing.employeeName && emp.employeeName) existing.employeeName = emp.employeeName;
      if (!existing.team && emp.team) existing.team = emp.team;
      if (!existing.employmentType && emp.employmentType) existing.employmentType = emp.employmentType;
    } else {
      // First occurrence - add to map
      // Enrich with employmentType from lookup if missing
      const enrichedEmp = {
        ...emp,
        employeeId: id, // Ensure normalized ID
        employmentType: emp.employmentType || employmentTypeLookup[id] || ''
      };
      employeeMap.set(id, enrichedEmp);
    }
  });
  approvalsData = Array.from(employeeMap.values());
  console.log('loadApprovalsStatusPage: After duplicate removal:', approvalsData.length, 'unique employees');

  // Populate manager approval cache for month locking
  approvalsData.forEach(emp => {
    const empId = String(emp.employeeId || '').trim();
    if (empId && monthKey) {
      const cacheKey = `${empId}-${monthKey}`;
      managerApprovalCache.set(cacheKey, !!(emp.managerApprovalDate || emp.released));
    }
  });

  // Client-side team filter for managers (backup if server doesn't filter)
  if (user.role === 'manager' && user.team) {
    const managerTeam = user.team.trim().toLowerCase();
    approvalsData = approvalsData.filter(emp => {
      const empTeam = (emp.team || '').trim().toLowerCase();
      return empTeam === managerTeam;
    });
    console.log('Manager team filter applied:', user.team, '- Found:', approvalsData.length, 'employees');
  }

  // Filter only instructors
  const instructorsOnly = approvalsData.filter(emp => {
    let roleStr = emp.role || '';
    if (typeof roleStr !== 'string') roleStr = String(roleStr);
    const empRole = roleStr.toLowerCase().replace(/\s+/g, '_');
    return !emp.role || empRole === 'instructor' || empRole === 'מדריך' || empRole === 'מדריכה';
  });

  if (instructorsOnly.length === 0) {
    hideLoadingBar();
    setSilentLoading(container.id, false);
    if (dashboardContainer && dashboardContainer !== container) setSilentLoading(dashboardContainer.id, false);
    container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 30px;">אין מדריכים להצגה</p>';
    if (dashboardContainer && dashboardContainer !== container) dashboardContainer.innerHTML = container.innerHTML;
    return;
  }

  // Group by team
  const byTeam = {};
  instructorsOnly.forEach(emp => {
    const teamName = emp.team || 'ללא צוות';
    if (!byTeam[teamName]) byTeam[teamName] = [];
    byTeam[teamName].push(emp);
  });

  const isMobile = window.innerWidth <= 768;
  let html = '';
  
  Object.keys(byTeam).sort().forEach(teamName => {
    const teamEmps = byTeam[teamName];
    
    // Summary counts
    const approvedCount = teamEmps.filter(e => e.instructorApprovalDate || e.approvalDate).length;
    const releasedCount = teamEmps.filter(e => e.released).length;
    
    html += `
      <div style="margin-bottom: 25px;">
        <h4 style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; padding: 12px 18px; border-radius: 10px; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
          <i class="fas fa-users"></i>${teamName}
          <span style="margin-right: auto; background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 15px; font-size: 13px;">${teamEmps.length} מדריכים</span>
          <span style="background: ${approvedCount === teamEmps.length ? '#22c55e' : '#fbbf24'}; padding: 3px 10px; border-radius: 15px; font-size: 12px; color: ${approvedCount === teamEmps.length ? 'white' : '#78350f'};">
            ${approvedCount}/${teamEmps.length} סיימו דיווח
          </span>
        </h4>
    `;
    
    if (isMobile) {
      // Mobile: Card view
      const cards = teamEmps.map(emp => {
        const approvalDate = emp.instructorApprovalDate || emp.approvalDate || null;
        const managerApproved = emp.managerApprovalDate || emp.released || false;
        const formattedApprovalDate = approvalDate ? new Date(approvalDate).toLocaleDateString('he-IL') : '';
        const formattedManagerDate = emp.managerApprovalDate ? new Date(emp.managerApprovalDate).toLocaleDateString('he-IL') : '';
        
        let secondColumnHtml = '';
        if (user.role === 'manager') {
          if (managerApproved) {
            secondColumnHtml = `
              <div style="flex: 1; min-width: 120px; background: #dcfce7; padding: 8px 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 11px; color: #166534; margin-bottom: 3px;">אישור חודש</div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: 600; color: #166534;">
                  <i class="fas fa-check-circle"></i> אושר
                </div>
              </div>`;
          } else if (approvalDate) {
            secondColumnHtml = `
              <div style="flex: 1; min-width: 120px; background: #f1f5f9; padding: 8px 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 11px; color: #64748b; margin-bottom: 3px;">אישור חודש</div>
                <button onclick="approveMonthForEmployee('${emp.employeeId}', '${monthKey}', '${teamName}', '${(emp.employeeName || '').replace(/'/g, "\\'")}')" 
                  style="background: #3b82f6; color: white; border: none; padding: 6px 14px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; width: auto;"
                  data-testid="btn-approve-month-mobile-${emp.employeeId}">
                  <i class="fas fa-check-double"></i> אישור חודש
                </button>
              </div>`;
          } else {
            secondColumnHtml = `
              <div style="flex: 1; min-width: 120px; background: #f1f5f9; padding: 8px 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 11px; color: #64748b; margin-bottom: 3px;">אישור חודש</div>
                <span style="font-size: 12px; color: #94a3b8;">ממתין לדיווח</span>
              </div>`;
          }
        } else {
          secondColumnHtml = `
            <div style="flex: 1; min-width: 120px; background: ${managerApproved ? '#dcfce7' : '#f1f5f9'}; padding: 8px 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; color: ${managerApproved ? '#166534' : '#64748b'}; margin-bottom: 3px;">אישור מנהל</div>
              <div style="display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: 600; color: ${managerApproved ? '#166534' : '#94a3b8'};">
                <i class="fas ${managerApproved ? 'fa-check-circle' : 'fa-clock'}"></i>
                ${managerApproved ? (formattedManagerDate || 'אושר') : 'ממתין'}
              </div>
            </div>`;
        }
        
        return `
          <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <strong style="font-size: 16px; color: #1e293b;">${emp.name || emp.employeeName || '—'}</strong>
              <span style="font-size: 12px; color: #64748b;">#${emp.employeeId || '—'}</span>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 120px; background: ${approvalDate ? '#dcfce7' : '#fef3c7'}; padding: 8px 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 11px; color: ${approvalDate ? '#166534' : '#92400e'}; margin-bottom: 3px;">אישור מדריך</div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: 600; color: ${approvalDate ? '#166534' : '#92400e'};">
                  <i class="fas ${approvalDate ? 'fa-check-circle' : 'fa-clock'}"></i>
                  ${approvalDate ? formattedApprovalDate : 'ממתין'}
                </div>
                ${(approvalDate && user.role === 'system_admin') ? `
                <button onclick="cancelInstructorApproval('${emp.employeeId}', '${emp.name || emp.employeeName || ''}', '${monthKey}')"
                  style="background: #ef4444; color: white; border: none; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; margin-top: 5px;"
                  data-testid="btn-cancel-approval-mobile-${emp.employeeId}">
                  <i class="fas fa-undo"></i> ביטול אישור
                </button>` : ''}
              </div>
              ${secondColumnHtml}
            </div>
          </div>
        `;
      }).join('');
      
      html += `<div>${cards}</div>`;
    } else {
      // Desktop: Table view
      const secondColumnHeader = user.role === 'manager' ? 'אישור חודש' : 'אישור מנהל';
      const rows = teamEmps.map(emp => {
        const approvalDate = emp.instructorApprovalDate || emp.approvalDate || null;
        const managerApproved = emp.managerApprovalDate || emp.released || false;
        const formattedApprovalDate = approvalDate ? new Date(approvalDate).toLocaleDateString('he-IL') : '';
        const formattedManagerDate = emp.managerApprovalDate ? new Date(emp.managerApprovalDate).toLocaleDateString('he-IL') : '';
        
        let secondColumnHtml = '';
        if (user.role === 'manager') {
          if (managerApproved) {
            secondColumnHtml = `
              <span style="display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 13px; font-weight: 600; background: #dcfce7; color: #166534;">
                <i class="fas fa-check-circle"></i> אושר
              </span>`;
          } else if (approvalDate) {
            secondColumnHtml = `
              <button onclick="approveMonthForEmployee('${emp.employeeId}', '${monthKey}', '${teamName}', '${(emp.employeeName || '').replace(/'/g, "\\'")}')" 
                style="background: #3b82f6; color: white; border: none; padding: 6px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; width: auto;"
                data-testid="btn-approve-month-${emp.employeeId}">
                <i class="fas fa-check-double"></i> אישור חודש
              </button>`;
          } else {
            secondColumnHtml = `<span style="color: #94a3b8; font-size: 12px;">ממתין לדיווח</span>`;
          }
        } else {
          if (managerApproved) {
            secondColumnHtml = `
              <span style="display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 13px; font-weight: 600; background: #dcfce7; color: #166534;">
                <i class="fas fa-check-circle"></i> ${formattedManagerDate || 'אושר'}
              </span>`;
          } else {
            secondColumnHtml = `
              <span style="display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 13px; font-weight: 600; background: #f1f5f9; color: #94a3b8;">
                <i class="fas fa-clock"></i> ממתין
              </span>`;
          }
        }
        
        return `
          <tr>
            <td>${emp.name || emp.employeeName || '—'}</td>
            <td>${emp.employeeId || '—'}</td>
            <td style="text-align: center;">
              <div style="display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: wrap;">
                <span style="display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 13px; font-weight: 600; background: ${approvalDate ? '#dcfce7' : '#fef3c7'}; color: ${approvalDate ? '#166534' : '#92400e'};">
                  <i class="fas ${approvalDate ? 'fa-check-circle' : 'fa-clock'}"></i>
                  ${approvalDate ? formattedApprovalDate : 'ממתין'}
                </span>
                ${(approvalDate && user.role === 'system_admin') ? `
                <button onclick="cancelInstructorApproval('${emp.employeeId}', '${emp.name || emp.employeeName || ''}', '${monthKey}')"
                  style="background: #ef4444; color: white; border: none; padding: 3px 8px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;"
                  title="ביטול אישור מדריך"
                  data-testid="btn-cancel-approval-${emp.employeeId}">
                  <i class="fas fa-undo"></i> ביטול
                </button>` : ''}
              </div>
            </td>
            <td style="text-align: center;">
              ${secondColumnHtml}
            </td>
          </tr>
        `;
      }).join('');

      html += `
        <div style="overflow-x: auto; border-radius: 10px; border: 1px solid #e2e8f0;">
          <table style="margin: 0;">
            <thead>
              <tr style="background: #f8fafc;">
                <th style="padding: 12px 15px;">שם עובד</th>
                <th style="padding: 12px 15px;">מספר עובד</th>
                <th style="padding: 12px 15px; text-align: center;">אישור מדריך</th>
                <th style="padding: 12px 15px; text-align: center;">${secondColumnHeader}</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }
    
    html += '</div>';
  });

  hideLoadingBar();
  setSilentLoading(container.id, false);
  container.innerHTML = html;
  // Also update dashboard container if different
  if (dashboardContainer && dashboardContainer !== container) {
    setSilentLoading(dashboardContainer.id, false);
    dashboardContainer.innerHTML = html;
  }

  } catch (renderError) {
    console.error('Error rendering approvals:', renderError);
    hideLoadingBar();
    setSilentLoading(container.id, false);
    if (dashboardContainer && dashboardContainer !== container) setSilentLoading(dashboardContainer.id, false);
  }
}

// Toggle manager approval for an employee's monthly report
async function approveMonthForEmployee(employeeId, monthKey, teamName, employeeName) {
  const user = getCurrentUserData();
  if (!user || !['manager', 'operations_controller', 'system_admin'].includes(user.role)) {
    showAlert('אין הרשאה לאשר חודש', 'error');
    return;
  }
  
  if (!employeeId) {
    showAlert('לא נמצא מדריך לאישור', 'error');
    return;
  }
  
  const displayName = employeeName || employeeId;
  if (!confirm(`האם לאשר את החודש ${monthKey} עבור ${displayName}?`)) {
    return;
  }
  
  showLoadingBar();
  try {
    const payload = {
      action: 'setmanagerapproval',
      employeeId: String(employeeId),
      monthKey: monthKey
    };
    
    const data = await apiRequest('setmanagerapproval', payload);
    
    if (data.success) {
      hideLoadingBar();
      showAlert(`החודש אושר בהצלחה עבור ${displayName}!`, 'success');
      loadApprovalsStatusPage();
    } else {
      throw new Error(data.message || 'שגיאה באישור');
    }
  } catch (error) {
    hideLoadingBar();
    console.error('Error approving month:', error);
    showAlert('שגיאה: ' + (error.message || 'לא ניתן לאשר חודש'), 'error');
  }
}

async function cancelInstructorApproval(employeeId, employeeName, monthKey) {
  const user = getCurrentUserData();
  if (!user || user.role !== 'system_admin') {
    showAlert('רק מנהל מערכת יכול לבטל אישור מדריך', 'error');
    return;
  }
  
  if (!confirm(`האם לבטל את אישור המדריך של ${employeeName || employeeId} לחודש ${monthKey}?\n\nהמדריך יצטרך לאשר מחדש.`)) {
    return;
  }
  
  showLoadingBar();
  try {
    const data = await apiRequest('cancelinstructorapproval', {
      employeeId: String(employeeId),
      monthKey: monthKey
    });
    hideLoadingBar();
    if (data.success) {
      showAlert(`אישור המדריך של ${employeeName || employeeId} בוטל בהצלחה`, 'success');
      loadApprovalsStatusPage();
    } else {
      showAlert(data.message || data.error || 'שגיאה בביטול אישור', 'error');
    }
  } catch (error) {
    hideLoadingBar();
    console.error('Error canceling instructor approval:', error);
    showAlert('שגיאה: ' + (error.message || 'לא ניתן לבטל אישור'), 'error');
  }
}

// Approve monthly attendance - internal approval by manager
async function approveMonthToPayroll() {
  const user = getCurrentUserData();
  if (!user || !['manager', 'operations_controller'].includes(user.role)) {
    showAlert('אין הרשאה לאישור נוכחות חודשית', 'error');
    return;
  }
  
  if (!confirm('האם לאשר את הנוכחות החודשית?\n\nלאחר האישור, רק מנהל מערכת יוכל לבצע שינויים.')) {
    return;
  }
  
  const now = new Date();
  const monthKey = getApprovalMonthKey(now.getMonth() + 1, now.getFullYear());
  const team = user.role === 'manager' ? (user.team || '') : 'all';
  
  showLoadingBar();
  try {
    const response = await fetch(LOGIC_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'setmanagerapproval',
        monthKey: monthKey,
        team: team,
        approvedBy: user.empName || user.empNum,
        approvedByRole: user.role
      })
    });
    
    const data = await response.json();
    hideLoadingBar();
    if (data.success) {
      showAlert('הנוכחות החודשית אושרה בהצלחה!', 'success');
      await loadMonthlyApprovalsTable();
    } else {
      showAlert(data.message || 'שגיאה באישור הדיווח', 'error');
    }
  } catch (error) {
    hideLoadingBar();
    showAlert('שגיאה באישור הדיווח: ' + error.message, 'error');
  }
}

async function resetTeamMonth() {
  const user = getCurrentUserData();
  if (!isApprovalsSupported()) {
    showAlert('איפוס חודש אינו נתמך ב-API הנוכחי', 'error');
    return;
  }
  if (!user || !['manager', 'system_admin', 'operations_controller'].includes(user.role)) {
    showAlert('אין הרשאה לאיפוס חודש', 'error');
    return;
  }

  const monthSelect = document.getElementById('teamMonthFilter');
  const yearSelect = document.getElementById('teamYearFilter');
  const month = monthSelect ? Number(monthSelect.value) : (new Date().getMonth() + 1);
  const year = yearSelect ? Number(yearSelect.value) : new Date().getFullYear();
  const monthKey = getApprovalMonthKey(month, year);
  const team = user.role === 'manager' ? (user.team || '') : 'all';

  try {
    const data = await apiRequest('resetTeamMonth', {
      team,
      month: monthKey,
      year: String(year),
      mode: 'release',
      employeeId: user.empNum || localStorage.getItem('employeeId')
    });
    if (data.success) {
      showAlert('החודש אופס בהצלחה', 'success');
      await loadMonthlyApprovalsTable();
    } else {
      showAlert(data.message || 'שגיאה באיפוס חודש', 'error');
    }
  } catch (error) {
    showAlert(error.message || 'שגיאה באיפוס חודש', 'error');
  }
}

async function unlockTeamMonth() {
  const user = getCurrentUserData();
  if (!isApprovalsSupported()) {
    showAlert('⚠️ פתיחת חודש אינה נתמכת ב-API הנוכחי', 'error');
    return;
  }
  if (!user || user.role !== 'system_admin') {
    showAlert('אין הרשאה לפתיחת חודש', 'error');
    return;
  }

  if (!confirm('פתיחת חודש תאפשר עריכה מחדש לכל הרשומות. להמשיך?')) return;

  const monthSelect = document.getElementById('teamMonthFilter');
  const yearSelect = document.getElementById('teamYearFilter');
  const month = monthSelect ? Number(monthSelect.value) : (new Date().getMonth() + 1);
  const year = yearSelect ? Number(yearSelect.value) : new Date().getFullYear();
  const monthKey = getApprovalMonthKey(month, year);
  const team = 'all';

  try {
    const data = await apiRequest('resetTeamMonth', {
      team,
      month: monthKey,
      year: String(year),
      mode: 'unlock',
      employeeId: user.empNum || localStorage.getItem('employeeId')
    });
    if (data.success) {
      showAlert('החודש נפתח מחדש בהצלחה', 'success');
      await loadMonthlyApprovalsTable();
    } else {
      showAlert(data.message || 'שגיאה בפתיחת חודש', 'error');
    }
  } catch (error) {
    showAlert(error.message || 'שגיאה בפתיחת חודש', 'error');
  }
}

// =============== Team Records Functions ===============
let teamRecordsCache = [];
async function loadTeamRecords(resetFilters = false) {
  const user = getCurrentUserData();
  if (!user) return;

  const now = new Date();
  const monthSelect = document.getElementById('teamMonthFilter');
  const yearSelect = document.getElementById('teamYearFilter');
  const teamFilterSelect = document.getElementById('teamRecordsTeamFilter');

  // Show team filter for admin and operations_controller
  if (teamFilterSelect) {
    if (user.role === 'system_admin' || user.role === 'operations_controller') {
      teamFilterSelect.style.display = 'block';
    } else {
      teamFilterSelect.style.display = 'none';
    }
  }

  // Reset to appropriate month/year on fresh page load or when explicitly requested
  // Default to current work month (cycle resets on the 25th)
  if (resetFilters || !monthSelect?.dataset.sessionInit) {
    const workMonth = getCurrentWorkMonth();
    let defaultMonth = workMonth.month;
    let defaultYear = workMonth.year;
    
    // In first days of month (before grace period ends), show previous month
    if (now.getDate() <= GRACE_PERIOD_DAYS && now.getDate() < 25) {
      defaultMonth = now.getMonth(); // getMonth() returns 0-11, so this gives previous month
      if (defaultMonth === 0) {
        defaultMonth = 12;
        defaultYear = now.getFullYear() - 1;
      }
    }
    
    if (monthSelect) {
      monthSelect.value = defaultMonth;
      monthSelect.dataset.sessionInit = 'true';
    }
    if (yearSelect) {
      yearSelect.value = defaultYear;
      yearSelect.dataset.sessionInit = 'true';
    }
  }

  const selectedMonth = monthSelect ? parseInt(monthSelect.value) : now.getMonth() + 1;
  const selectedYear = yearSelect ? parseInt(yearSelect.value) : now.getFullYear();

  // Get selected team filter value
  const selectedTeamFilter = teamFilterSelect ? teamFilterSelect.value : 'all';

  const teamName = document.getElementById('teamName');
  if (user.role === 'system_admin' || user.role === 'operations_controller' || user.role === 'payroll_officer') {
    teamName.textContent = selectedTeamFilter === 'all' ? '(כל הצוותים)' : `(${selectedTeamFilter})`;
  } else if (user.role === 'manager') {
    teamName.textContent = user.team || '';
  }

  const teamSubtitle = document.getElementById('teamRecordsSubtitle');
  if (teamSubtitle) {
    teamSubtitle.textContent = isMobileView() ? 'במובייל מוצג סיכום כללי בלבד' : 'סיכום לפי עובד - לחץ על שם לפירוט';
  }

  // Silent loading - keep existing content visible
  const teamTableEl = document.getElementById('teamRecordsTable');
  const teamHasContent = teamTableEl.innerHTML.trim() && !teamTableEl.innerHTML.includes('אין ימי עבודה');
  if (teamHasContent) {
    setSilentLoading('teamRecordsTable', true);
  } else {
    teamTableEl.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">טוען נתונים...</p>';
  }
  showLoadingBar();

  try {
    // Get team records from server - filtered by month/year
    const data = await apiRequest('getsummary', {
      employeeId: user.empNum,
      role: user.role,
      team: user.team,
      month: selectedMonth,
      year: selectedYear
    });

    if (data.success && Array.isArray(data.records)) {
      teamRecordsCache = data.records;
      
      // DEBUG: Log first record to see raw SharePoint field formats
      if (data.records.length > 0) {
        const sample = data.records[0];
        console.log('=== RAW SharePoint record sample ===');
        console.log('status:', sample.status, '(type:', typeof sample.status, ')');
        console.log('team:', sample.team, '(type:', typeof sample.team, ')');
        console.log('activityType:', sample.activityType, '(type:', typeof sample.activityType, ')');
        console.log('employeeId:', sample.employeeId);
        console.log('ID:', sample.ID);
      }
      
      // Load manager approval status for month locking
      try {
        const teamFilter = user.role === 'manager' ? (user.team || 'all') : 'all';
        const monthKey = getApprovalMonthKey(selectedMonth, selectedYear);
        const approvalData = await apiRequest('getteamapprovalstatus', {
          team: teamFilter,
          monthKey: monthKey
        });
        if (Array.isArray(approvalData.employees)) {
          approvalData.employees.forEach(emp => {
            const empId = String(emp.employeeId || '').trim();
            if (empId) {
              const cacheKey = `${empId}-${monthKey}`;
              managerApprovalCache.set(cacheKey, !!(emp.managerApprovalDate || emp.released));
            }
          });
        }
      } catch (e) {
        console.warn('Error loading approval status for team records:', e);
      }
      
      // Apply team filter
      let filteredRecords = data.records;
      
      // Manager always sees only their own team
      if (user.role === 'manager' && user.team) {
        const managerTeam = user.team.trim().toLowerCase();
        filteredRecords = data.records.filter(rec => {
          const recTeam = extractLookupValue(rec.team || rec.Team || '', '').trim().toLowerCase();
          return recTeam === managerTeam;
        });
      }
      // Admin/operations_controller can filter by selected team
      else if (selectedTeamFilter !== 'all' && (user.role === 'system_admin' || user.role === 'operations_controller')) {
        const filterTeam = selectedTeamFilter.trim().toLowerCase();
        filteredRecords = data.records.filter(rec => {
          const recTeam = extractLookupValue(rec.team || rec.Team || '', '').trim().toLowerCase();
          return recTeam === filterTeam;
        });
      }
      
      hideLoadingBar();
      setSilentLoading('teamRecordsTable', false);
      renderTeamTable(filteredRecords);
    } else {
      hideLoadingBar();
      setSilentLoading('teamRecordsTable', false);
      const debugInfo = user.role === 'manager' 
        ? `<br><small style="font-size: 12px; color: #64748b;">מנהל: ${user.empName || ''} | צוות: ${user.team || 'לא משויך'}</small>`
        : '';
      document.getElementById('teamRecordsTable').innerHTML = `
        <p style="text-align: center; color: #64748b; padding: 40px;">
          <i class="fas fa-info-circle"></i> אין ימי עבודה להצגה
          ${debugInfo}
          <br><br>
          <small style="font-size: 13px;">ודא שהמדריכים משויכים לצוות שלך ב-SharePoint</small>
        </p>
      `;
    }
  } catch (error) {
    console.error('Error loading team records:', error);
    hideLoadingBar();
    setSilentLoading('teamRecordsTable', false);
    // Fallback to local records
    renderTeamTable(records);
  } finally {
    loadMonthlyApprovalsTable();
  }
}

function renderTeamTable(recordsList) {
  if (!recordsList || recordsList.length === 0) {
    document.getElementById('teamRecordsTable').innerHTML = `
      <p style="text-align: center; color: #64748b; padding: 40px;">
        <i class="fas fa-info-circle"></i> אין ימי עבודה להצגה לחודש זה
        <br><br>
        <span style="font-size: 14px;">אם אתה מנהל צוות, ייתכן שהמדריכים עדיין לא הזינו ימי עבודה, או שהם לא משויכים לצוות שלך.</span>
      </p>
    `;
    return;
  }

  // Group by employee and calculate summary
  const employeeSummary = {};
  recordsList.forEach(rec => {
    const empId = extractLookupValue(rec.employeeId || rec.empNum || rec.EmployeeId, '');
    const empName = extractLookupValue(rec.employeeName || rec.empName || rec.EmployeeName, 'לא ידוע');
    const team = extractLookupValue(rec.team || rec.Team, '-');
    const empType = normalizeEmploymentType(rec, '');
    const hours = parseFloat(rec.totalHours || rec.workHours || rec.hours || rec.WorkHours || 0);
    const km = parseFloat(rec.totalKm || rec.kilometers || rec.km || rec.Kilometers || 0);
    const expenses = parseFloat(rec.totalExpenses || rec.TotalExpenses || 0);
    // Each record = 1 work day unless explicitly specified
    const recordCount = parseInt(rec.totalRecords || rec.totalDays || rec.workDays || 1, 10);

    if (!employeeSummary[empId]) {
      employeeSummary[empId] = {
        empId,
        empName,
        team,
        employmentType: empType,
        totalRecords: 0,
        approvedRecords: 0,
        totalHours: 0,
        totalKm: 0,
        totalExpenses: 0,
        released: rec.released || false
      };
    }

    employeeSummary[empId].totalRecords += Number.isNaN(recordCount) ? 0 : recordCount;
    // Count approved records
    if (isStatusApproved(rec)) {
      employeeSummary[empId].approvedRecords += Number.isNaN(recordCount) ? 0 : recordCount;
    }
    employeeSummary[empId].totalHours += hours;
    employeeSummary[empId].totalKm += km;
    employeeSummary[empId].totalExpenses += expenses;
  });

  const summaryList = Object.values(employeeSummary);
  const grandTotalHours = summaryList.reduce((sum, emp) => sum + emp.totalHours, 0);
  const grandTotalKm = summaryList.reduce((sum, emp) => sum + emp.totalKm, 0);
  const grandTotalExpenses = summaryList.reduce((sum, emp) => sum + emp.totalExpenses, 0);
  const grandTotalRecords = summaryList.reduce((sum, emp) => sum + emp.totalRecords, 0);

  if (isMobileView()) {
    const employeeCards = summaryList.map(emp => {
      const allApproved = emp.totalRecords > 0 && emp.approvedRecords === emp.totalRecords;
      const statusText = allApproved ? 'מאושר' : `${emp.approvedRecords}/${emp.totalRecords}`;
      const statusColor = allApproved ? '#22c55e' : '#f59e0b';
      
      return `
        <div class="employee-card" style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong style="color: #3b82f6; font-size: 16px;">${emp.empName}</strong>
            <span style="background: ${statusColor}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">${statusText}</span>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px; color: #64748b;">
            <div><span>צוות:</span> <strong style="color: #1e293b;">${emp.team || '-'}</strong></div>
            <div><span>שעות:</span> <strong style="color: #1e293b;">${formatHoursDisplay(emp.totalHours)}</strong></div>
            <div><span>ק"מ:</span> <strong style="color: #1e293b;">${emp.totalKm.toFixed(1)}</strong></div>
            <div><span>הוצאות:</span> <strong style="color: #1e293b;">${emp.totalExpenses.toFixed(2)} ₪</strong></div>
          </div>
        </div>
      `;
    }).join('');
    
    document.getElementById('teamRecordsTable').innerHTML = `
      <div class="team-summary-list">
        <div class="team-summary-card" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
          <h4 style="margin: 0 0 10px 0;">סיכום צוות</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
            <div>עובדים: <strong>${summaryList.length}</strong></div>
            <div>שעות: <strong>${formatHoursDisplay(grandTotalHours)}</strong></div>
            <div>ק"מ: <strong>${grandTotalKm.toFixed(1)}</strong></div>
            <div>הוצאות: <strong>${grandTotalExpenses.toFixed(2)} ₪</strong></div>
          </div>
        </div>
        ${employeeCards}
      </div>
    `;
    return;
  }

  const tableHTML = `
    <div style="margin-bottom: 15px;">
      <span style="color: #64748b;">סה"כ ${summaryList.length} עובדים</span>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width: 30px;"></th>
          <th>שם עובד</th>
          <th>צוות</th>
          <th>סה"כ שעות</th>
          <th>סה"כ ק"מ</th>
          <th>סה"כ הוצאות</th>
          <th>סטטוס רשומות</th>
        </tr>
      </thead>
      <tbody>
        ${summaryList.map(emp => {
          const allApproved = emp.totalRecords > 0 && emp.approvedRecords === emp.totalRecords;
          const statusText = allApproved ? 'מאושר' : `${emp.approvedRecords}/${emp.totalRecords}`;
          const statusColor = allApproved ? '#22c55e' : '#f59e0b';
          return `
          <tr class="employee-summary-row" onclick="showEmployeeDetails('${emp.empId}')" style="cursor: pointer;">
            <td><i class="fas fa-chevron-left"></i></td>
            <td><strong style="color: #3b82f6;">${emp.empName}</strong></td>
            <td>${emp.team || '-'}</td>
            <td><strong>${formatHoursDisplay(emp.totalHours)}</strong></td>
            <td>${emp.totalKm.toFixed(1)}</td>
            <td>${emp.totalExpenses.toFixed(2)} ₪</td>
            <td><span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${statusText}</span></td>
          </tr>
        `;}).join('')}
        <tr style="background: #f1f5f9; font-weight: bold; border-top: 2px solid #3b82f6;">
          <td colspan="3" style="text-align: left;">סה"כ:</td>
          <td style="color: #3b82f6;">${formatHoursDisplay(grandTotalHours)}</td>
          <td>${grandTotalKm.toFixed(1)}</td>
          <td>${grandTotalExpenses.toFixed(2)} ₪</td>
          <td></td>
        </tr>
      </tbody>
    </table>
  `;

  document.getElementById('teamRecordsTable').innerHTML = tableHTML;
}


async function showEmployeeDetails(employeeId) {
  console.log('showEmployeeDetails called with:', employeeId);
  if (isMobileView()) {
    console.log('Mobile view - returning');
    return;
  }

  const modal = document.getElementById('employeeDetailsModal');
  const title = document.getElementById('employeeDetailsTitle');
  const content = document.getElementById('employeeDetailsContent');
  console.log('teamRecordsCache:', teamRecordsCache);
  const employeeSummary = teamRecordsCache.find(rec =>
    String(rec.employeeId || rec.empNum || rec.EmployeeId) === String(employeeId)
  );
  const employeeName = employeeSummary?.employeeName || employeeSummary?.empName || employeeSummary?.EmployeeName || '';

  title.textContent = employeeName ? `פירוט שעות - ${employeeName}` : 'פירוט שעות';
  content.innerHTML = `
    <p style="text-align: center; color: #64748b; padding: 24px;">
      <i class="fas fa-spinner fa-spin"></i> טוען נתונים...
    </p>
  `;
  modal.style.display = 'flex';

  try {
    const data = await apiRequest('getemployeerecords', { employeeId });
    if (data.success && Array.isArray(data.records)) {
      renderEmployeeDetailsModal(employeeId, employeeName, data.records);
    } else {
      content.innerHTML = '<p style="color: #94a3b8;">אין ימי עבודה</p>';
    }
  } catch (error) {
    console.error('Error loading employee details:', error);
    content.innerHTML = '<p style="color: #ef4444;">שגיאה בטעינת נתונים</p>';
  }
}

function closeEmployeeDetailsModal() {
  const modal = document.getElementById('employeeDetailsModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

function renderEmployeeDetailsModal(employeeId, employeeName, detailedRecords) {
  const content = document.getElementById('employeeDetailsContent');
  const title = document.getElementById('employeeDetailsTitle');
  const user = getCurrentUserData();
  const canEdit = user && ['manager', 'system_admin'].includes(user.role);

  title.textContent = employeeName ? `פירוט שעות - ${employeeName}` : 'פירוט שעות';

  if (!detailedRecords || detailedRecords.length === 0) {
    content.innerHTML = '<p style="color: #94a3b8;">אין ימי עבודה</p>';
    return;
  }

  const detailsHTML = `
    <table style="width: 100%; font-size: 13px; margin: 0;">
      <thead>
        <tr style="background: #e2e8f0;">
          <th>תאריך</th>
          <th>התחלה</th>
          <th>סיום</th>
          <th>פעילות</th>
          <th>ק"מ</th>
          <th>הערות</th>
          ${canEdit ? '<th>פעולות</th>' : ''}
        </tr>
      </thead>
      <tbody>
        ${detailedRecords.map(rec => {
          const recordId = rec.ID || rec.Id || rec.id || rec.recordId || '';
          const date = rec.attendanceDate || rec.date || rec.AttendanceDate || '';
          const start = rec.startTime || rec.start || rec.StartTime || '';
          const end = rec.endTime || rec.end || rec.EndTime || '';
          const activity = rec.activityType || rec.activity || rec.ActivityType || '';
          const km = rec.kilometers || rec.km || rec.Kilometers || 0;
          const notes = rec.notes || rec.Notes || '';

          return `
            <tr>
              <td>${date}</td>
              <td>${start}</td>
              <td>${end}</td>
              <td>${activity || '-'}</td>
              <td>${km}</td>
              <td>${notes || '-'}</td>
              ${canEdit && recordId ? `
                <td>
                  <button onclick="editTeamRecord('${recordId}')" style="background: #3b82f6; color: white; border: none; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                    <i class="fas fa-edit"></i> עריכה
                  </button>
                </td>
              ` : (canEdit ? '<td>-</td>' : '')}
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;

  content.innerHTML = detailsHTML;
}
function toggleMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  if (!sidebar) return;
  sidebar.classList.toggle('open');
}

function editTeamRecord(recordId) {
  // Close the employee details modal first
  closeEmployeeDetailsModal();
  
  // Find record in cache and open edit modal
  const record = teamRecordsCache.find(r =>
    (r.ID || r.Id || r.id || r.recordId) == recordId
  );
  if (record) {
    // Map to local format and edit
    const localRecord = {
      recordId: recordId,
      empNum: record.employeeId || record.EmployeeId,
      empName: record.employeeName || record.EmployeeName,
      date: record.attendanceDate || record.AttendanceDate,
      start: record.startTime || record.StartTime,
      end: record.endTime || record.EndTime,
      hours: record.workHours || record.WorkHours,
      activity: record.activityType || record.ActivityType,
      school: record.schoolName || record.SchoolName,
      municipality: record.municipality || record.Municipality,
      program: record.programName || record.ProgramName,
      session: record.sessionNumber || record.SessionNumber,
      km: record.kilometers || record.Kilometers,
      totalExpenses: record.totalExpenses || record.TotalExpenses,
      expensesDetail: record.expensesDetails || record.ExpensesDetails,
      notes: record.notes || record.Notes,
      team: record.team || record.Team,
      employmentType: normalizeEmploymentType(record, '')
    };

    const idx = records.findIndex(r => r.recordId == recordId);
    if (idx >= 0) {
      editRecord(idx);
    } else {
      // Add to records temporarily and edit
      records.push(localRecord);
      editRecord(records.length - 1);
    }
  }
}

async function deleteTeamRecord(recordId) {
  if (!confirm('האם אתה בטוח שברצונך למחוק רשומה זו?')) return;

  try {
    showAlert('⚠️ מחיקת רשומות אינה נתמכת ב-API הנוכחי', 'error');
  } catch (error) {
    showAlert('שגיאה במחיקה', 'error');
  }
}

function loadReports() {
  document.getElementById('teamTotalHours').textContent = '0:00';
  document.getElementById('teamTotalKm').textContent = '0';
  document.getElementById('teamTotalExpenses').textContent = '0 ₪';
  
  document.getElementById('reportsByEmployee').innerHTML = `
    <p style="text-align: center; color: #64748b; padding: 40px;">
      <i class="fas fa-info-circle"></i>
      דוחות יוצגו כאן לאחר סנכרון מ-SharePoint
    </p>
  `;
}

function exportTeamToExcel() {
  const user = getCurrentUserData();
  const dataToExport = teamRecordsCache.length ? teamRecordsCache : records;
  const monthSelect = document.getElementById('teamMonthFilter');
  const yearSelect = document.getElementById('teamYearFilter');
  const month = monthSelect ? Number(monthSelect.value) : null;
  const year = yearSelect ? Number(yearSelect.value) : null;
  const monthKey = month && year ? getApprovalMonthKey(month, year) : null;

  exportAttendanceWorkbook(dataToExport, {
    includeSummary: user?.role !== 'instructor',
    monthKey,
    filePrefix: 'דוח_צוות'
  });
}

function viewAllRecords() {
  showPage(null, 'team-records');
}

function exportAllToExcel() {
  exportToExcel();
}

// =============== Alert ===============
let loadingBarEl = null;
let loadingBarCount = 0;
let loadingBarTimeout = null;
function showLoadingBar() {
  loadingBarCount++;
  if (!loadingBarEl) {
    loadingBarEl = document.createElement('div');
    loadingBarEl.className = 'loading-bar';
    document.body.appendChild(loadingBarEl);
  }
  if (loadingBarTimeout) clearTimeout(loadingBarTimeout);
  loadingBarTimeout = setTimeout(() => {
    if (loadingBarEl && loadingBarEl.parentNode) {
      console.warn('[LoadingBar] Auto-hide after 15s timeout, count was:', loadingBarCount);
      loadingBarCount = 0;
      loadingBarEl.parentNode.removeChild(loadingBarEl);
      loadingBarEl = null;
    }
  }, 15000);
}
function hideLoadingBar() {
  loadingBarCount = Math.max(0, loadingBarCount - 1);
  if (loadingBarCount === 0 && loadingBarEl && loadingBarEl.parentNode) {
    loadingBarEl.parentNode.removeChild(loadingBarEl);
    loadingBarEl = null;
    if (loadingBarTimeout) { clearTimeout(loadingBarTimeout); loadingBarTimeout = null; }
  }
}
function setSilentLoading(elementId, loading) {
  const el = document.getElementById(elementId);
  if (!el) return;
  if (loading) {
    el.classList.add('silent-loading');
  } else {
    el.classList.remove('silent-loading');
  }
}

function showAlert(message, type = 'success') {
  const alert = document.getElementById('alertBox');
  const alertText = document.getElementById('alertText');
  
  alert.className = `alert ${type} show`;
  alertText.textContent = message;
  
  setTimeout(() => {
    alert.classList.remove('show');
  }, 5000);
}

// =============== LocalStorage ===============
function saveToLocalStorage() {
  localStorage.setItem('attendanceRecords', JSON.stringify(records));
}

function loadFromLocalStorage() {
  try {
    const data = localStorage.getItem('attendanceRecords');
    if (data) {
      const parsed = JSON.parse(data);
      // Validate that parsed data is an array
      if (Array.isArray(parsed)) {
        // Validate each record has minimum required fields
        records = parsed.filter(rec => {
          if (!rec || typeof rec !== 'object') return false;
          // Must have at least a date and empNum to be valid
          if (!rec.date && !rec.attendanceDate) return false;
          if (!rec.empNum && !rec.employeeId) return false;
          return true;
        });
        console.log(`Loaded ${records.length} valid records from localStorage`);
      } else {
        console.warn('localStorage attendanceRecords is not an array, resetting');
        records = [];
        localStorage.removeItem('attendanceRecords');
      }
    }
  } catch(e) {
    console.error('Error loading from localStorage, resetting:', e);
    records = [];
    localStorage.removeItem('attendanceRecords');
  }
}

// =============== SharePoint Sync ===============
// Real syncFromSharePoint is defined above in the login section

function mergeRecords(loadedRecords) {
  const existingIds = new Set(records.map(r => r.id));
  loadedRecords.forEach(rec => {
    if (!existingIds.has(rec.id)) {
      records.push(rec);
    }
  });
}

// =============== File to Base64 ===============
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}

// =============== Format Attachments ===============
function formatAttachments(attachments) {
  if (!attachments || attachments.length === 0) {
    return '';
  }
  
  return attachments.map(file => {
    const sizeKB = (file.size / 1024).toFixed(1);
    return `${file.name} (${sizeKB} KB)`;
  }).join(', ');
}

// =============== Submit to SharePoint ===============
async function submitAll() {
  if (records.length === 0) {
    showAlert('אין נתונים לשליחה', 'error');
    return;
  }
  
  const pending = records.filter(r => !isStatusApproved(r));
  
  if (pending.length === 0) {
    showAlert('אין ימי עבודה חדשים לשליחה', 'info');
    return;
  }
  
  showAlert(`🚀 שולח ${pending.length} דיווחים...`, 'info');
  
  let success = 0;
  let failed = 0;
  
  for (const rec of pending) {
    const canSubmit = await ensureMonthEditable(
      String(localStorage.getItem("employeeId") || rec.empNum),
      rec.date
    );
    if (!canSubmit) {
      failed++;
      continue;
    }
      const payload = {
        action: "submit",
        employeeId: localStorage.getItem("employeeId") || rec.empNum,
        employeeName: localStorage.getItem("employeeName") || rec.empName,
        team: String(localStorage.getItem("team") || ''),
        employmentType: String(localStorage.getItem("employmentType") || 'תעשיידע'),
        role: String(localStorage.getItem("role") || ''),
        attendanceDate: rec.date,
        startTime: rec.start || '',
        endTime: rec.end || '',
        workHours: Number(rec.hours || 0),
        activityType: rec.activity,
        schoolName: rec.school || '',
        municipality: rec.municipality || '',
        programName: rec.program || '',
        sessionNumber: rec.session || '',
        kilometers: rec.km || 0,
        totalExpenses: rec.totalExpenses || 0,
        expensesDetails: rec.expensesDetail || '',
        notes: rec.notes || '',
        attachmentsNames: formatAttachments(rec.attachments || [])
      };
      
      try {
        const data = await apiRequest('submit', payload);
        
        console.log('Response:', data);
        
        if (data.success) {
          rec.synced = true;
          success++;
        } else {
          failed++;
        }
      } catch(error) {
        console.error('שגיאה בשליחה:', error);
        failed++;
      }
  }
  
  saveToLocalStorage();
  updateStats();
  renderRecordsTable();
  
  if (failed === 0) {
    showAlert(`✅ כל הדיווחים (${success}) נשלחו בהצלחה!`, 'success');
  } else {
    showAlert(`⚠️ נשלחו ${success} דיווחים, ${failed} נכשלו`, 'error');
  }
}

// =============== Summary Table ===============
function renderSummaryTable() {
  // Filter records by selected month (same logic as updateStats)
  const now = new Date();
  const instrMonthEl = document.getElementById('instructorMonth');
  const instrYearEl = document.getElementById('instructorYear');
  const currentMonth = instrMonthEl ? parseInt(instrMonthEl.value) - 1 : now.getMonth();
  const currentYear = instrYearEl ? parseInt(instrYearEl.value) : now.getFullYear();
  
  // Filter records to selected month
  const monthRecords = records.filter(r => {
    if (!r.date) return false;
    let recMonth, recYear;
    if (r.date.includes('/')) {
      const parts = r.date.split('/');
      if (parts.length < 3) return false;
      recMonth = parseInt(parts[1]) - 1;
      recYear = parseInt(parts[2]);
    } else if (r.date.includes('-')) {
      const parts = r.date.split('-');
      if (parts.length < 3) return false;
      recYear = parseInt(parts[0]);
      recMonth = parseInt(parts[1]) - 1;
    } else {
      return false;
    }
    return recMonth === currentMonth && recYear === currentYear;
  });
  
  const summaryData = {};
  let totalKm = 0;

  monthRecords.forEach(rec => {
    const activity = rec.activity || 'אחר';
    const hours = parseFloat(rec.hours) || 0;
    const km = parseFloat(rec.km) || 0;

    if (!summaryData[activity]) {
      summaryData[activity] = { hours: 0, km: 0 };
    }
    summaryData[activity].hours += hours;
    summaryData[activity].km += km;
    totalKm += km;
  });

  const tbody = document.getElementById('summaryTableBody');
  if (!tbody) return;

  if (Object.keys(summaryData).length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #94a3b8;">אין נתונים להצגה</td></tr>';
    return;
  }

  let html = '';
  for (const [activity, data] of Object.entries(summaryData)) {
    html += `
      <tr>
        <td style="font-weight: 500; color: #1e293b;">${activity}</td>
        <td>${formatHoursDisplay(data.hours)}</td>
        <td>${data.km.toFixed(1)}</td>
      </tr>
    `;
  }

  // שורת סיכום סופית
  const totalHours = monthRecords.reduce((sum, r) => sum + (parseFloat(r.hours) || 0), 0);
  html += `
    <tr style="background: #f8fafc; font-weight: 700;">
      <td style="color: #1e40af;">סה"כ כולל</td>
      <td style="color: #1e40af;">${formatHoursDisplay(totalHours)}</td>
      <td style="color: #1e40af;">${totalKm.toFixed(1)}</td>
    </tr>
  `;

  tbody.innerHTML = html;
}

// =============== Statistics ===============
function updateStats() {
  // Get month from instructor selector or use current
  const now = new Date();
  const instrMonthEl = document.getElementById('instructorMonth');
  const instrYearEl = document.getElementById('instructorYear');
  
  console.log('updateStats - instrMonthEl value:', instrMonthEl ? instrMonthEl.value : 'not found');
  console.log('updateStats - instrYearEl value:', instrYearEl ? instrYearEl.value : 'not found');
  console.log('updateStats - total records in memory:', records.length);
  if (records.length > 0) {
    console.log('updateStats - sample record dates:', records.slice(0, 3).map(r => r.date));
  }
  
  const currentMonth = instrMonthEl ? parseInt(instrMonthEl.value) - 1 : now.getMonth();
  const currentYear = instrYearEl ? parseInt(instrYearEl.value) : now.getFullYear();
  
  console.log('updateStats - filtering for month:', currentMonth, 'year:', currentYear);
  
  const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
  
  const monthRecords = records.filter(r => {
    if (!r.date) return false;
    // Parse date - support both DD/MM/YYYY and YYYY-MM-DD formats
    let recMonth, recYear;
    if (r.date.includes('/')) {
      const parts = r.date.split('/');
      if (parts.length < 3) return false;
      recMonth = parseInt(parts[1]) - 1;
      recYear = parseInt(parts[2]);
    } else if (r.date.includes('-')) {
      const parts = r.date.split('-');
      if (parts.length < 3) return false;
      recYear = parseInt(parts[0]);
      recMonth = parseInt(parts[1]) - 1;
    } else {
      return false;
    }
    return recMonth === currentMonth && recYear === currentYear;
  });
  
  const uniqueDates = new Set(monthRecords.map(r => r.date)).size;
  const totalHoursNum = monthRecords.reduce((sum, r) => sum + (parseFloat(r.hours) || 0), 0);
  const totalExpenses = monthRecords.reduce((sum, r) => sum + (parseFloat(r.totalExpenses) || 0), 0).toFixed(2);
  const totalKm = monthRecords.reduce((sum, r) => sum + (parseFloat(r.km) || 0), 0).toFixed(1);
  
  document.getElementById('totalRecordsStat').textContent = uniqueDates;
  document.getElementById('totalHoursStat').textContent = formatHoursDisplay(totalHoursNum);
  document.getElementById('totalExpensesStat').textContent = totalExpenses + ' ₪';
  document.getElementById('pendingRecordsStat').textContent = totalKm + ' ק"מ';
  
  // Update month label
  const monthLabel = document.getElementById('dashboardMonthLabel');
  if (monthLabel) {
    monthLabel.textContent = `סיכום חודש ${monthNames[currentMonth]} ${currentYear}`;
  }
}

// =============== Dashboard ===============
function updateDashboard() {
  updateStats();
  // Update appropriate dashboard based on role
  const role = localStorage.getItem("role") || '';
  if (role === 'payroll_officer') {
    loadPayrollSummary();
  } else if (role === 'system_admin' || role === 'operations_controller' || role === 'manager') {
    // Update admin dashboard for admins, controllers, and managers
    loadAdminDashboard();
  }
}

// =============== Instructor Month Navigation ===============
function initInstructorMonthSelectors() {
  const now = new Date();
  const workMonth = getCurrentWorkMonth();
  console.log('initInstructorMonthSelectors - current date:', now.getMonth() + 1, '/', now.getFullYear(), '- work month:', workMonth.month, '/', workMonth.year);
  
  // Dashboard month selector
  const instrMonthEl = document.getElementById('instructorMonth');
  const instrYearEl = document.getElementById('instructorYear');
  if (instrMonthEl && !instrMonthEl.dataset.initialized) {
    instrMonthEl.value = workMonth.month;
    instrMonthEl.dataset.initialized = 'true';
    console.log('initInstructorMonthSelectors - set month to:', instrMonthEl.value);
  }
  if (instrYearEl && !instrYearEl.dataset.initialized) {
    instrYearEl.value = workMonth.year;
    instrYearEl.dataset.initialized = 'true';
    console.log('initInstructorMonthSelectors - set year to:', instrYearEl.value);
  }
  
  // Records page month selector
  const recMonthEl = document.getElementById('recordsMonth');
  const recYearEl = document.getElementById('recordsYear');
  if (recMonthEl && !recMonthEl.dataset.initialized) {
    recMonthEl.value = workMonth.month;
    recMonthEl.dataset.initialized = 'true';
  }
  if (recYearEl && !recYearEl.dataset.initialized) {
    recYearEl.value = workMonth.year;
    recYearEl.dataset.initialized = 'true';
  }
}

function changeInstructorMonth(direction) {
  const monthEl = document.getElementById('instructorMonth');
  const yearEl = document.getElementById('instructorYear');
  if (!monthEl || !yearEl) return;
  
  let month = parseInt(monthEl.value);
  let year = parseInt(yearEl.value);
  
  month += direction;
  if (month < 1) {
    month = 12;
    year--;
  } else if (month > 12) {
    month = 1;
    year++;
  }
  
  monthEl.value = month;
  yearEl.value = year;
  loadInstructorMonthData();
}

async function loadInstructorMonthData() {
  // Sync with records page selector
  const instrMonthEl = document.getElementById('instructorMonth');
  const instrYearEl = document.getElementById('instructorYear');
  const recMonthEl = document.getElementById('recordsMonth');
  const recYearEl = document.getElementById('recordsYear');
  
  if (instrMonthEl && recMonthEl) {
    recMonthEl.value = instrMonthEl.value;
  }
  if (instrYearEl && recYearEl) {
    recYearEl.value = instrYearEl.value;
  }
  
  const role = localStorage.getItem('role') || '';
  console.log('loadInstructorMonthData - role:', role, 'month:', instrMonthEl?.value, 'year:', instrYearEl?.value);
  
  // For managers, ops controllers, admin, payroll - update admin dashboard first (priority)
  if (['manager', 'operations_controller', 'system_admin', 'payroll_officer'].includes(role)) {
    console.log('loadInstructorMonthData - calling updateAdminDashboard for manager/admin');
    updateAdminDashboard(); // Don't await - run in parallel
  }
  
  // All roles need to update personal stats if visible (instructors always, others if they have records panel)
  console.log('loadInstructorMonthData - updating personal records stats');
  await loadMyRecordsFromServer();
  updateStats();
  renderSummaryTable();
  loadInstructorMonthlyApprovalStatus();
}

function changeRecordsMonth(direction) {
  const monthEl = document.getElementById('recordsMonth');
  const yearEl = document.getElementById('recordsYear');
  if (!monthEl || !yearEl) return;
  
  let month = parseInt(monthEl.value);
  let year = parseInt(yearEl.value);
  
  month += direction;
  if (month < 1) {
    month = 12;
    year--;
  } else if (month > 12) {
    month = 1;
    year++;
  }
  
  monthEl.value = month;
  yearEl.value = year;
  loadRecordsForMonth();
}

async function loadRecordsForMonth() {
  // Sync with dashboard selector
  const instrMonthEl = document.getElementById('instructorMonth');
  const instrYearEl = document.getElementById('instructorYear');
  const recMonthEl = document.getElementById('recordsMonth');
  const recYearEl = document.getElementById('recordsYear');
  
  if (recMonthEl && instrMonthEl) {
    instrMonthEl.value = recMonthEl.value;
  }
  if (recYearEl && instrYearEl) {
    instrYearEl.value = recYearEl.value;
  }
  
  // Reload approval status for selected month
  const user = getCurrentUserData();
  if (user) {
    const selectedMonth = recMonthEl ? parseInt(recMonthEl.value) : (new Date().getMonth() + 1);
    const selectedYear = recYearEl ? parseInt(recYearEl.value) : new Date().getFullYear();
    const monthKey = getApprovalMonthKey(selectedMonth, selectedYear);
    const employeeId = String(user.empNum || localStorage.getItem('employeeId') || '');
    
    try {
      const approvalStatus = await fetchMonthStatus(employeeId, monthKey, user.team || '');
      if (user.role === 'instructor') {
        instructorApprovalInfo = { monthKey, approvalDate: approvalStatus.approvalDate || null };
      }
      // Cache manager approval for month locking
      if (employeeId) {
        const cacheKey = `${employeeId}-${monthKey}`;
        managerApprovalCache.set(cacheKey, !!(approvalStatus.released));
      }
    } catch (e) {
      console.error('Error fetching month approval status:', e);
    }
  }
  
  // Re-render records table
  renderRecordsTable();
}

// =============== Payroll Officer Functions ===============
function loadPayrollSummary() {
  // Set default month/year if not already set
  const now = new Date();
  const monthEl = document.getElementById('payrollMonth');
  const yearEl = document.getElementById('payrollYear');
  if (monthEl && !monthEl.dataset.initialized) {
    monthEl.value = now.getMonth() + 1;
    monthEl.dataset.initialized = 'true';
  }
  if (yearEl && !yearEl.dataset.initialized) {
    yearEl.value = now.getFullYear();
    yearEl.dataset.initialized = 'true';
  }
  updatePayrollSummaryTable();
}

async function updatePayrollSummaryTable() {
  const tbody = document.getElementById('payrollSummaryTableBody');
  if (!tbody) return;
  
  // Get month/year from filters or use current
  const now = new Date();
  const payrollMonthEl = document.getElementById('payrollMonth');
  const payrollYearEl = document.getElementById('payrollYear');
  const currentMonth = payrollMonthEl ? parseInt(payrollMonthEl.value) - 1 : now.getMonth();
  const currentYear = payrollYearEl ? parseInt(payrollYearEl.value) : now.getFullYear();
  
  // Filter records to current month only - support both DD/MM/YYYY and YYYY-MM-DD formats
  const currentMonthRecords = records.filter(rec => {
    if (!rec.date) return false;
    const dateStr = rec.date;
    let recMonth, recYear;
    if (dateStr.includes('/')) {
      const parts = dateStr.split('/');
      if (parts.length < 3) return false;
      recMonth = parseInt(parts[1]) - 1;
      recYear = parseInt(parts[2]);
    } else if (dateStr.includes('-')) {
      const parts = dateStr.split('-');
      if (parts.length < 3) return false;
      recYear = parseInt(parts[0]);
      recMonth = parseInt(parts[1]) - 1;
    } else {
      return false;
    }
    return recMonth === currentMonth && recYear === currentYear;
  });
  
  // Group records by instructor
  const instructorData = {};
  
  currentMonthRecords.forEach(rec => {
    const name = rec.empName || rec.empNum || 'לא ידוע';
    if (!instructorData[name]) {
      instructorData[name] = {
        name: name,
        team: rec.team || '',
        workDays: new Set(),
        hoursCourse: 0,
        hoursTraining: 0,
        hoursCancel: 0,
        totalKm: 0,
        totalExpenses: 0
      };
    }
    
    // Add unique work days
    if (rec.date) {
      instructorData[name].workDays.add(rec.date);
    }
    
    // Sum hours by activity type
    const hours = parseFloat(rec.hours) || 0;
    const activity = (rec.activity || '').toLowerCase();
    if (activity.includes('קורס') || activity.includes('הפעלה')) {
      instructorData[name].hoursCourse += hours;
    } else if (activity.includes('הכשרה') || activity.includes('השתלמות')) {
      instructorData[name].hoursTraining += hours;
    } else if (activity.includes('ביטול')) {
      instructorData[name].hoursCancel += hours;
    } else {
      instructorData[name].hoursCourse += hours; // Default to course hours
    }
    
    // Sum kilometers and expenses
    instructorData[name].totalKm += parseFloat(rec.km) || 0;
    instructorData[name].totalExpenses += parseFloat(rec.totalExpenses) || 0;
    
    // Update team if empty
    if (!instructorData[name].team && rec.team) {
      instructorData[name].team = extractLookupValue(rec.team, '');
    }
  });
  
  // Render table
  const sortedInstructors = Object.values(instructorData).sort((a, b) => a.name.localeCompare(b.name, 'he'));
  
  if (sortedInstructors.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #64748b;">אין נתונים להצגה</td></tr>';
    return;
  }
  
  tbody.innerHTML = sortedInstructors.map(inst => `
    <tr>
      <td style="padding: 10px 8px; text-align: right; font-weight: 500;">${inst.name}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.team || '-'}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.hoursCourse.toFixed(1)}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.hoursTraining.toFixed(1)}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.hoursCancel.toFixed(1)}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.totalKm}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.totalExpenses.toFixed(0)} ₪</td>
    </tr>
  `).join('');
}

function exportPayrollToExcel() {
  // Get month/year from filters or use current
  const now = new Date();
  const payrollMonthEl = document.getElementById('payrollMonth');
  const payrollYearEl = document.getElementById('payrollYear');
  const currentMonth = payrollMonthEl ? parseInt(payrollMonthEl.value) - 1 : now.getMonth();
  const currentYear = payrollYearEl ? parseInt(payrollYearEl.value) : now.getFullYear();
  
  // Filter records to selected month only
  const currentMonthRecords = records.filter(rec => {
    if (!rec.date) return false;
    const recDate = new Date(rec.date);
    return recDate.getMonth() === currentMonth && recDate.getFullYear() === currentYear;
  });
  
  const monthKey = getApprovalMonthKey(currentMonth + 1, currentYear);
  exportAttendanceWorkbook(currentMonthRecords, {
    includeSummary: true,
    monthKey,
    filePrefix: 'דוח_נוכחות'
  });
}

// =============== Time Picker Functions ===============
function populateTimeDropdowns() {
  const hourSelects = ['startHour', 'endHour', 'editStartHour', 'editEndHour'];
  const minuteSelects = ['startMinute', 'endMinute', 'editStartMinute', 'editEndMinute'];
  
  hourSelects.forEach(id => {
    const select = document.getElementById(id);
    if (select) {
      select.innerHTML = '<option value="">שעה</option>';
      for (let h = 6; h <= 23; h++) {
        const val = h.toString().padStart(2, '0');
        select.innerHTML += `<option value="${val}">${val}</option>`;
      }
    }
  });
  
  minuteSelects.forEach(id => {
    const select = document.getElementById(id);
    if (select) {
      select.innerHTML = '<option value="">דקות</option>';
      for (let m = 0; m < 60; m += 5) {
        const val = m.toString().padStart(2, '0');
        select.innerHTML += `<option value="${val}">${val}</option>`;
      }
    }
  });
}

function updateTimeField(prefix) {
  const hourSelect = document.getElementById(prefix + 'Hour');
  const minuteSelect = document.getElementById(prefix + 'Minute');
  const hiddenField = document.getElementById(prefix + 'Time');
  
  if (hourSelect && minuteSelect && hiddenField) {
    const hour = hourSelect.value;
    const minute = minuteSelect.value;
    if (hour && minute) {
      hiddenField.value = hour + ':' + minute;
    } else {
      hiddenField.value = '';
    }
  }
  
  // Update end time minimum when start time changes
  if (prefix === 'start') {
    updateEndTimeMinimum('start', 'end');
  } else if (prefix === 'editStart') {
    updateEndTimeMinimum('editStart', 'editEnd');
  }
}

function updateEndTimeMinimum(startPrefix, endPrefix) {
  const startHourSelect = document.getElementById(startPrefix + 'Hour');
  const endHourSelect = document.getElementById(endPrefix + 'Hour');
  
  if (!startHourSelect || !endHourSelect) return;
  
  const startHour = parseInt(startHourSelect.value) || 0;
  const currentEndHour = endHourSelect.value;
  
  // Save current selection
  const savedEndHour = currentEndHour;
  
  // Clear and rebuild end hour options
  endHourSelect.innerHTML = '<option value="">שעה</option>';
  
  for (let h = startHour; h <= 23; h++) {
    const hStr = h.toString().padStart(2, '0');
    const option = document.createElement('option');
    option.value = hStr;
    option.textContent = hStr;
    endHourSelect.appendChild(option);
  }
  
  // Restore selection if still valid
  if (savedEndHour && parseInt(savedEndHour) >= startHour) {
    endHourSelect.value = savedEndHour;
  } else if (startHour) {
    // Auto-select start hour as minimum
    endHourSelect.value = startHour.toString().padStart(2, '0');
    updateTimeField(endPrefix);
  }
}

function setTimeDropdowns(prefix, timeValue) {
  if (!timeValue) return;
  const parts = timeValue.split(':');
  if (parts.length >= 2) {
    const hour = parts[0].padStart(2, '0');
    const minute = parts[1].padStart(2, '0');
    const roundedMinute = (Math.round(parseInt(minute) / 5) * 5).toString().padStart(2, '0');
    
    const hourSelect = document.getElementById(prefix + 'Hour');
    const minuteSelect = document.getElementById(prefix + 'Minute');
    const hiddenField = document.getElementById(prefix + 'Time');
    
    if (hourSelect) hourSelect.value = hour;
    if (minuteSelect) minuteSelect.value = roundedMinute;
    if (hiddenField) hiddenField.value = hour + ':' + roundedMinute;
  }
}

// =============== Calculate Hours ===============
function calculateHours() {
  const startTime = document.getElementById('startTime').value;
  const endTime = document.getElementById('endTime').value;
  
  if (startTime && endTime) {
    const start = new Date('2000-01-01 ' + startTime);
    const end = new Date('2000-01-01 ' + endTime);
    
    let diff = (end - start) / 1000 / 60 / 60;
    
    if (diff < 0) {
      diff += 24;
    }
    
    const formatted = diff.toFixed(2);
    document.getElementById('hoursField').value = formatted;
    const hoursDisplay = document.getElementById('hoursDisplay');
    if (hoursDisplay) hoursDisplay.textContent = formatHoursDisplay(diff);
  } else {
    document.getElementById('hoursField').value = '';
    const hoursDisplay = document.getElementById('hoursDisplay');
    if (hoursDisplay) hoursDisplay.textContent = '0:00';
  }
}

function calculateEditHours() {
  const startTime = document.getElementById('editStartTime').value;
  const endTime = document.getElementById('editEndTime').value;
  
  if (startTime && endTime) {
    const start = new Date('2000-01-01 ' + startTime);
    const end = new Date('2000-01-01 ' + endTime);
    
    let diff = (end - start) / 1000 / 60 / 60;
    
    if (diff < 0) {
      diff += 24;
    }
    
    document.getElementById('editHours').value = diff.toFixed(2);
  }
}

// =============== Add Record ===============
let isSubmitting = false;

async function addRecord() {
  // Prevent double submission
  if (isSubmitting) {
    console.log('Submission already in progress, ignoring click');
    return;
  }
  isSubmitting = true;
  
  try {
    await _addRecordInternal();
  } finally {
    isSubmitting = false;
  }
}

async function _addRecordInternal() {
  // Check if we're editing an existing record
  const editingId = document.getElementById('addRecordPage')?.dataset?.editingId;
  const isEditing = editingId && editingId !== '';
  
  const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
  const empNum = userData.empNum || '';
  const empName = userData.empName || '';
  
  console.log('=== DEBUG addRecord ===');
  console.log('userData:', userData);
  console.log('empNum:', empNum);
  console.log('empName:', empName);
  
  const date = document.getElementById('recDate').value;
  const startTime = document.getElementById('startTime').value;
  const endTime = document.getElementById('endTime').value;
  const hours = parseFloat(document.getElementById('hoursField').value) || 0;
  const activity = document.getElementById('activityType').value;
  
  const schoolSelect = document.getElementById('schoolField');
  let school = '';
  let municipality = '';
  
  if (schoolSelect.value) {
    try {
      const schoolData = JSON.parse(schoolSelect.value);
      school = schoolData['בית ספר'];
      municipality = schoolData['רשות'];
    } catch(e) {}
  }
  
  const program = document.getElementById('programField').value;
  const session = document.getElementById('sessionNum').value;
  const km = parseFloat(document.getElementById('kmField').value) || 0;
  const totalExpenses = parseFloat(document.getElementById('totalExpenses').value) || 0;
  const expensesDetail = document.getElementById('expensesDetail').value;
  const notes = document.getElementById('notesField').value;
  
  // Use selectedFiles array (populated by drag-drop or file picker)
  const attachments = [];
  if (selectedFiles && selectedFiles.length > 0) {
    for (const file of selectedFiles) {
      const base64 = await fileToBase64(file);
      attachments.push({
        name: file.name,
        type: file.type,
        size: file.size,
        content: base64
      });
    }
  }

  const missing = [];
  if (!date) missing.push('תאריך');
  if (!startTime) missing.push('שעת התחלה');
  if (!endTime) missing.push('שעת סיום');
  if (!hours) missing.push('שעות');
  if (!activity) missing.push('סוג פעילות');
  if (!school) missing.push('בית ספר');
  if (!municipality) missing.push('רשות');
  if (!program) missing.push('תוכנית');
  if (!session) missing.push('מספר מפגש');

  if (missing.length > 0) {
    showAlert('⚠️ אנא מלא את כל השדות החובה: ' + missing.join(', '), 'error');
    return;
  }

  const canSubmit = await ensureMonthEditable(
    String(localStorage.getItem("employeeId") || empNum),
    date
  );
  if (!canSubmit) return;

  // Validate activity type against allowed values
  if (!isValidActivityType(activity)) {
    showAlert('⚠️ סוג פעילות לא חוקי', 'error');
    console.error('Invalid activity type:', activity, '- allowed:', ACTIVITY_TYPES);
    return;
  }

  // Duplicate submission check - only for new records, not edits
  if (!isEditing) {
    const potentialKey = `${empNum}_${date}_${startTime}_${activity}`;
    const existingDuplicate = records.find(rec => {
      const recKey = generateRecordKey(rec);
      return recKey === potentialKey;
    });

    if (existingDuplicate) {
      showAlert('⚠️ כבר קיים דיווח עם אותו תאריך, שעת התחלה וסוג פעילות', 'error');
      console.warn('Duplicate submission blocked:', { date, startTime, activity, existingRecord: existingDuplicate });
      return;
    }
  }

  const storedEmployeeId = localStorage.getItem("employeeId");
  const storedEmployeeName = localStorage.getItem("employeeName");
  
  console.log('=== DEBUG payload creation ===');
  console.log('localStorage employeeId:', storedEmployeeId);
  console.log('localStorage employeeName:', storedEmployeeName);
  console.log('userData empNum:', empNum);
  console.log('userData empName:', empName);
  
  const finalEmployeeId = storedEmployeeId || empNum || '';
  const finalEmployeeName = storedEmployeeName || empName || '';
  
  console.log('Final employeeId:', finalEmployeeId);
  console.log('Final employeeName:', finalEmployeeName);
  
  if (!finalEmployeeId || !finalEmployeeName) {
    showAlert('שגיאה: חסרים פרטי עובד. נסה להתנתק ולהתחבר מחדש.', 'error');
    return;
  }
  
  const payload = {
    action: isEditing ? "updaterecord" : "submit",
    id: isEditing ? editingId : undefined,
    employeeId: String(finalEmployeeId),
    employeeName: String(finalEmployeeName),
    team: String(localStorage.getItem("team") || ''),
    employmentType: String(localStorage.getItem("employmentType") || 'תעשיידע'),
    role: String(localStorage.getItem("role") || ''),
    attendanceDate: String(date),
    startTime: String(startTime),
    endTime: String(endTime),
    workHours: Number(hours),
    activityType: String(activity),
    schoolName: String(school),
    municipality: String(municipality),
    programName: String(program),
    sessionNumber: Number(session) || 0,
    kilometers: Number(km) || 0,
    totalExpenses: Number(totalExpenses) || 0,
    expensesDetails: String(expensesDetail || ''),
    notes: String(notes || ''),
    attachmentsNames: formatAttachments(attachments)
  };
  
  // Send to SharePoint using apiRequest with retry - silent loading
  showLoadingBar();
  setSilentLoading('addRecordPage', true);
  
  try {
    const actionType = isEditing ? 'updaterecord' : 'submit';
    const data = await apiRequest(actionType, payload);
    
    if (data.success) {
      // Upload files if any selected
      if (selectedFiles.length > 0) {
        const uploadResult = await uploadFilesToSharePoint(finalEmployeeId, date);
        if (uploadResult.urls.length > 0 && (data.recordId || editingId)) {
          const attachmentsNames = uploadResult.urls.join(', ');
          await apiRequest('updaterecord', {
            action: 'updaterecord',
            recordId: String(data.recordId || editingId),
            employeeId: String(finalEmployeeId),
            employeeName: String(finalEmployeeName),
            team: String(localStorage.getItem("team") || ''),
            employmentType: String(localStorage.getItem("employmentType") || 'תעשיידע'),
            attachmentsNames: attachmentsNames
          });
        }
      }
      
      clearAddForm();
      if (document.getElementById('addRecordPage')) {
        document.getElementById('addRecordPage').dataset.editingId = '';
      }
      const pageHeader = document.querySelector('#addRecordPage .page-header h1');
      if (pageHeader) {
        pageHeader.textContent = 'הוספת דיווח';
      }
      
      hideLoadingBar();
      setSilentLoading('addRecordPage', false);
      showAlert(isEditing ? '✅ הרשומה עודכנה בהצלחה!' : '✅ הדיווח נשלח בהצלחה!', 'success');
      if (isEditing) {
        showPage(null, 'dashboard');
      }
      syncFromSharePoint(empNum).catch(err => console.warn('Background sync error:', err));
    } else {
      hideLoadingBar();
      setSilentLoading('addRecordPage', false);
      showAlert('❌ ' + (data.message || 'שגיאה בשליחה'), 'error');
    }
  } catch (error) {
    hideLoadingBar();
    setSilentLoading('addRecordPage', false);
    console.error('=== SUBMISSION ERROR ===');
    console.error('Endpoint:', isEditing ? 'updaterecord' : 'submit');
    console.error('Payload:', JSON.stringify(payload, null, 2));
    console.error('Error:', error.message || error);
    showAlert('❌ ' + (error.message || 'שגיאה בשליחה לשרת'), 'error');
  }
}

function clearAddForm() {
  document.getElementById('recDate').value = '';
  document.getElementById('startHour').value = '';
  document.getElementById('startMinute').value = '';
  document.getElementById('startTime').value = '';
  document.getElementById('endHour').value = '';
  document.getElementById('endMinute').value = '';
  document.getElementById('endTime').value = '';
  document.getElementById('hoursField').value = '';
  document.getElementById('activityType').value = '';
  document.getElementById('schoolField').value = '';
  document.getElementById('municipality').value = '';
  document.getElementById('programField').value = '';
  document.getElementById('sessionNum').value = '';
  document.getElementById('kmField').value = '';
  document.getElementById('totalExpenses').value = '';
  document.getElementById('expensesDetail').value = '';
  clearSelectedFiles(); // Clear drag-drop file selection
  document.getElementById('notesField').value = '';
}

// =============== Records Table ===============
function renderRecordsTable() {
  // Filter records by selected month
  const now = new Date();
  const recMonthEl = document.getElementById('recordsMonth');
  const recYearEl = document.getElementById('recordsYear');
  const selectedMonth = recMonthEl ? parseInt(recMonthEl.value) - 1 : now.getMonth();
  const selectedYear = recYearEl ? parseInt(recYearEl.value) : now.getFullYear();
  
  const filteredRecords = records.filter(r => {
    if (!r.date) return false;
    // Parse date - support both DD/MM/YYYY and YYYY-MM-DD formats
    let recMonth, recYear;
    if (r.date.includes('/')) {
      const parts = r.date.split('/');
      if (parts.length < 3) return false;
      recMonth = parseInt(parts[1]) - 1;
      recYear = parseInt(parts[2]);
    } else if (r.date.includes('-')) {
      const parts = r.date.split('-');
      if (parts.length < 3) return false;
      recYear = parseInt(parts[0]);
      recMonth = parseInt(parts[1]) - 1;
    } else {
      return false;
    }
    return recMonth === selectedMonth && recYear === selectedYear;
  });
  
  // Sort records by date ascending (oldest first)
  filteredRecords.sort((a, b) => {
    const parseDate = (dateStr) => {
      if (!dateStr) return new Date(0);
      if (dateStr.includes('/')) {
        const parts = dateStr.split('/');
        return new Date(parts[2], parts[1] - 1, parts[0]);
      } else if (dateStr.includes('-')) {
        return new Date(dateStr);
      }
      return new Date(0);
    };
    return parseDate(a.date) - parseDate(b.date);
  });
  
  const uniqueWorkDays = new Set(filteredRecords.map(rec => rec.date)).size;
  document.getElementById('totalRecordsCount').textContent = uniqueWorkDays;
  
  const totalHours = filteredRecords.reduce((sum, rec) => sum + (rec.hours || 0), 0);
  const totalKm = filteredRecords.reduce((sum, rec) => sum + (rec.km || 0), 0);
  const recordsContainer = document.getElementById('recordsTable');
  if (!recordsContainer) return;
  
  if (filteredRecords.length === 0) {
    recordsContainer.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px;">אין רשומות להצגה לחודש זה</p>';
    return;
  }

  // Group records by week
  function getWeekNumber(dateStr) {
    if (!dateStr) return 0;
    try {
      const date = new Date(dateStr.split('/').reverse().join('-'));
      if (isNaN(date.getTime())) return 0;
      const startOfYear = new Date(date.getFullYear(), 0, 1);
      const days = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000));
      return Math.ceil((days + startOfYear.getDay() + 1) / 7);
    } catch (e) {
      return 0;
    }
  }

  function getWeekRange(dateStr) {
    if (!dateStr) return '';
    try {
      const parts = dateStr.split('/');
      if (parts.length < 3) return '';
      const date = new Date(parts[2], parts[1] - 1, parts[0]);
      if (isNaN(date.getTime())) return '';
      const dayOfWeek = date.getDay();
      const startOfWeek = new Date(date);
      startOfWeek.setDate(date.getDate() - dayOfWeek);
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      return `${startOfWeek.getDate()}/${startOfWeek.getMonth()+1} - ${endOfWeek.getDate()}/${endOfWeek.getMonth()+1}`;
    } catch (e) {
      return '';
    }
  }

  // Group records by week
  const weekGroups = {};
  filteredRecords.forEach((rec) => {
    // Find original index in the full records array
    rec._originalIndex = records.findIndex(r => 
      r.date === rec.date && r.empNum === rec.empNum && r.activity === rec.activity && r.hours === rec.hours
    );
    const weekNum = getWeekNumber(rec.date);
    const weekRange = getWeekRange(rec.date);
    const key = `${weekNum}_${weekRange}`;
    if (!weekGroups[key]) {
      weekGroups[key] = { weekNum, weekRange, records: [] };
    }
    weekGroups[key].records.push(rec);
  });

  // Sort weeks descending (newest first)
  const sortedWeeks = Object.values(weekGroups).sort((a, b) => b.weekNum - a.weekNum);

  if (isMobileView()) {
    const totalExpenses = filteredRecords.reduce((sum, rec) => sum + (parseFloat(rec.totalExpenses) || 0), 0);
    const user = getCurrentUserData();
    const userRole = user ? user.role : '';
    // Roles that can potentially edit records (actual permission checked per record)
    const canPotentiallyEdit = ['instructor', 'manager', 'operations_controller', 'system_admin'].includes(userRole);
    const canPotentiallyDelete = ['instructor', 'manager', 'operations_controller', 'system_admin'].includes(userRole);

    // Mobile: Show summary card with light pastel color, then weekly grouped cards
    const weeklyHTML = sortedWeeks.map(week => {
      const weekHours = week.records.reduce((sum, r) => sum + (r.hours || 0), 0);
      const weekKm = week.records.reduce((sum, r) => sum + (r.km || 0), 0);
      
      const dayCards = week.records.map(rec => {
        const canEditThis = canEditRecord(rec);
        const canDeleteThis = canDeleteRecord(rec);
        const dayName = new Date(rec.date.split('/').reverse().join('-')).toLocaleDateString('he-IL', { weekday: 'short' });
        
        // Build action buttons based on permissions
        let actionButtons = '';
        if (canPotentiallyEdit && canEditThis) {
          actionButtons += `<button onclick="editRecord(${rec._originalIndex})" style="flex: 1; background: #3b82f6; color: white; padding: 8px; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;"><i class="fas fa-edit"></i> עריכה</button>`;
        }
        if (canPotentiallyDelete && canDeleteThis) {
          actionButtons += `<button onclick="deleteRecord(${rec._originalIndex})" style="flex: 1; background: #ef4444; color: white; padding: 8px; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;"><i class="fas fa-trash"></i> מחיקה</button>`;
        }
        
        return `
          <div style="background: #f8fafc; border-radius: 10px; padding: 12px; margin-bottom: 8px; border-right: 3px solid #60a5fa;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
              <span style="font-weight: 600; color: #1e40af; font-size: 14px;">${dayName} ${rec.date}</span>
              <span style="background: #dbeafe; padding: 3px 8px; border-radius: 10px; font-size: 12px; color: #1e40af;">${formatHoursDisplay(rec.hours)} שעות</span>
            </div>
            <div style="font-size: 12px; color: #64748b;">${rec.activity} | ${rec.school || '-'}</div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">${rec.start || '--:--'} - ${rec.end || '--:--'} | ${rec.km || 0} ק"מ</div>
            ${actionButtons ? `<div style="display: flex; gap: 8px; margin-top: 8px;">${actionButtons}</div>` : ''}
          </div>
        `;
      }).join('');

      return `
        <div style="background: white; border-radius: 14px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); overflow: hidden;">
          <div style="background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%); padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleWeekDetails('week-${week.weekNum}')">
            <div>
              <div style="font-weight: 600; color: #1e40af; font-size: 15px;"><i class="fas fa-calendar-week" style="margin-left: 6px;"></i>שבוע ${week.weekNum}</div>
              <div style="font-size: 12px; color: #3b82f6; margin-top: 2px;">${week.weekRange}</div>
            </div>
            <div style="text-align: left;">
              <div style="font-size: 13px; color: #1e40af;">${new Set(week.records.map(r => r.date)).size} ימים</div>
              <div style="font-size: 14px; font-weight: 600; color: #1e40af;">${formatHoursDisplay(weekHours)} שעות</div>
            </div>
          </div>
          <div id="week-${week.weekNum}" style="padding: 12px; display: block;">
            ${dayCards}
          </div>
        </div>
      `;
    }).join('');

    recordsContainer.innerHTML = `
      <div class="records-summary-list">
        <div class="records-summary-card" style="background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%); color: #1e3a5f; border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid #60a5fa;">
          <h4 style="margin: 0 0 12px 0; font-size: 16px; color: #1e40af;"><i class="fas fa-chart-bar" style="margin-left: 8px;"></i>סיכום חודשי</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div style="background: rgba(255,255,255,0.6); padding: 10px; border-radius: 10px; text-align: center;">
              <div style="font-size: 20px; font-weight: 700; color: #1e40af;">${uniqueWorkDays}</div>
              <div style="font-size: 12px; color: #475569;">ימי עבודה</div>
            </div>
            <div style="background: rgba(255,255,255,0.6); padding: 10px; border-radius: 10px; text-align: center;">
              <div style="font-size: 20px; font-weight: 700; color: #1e40af;">${formatHoursDisplay(totalHours)}</div>
              <div style="font-size: 12px; color: #475569;">שעות</div>
            </div>
            <div style="background: rgba(255,255,255,0.6); padding: 10px; border-radius: 10px; text-align: center;">
              <div style="font-size: 20px; font-weight: 700; color: #1e40af;">${totalKm.toFixed(0)}</div>
              <div style="font-size: 12px; color: #475569;">ק"מ</div>
            </div>
            <div style="background: rgba(255,255,255,0.6); padding: 10px; border-radius: 10px; text-align: center;">
              <div style="font-size: 20px; font-weight: 700; color: #1e40af;">${totalExpenses.toFixed(0)}₪</div>
              <div style="font-size: 12px; color: #475569;">הוצאות</div>
            </div>
          </div>
        </div>
        ${weeklyHTML || '<p style="text-align: center; color: #94a3b8;">אין רשומות להצגה</p>'}
      </div>
    `;
    return;
  }
  
  const user = getCurrentUserData();
  const userRole = user ? user.role : 'instructor';
  // Show actions column for any user who can potentially edit or delete records
  // Instructors can edit their own records within the month, so they also get an actions column
  const showActionsColumn = userRole !== 'payroll_officer';

  const tableHTML = `
    <table>
      <thead>
        <tr>
          <th>תאריך</th>
          <th>שעת התחלה</th>
          <th>שעת סיום</th>
          <th>סה"כ שעות</th>
          <th>פעילות</th>
          <th>בית ספר</th>
          <th>רשות</th>
          <th>ק"מ</th>
          ${showActionsColumn ? '<th>פעולות</th>' : ''}
        </tr>
      </thead>
      <tbody>
        ${filteredRecords.map((rec) => {
          const originalIdx = records.findIndex(r => 
            r.date === rec.date && r.empNum === rec.empNum && r.activity === rec.activity && r.hours === rec.hours
          );
          return `
          <tr>
            <td>${rec.date || ''}</td>
            <td style="text-align: center; font-family: 'Courier New', monospace;">
              ${rec.start || '--:--'}
            </td>
            <td style="text-align: center; font-family: 'Courier New', monospace;">
              ${rec.end || '--:--'}
            </td>
            <td style="text-align: center;">
              <strong style="color: #1e40af;">${formatHoursDisplay(rec.hours)}</strong>
            </td>
            <td>${rec.activity || ''}</td>
            <td>${rec.school || '-'}</td>
            <td>${rec.municipality || ''}</td>
            <td style="text-align: center;">${rec.km || 0}</td>
            ${showActionsColumn ? `
            <td style="white-space: nowrap;">
              ${canEditRecord(rec) ? `
              <button onclick="editRecord(${originalIdx})" style="background: #dbeafe; color: #1e40af; padding: 4px 6px; border: none; border-radius: 4px; cursor: pointer; margin-left: 2px;" title="עריכה">
                <i class="fas fa-edit"></i>
              </button>
              ` : ''}
              ${canDeleteRecord(rec) ? `
              <button onclick="deleteRecord(${originalIdx})" style="background: #fecaca; color: #b91c1c; padding: 4px 6px; border: none; border-radius: 4px; cursor: pointer;" title="מחיקה">
                <i class="fas fa-trash"></i>
              </button>
              ` : ''}
            </td>
            ` : ''}
          </tr>
        `;}).join('')}
        <tr style="background: #f8fafc; font-weight: bold; border-top: 2px solid #3b82f6;">
          <td style="text-align: left; padding-right: 20px;">סה"כ:</td>
          <td></td>
          <td></td>
          <td style="text-align: center; color: #3b82f6; font-size: 16px;">${formatHoursDisplay(totalHours)}</td>
          <td></td>
          <td></td>
          <td></td>
          <td style="text-align: center; color: #3b82f6;">${totalKm.toFixed(1)}</td>
          ${showActionsColumn ? '<td></td>' : ''}
        </tr>
      </tbody>
    </table>
  `;
  
  recordsContainer.innerHTML = tableHTML;
}

async function deleteRecord(index) {
  const rec = records[index];
  if (!rec) return;

  if (!isRecordDeleteSupported()) {
    showAlert('⚠️ מחיקת רשומות אינה נתמכת ב-API הנוכחי', 'error');
    return;
  }

  if (!canDeleteRecord(rec)) {
    showAlert('❌ אין לך הרשאה למחוק ימי עבודה', 'error');
    return;
  }

  if (!confirm('האם אתה בטוח שברצונך למחוק רשומה זו?')) return;

  showAlert('🗑️ מוחק רשומה...', 'info');

  try {
    const ok = await deleteRecordOnServer(rec);

    if (!ok) {
      showAlert('❌ מחיקה נכשלה בשרת', 'error');
      return;
    }

    await loadMyRecordsFromServer();
    showAlert('✅ הרשומה נמחקה מהשרת בהצלחה', 'success');
  } catch (e) {
    console.error(e);
    showAlert('❌ שגיאה במחיקה מהשרת', 'error');
  }
}

// =============== Edit Record ===============
async function editRecord(index) {
  const rec = records[index];

  if (!canEditRecord(rec)) {
    const reason = getEditBlockReason(rec);
    showAlert('❌ ' + (reason || 'אין לך הרשאה לערוך ימי עבודה'), 'error');
    return;
  }

  const canUpdate = await ensureMonthEditable(
    String(rec.empNum || localStorage.getItem("employeeId") || ''),
    rec.date || rec.attendanceDate
  );
  if (!canUpdate) {
    return;
  }
  
  editingIndex = index;
  
  document.getElementById('editDate').value = rec.date;
  setTimeDropdowns('editStart', rec.start || '');
  setTimeDropdowns('editEnd', rec.end || '');
  // Set hours - use hours field or calculate from start/end
  const hoursValue = rec.hours || rec.workHours || 0;
  document.getElementById('editHours').value = typeof hoursValue === 'number' ? hoursValue.toFixed(2) : hoursValue;
  document.getElementById('editActivity').value = rec.activity;
  
  const schoolSelect = document.getElementById('editSchool');
  schoolSelect.innerHTML = '<option value="">בחר בית ספר</option>';
  schoolsData.forEach(school => {
    const option = document.createElement('option');
    option.value = JSON.stringify(school);
    option.textContent = school['בית ספר'];
    if (school['בית ספר'] === rec.school) {
      option.selected = true;
    }
    schoolSelect.appendChild(option);
  });
  
  document.getElementById('editMunicipality').value = rec.municipality;
  document.getElementById('editProgram').value = rec.program || '';
  document.getElementById('editSession').value = rec.session || '';
  document.getElementById('editKm').value = rec.km || '';
  document.getElementById('editTotalExpenses').value = rec.totalExpenses || '';
  document.getElementById('editExpensesDetail').value = rec.expensesDetail || '';
  document.getElementById('editNotes').value = rec.notes || '';
  
  if (rec.school === 'זום') {
    document.getElementById('editKm').value = '0';
    document.getElementById('editKm').readOnly = true;
    document.getElementById('editKm').style.background = '#f1f5f9';
  } else {
    document.getElementById('editKm').readOnly = false;
    document.getElementById('editKm').style.background = 'white';
  }
  
  document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
  editingIndex = -1;
  adminEditRecordId = null;
}

function updateEditMunicipality() {
  const schoolSelect = document.getElementById('editSchool');
  const municipalityInput = document.getElementById('editMunicipality');
  const kmField = document.getElementById('editKm');
  
  if (schoolSelect.value) {
    try {
      const school = JSON.parse(schoolSelect.value);
      municipalityInput.value = school['רשות'];
      
      if (school['בית ספר'] === 'זום') {
        kmField.value = '0';
        kmField.readOnly = true;
        kmField.style.background = '#f1f5f9';
        kmField.style.cursor = 'not-allowed';
      } else {
        kmField.readOnly = false;
        kmField.style.background = 'white';
        kmField.style.cursor = 'text';
      }
    } catch(e) {
      console.error('שגיאה בעידכון רשות:', e);
    }
  }
}

async function saveEdit() {
  // Check if editing from admin dashboard or instructor view
  const isAdminEdit = adminEditRecordId !== null;
  
  if (editingIndex === -1 && !isAdminEdit) return;
  
  let originalDate, originalStartTime, originalEmployeeId, originalEmployeeName, originalTeam, originalEmploymentType;
  if (isAdminEdit) {
    // Find record in admin cache - preserve original employee data!
    let foundRec = null;
    for (const empId in adminEmployeeRecordsCache) {
      foundRec = adminEmployeeRecordsCache[empId].find(r => (r.ID || r.id) == adminEditRecordId);
      if (foundRec) break;
    }
    originalDate = foundRec?.attendanceDate || foundRec?.date;
    originalStartTime = foundRec?.startTime;
    // CRITICAL: Save original employee data to prevent overwriting with editor's data
    originalEmployeeId = foundRec?.employeeId || foundRec?.EmployeeId || foundRec?.empNum || '';
    originalEmployeeName = foundRec?.employeeName || foundRec?.EmployeeName || foundRec?.empName || '';
    originalTeam = foundRec?.team || foundRec?.Team || '';
    originalEmploymentType = foundRec?.employmentType || foundRec?.EmploymentType || '';
  } else {
    originalDate = records[editingIndex].date;
    originalStartTime = records[editingIndex].start;
  }
  
  const date = document.getElementById('editDate').value;
  const startTime = document.getElementById('editStartTime').value;
  const endTime = document.getElementById('editEndTime').value;
  const hours = parseFloat(document.getElementById('editHours').value) || 0;
  const activity = document.getElementById('editActivity').value;
  const schoolSelect = document.getElementById('editSchool');
  const municipality = document.getElementById('editMunicipality').value;
  const program = document.getElementById('editProgram').value;
  const session = document.getElementById('editSession').value;
  const km = parseFloat(document.getElementById('editKm').value) || 0;
  const totalExpenses = parseFloat(document.getElementById('editTotalExpenses').value) || 0;
  const expensesDetail = document.getElementById('editExpensesDetail').value;
  const notes = document.getElementById('editNotes').value;
  const attachmentsInput = document.getElementById('editAttachments');
  let attachments = [];
  if (!isAdminEdit && editingIndex >= 0 && records[editingIndex]) {
    attachments = records[editingIndex].attachments || [];
  }
  
  if (attachmentsInput.files.length > 0) {
    for (const file of attachmentsInput.files) {
      const base64 = await fileToBase64(file);
      attachments.push({ 
        name: file.name, 
        size: file.size,
        type: file.type,
        content: base64 
      });
    }
  }
  
  let school = '';
  if (schoolSelect.value) {
    try {
      const schoolData = JSON.parse(schoolSelect.value);
      school = schoolData['בית ספר'];
    } catch(e) {}
  }
  
  const missing = [];
  if (!date) missing.push('תאריך');
  if (!startTime) missing.push('שעת התחלה');
  if (!endTime) missing.push('שעת סיום');
  if (!hours) missing.push('שעות');
  if (!activity) missing.push('סוג פעילות');
  if (!school) missing.push('בית ספר');
  if (!municipality) missing.push('רשות');
  if (!program) missing.push('תוכנית');
  if (!session) missing.push('מספר מפגש');
  
  if (missing.length > 0) {
    showAlert('⚠️ אנא מלא את כל השדות החובה: ' + missing.join(', '), 'error');
    return;
  }
  
  // Build updated record object
  const updatedRecord = {
    date,
    attendanceDate: date,
    start: startTime,
    startTime: startTime,
    end: endTime,
    endTime: endTime,
    hours,
    workHours: hours,
    activity,
    activityType: activity,
    school,
    schoolName: school,
    municipality,
    location: '',
    program,
    programName: program,
    session,
    sessionNumber: session,
    km,
    kilometers: km,
    totalExpenses,
    expensesDetail,
    expensesDetails: expensesDetail,
    notes,
    attachments,
    status: 'pending'
  };
  
  showLoadingBar();

  try {
    if (isAdminEdit) {
      const ok = await updateRecordOnServer({
        ...updatedRecord,
        recordId: adminEditRecordId,
        id: adminEditRecordId,
        employeeId: originalEmployeeId,
        empNum: originalEmployeeId,
        employeeName: originalEmployeeName,
        empName: originalEmployeeName,
        team: originalTeam,
        employmentType: originalEmploymentType
      }, originalDate, originalStartTime);

      if (!ok) {
        hideLoadingBar();
        showAlert('⚠️ העדכון נכשל בשרת', 'error');
        closeEditModal();
        adminEditRecordId = null;
        return;
      }

      adminEditRecordId = null;
      closeEditModal();
      hideLoadingBar();
      updateAdminDashboard();
      showAlert('✅ הרשומה עודכנה בהצלחה', 'success');
    } else {
      records[editingIndex] = {
        ...records[editingIndex],
        ...updatedRecord
      };
      
      const ok = await updateRecordOnServer(records[editingIndex], originalDate, originalStartTime);

      if (!ok) {
        hideLoadingBar();
        showAlert('⚠️ העדכון נשמר מקומית אבל נכשל בשרת', 'error');
        saveToLocalStorage();
        updateStats();
        renderRecordsTable();
        closeEditModal();
        return;
      }

      closeEditModal();
      hideLoadingBar();
      await loadMyRecordsFromServer();
      showAlert('✅ הרשומה עודכנה בהצלחה ונשמרה בשרת', 'success');
    }
  } catch (e) {
    hideLoadingBar();
    console.error(e);
    showAlert('❌ שגיאה בעדכון הרשומה בשרת', 'error');
    if (!isAdminEdit) {
      saveToLocalStorage();
      updateStats();
      renderRecordsTable();
    }
    closeEditModal();
    adminEditRecordId = null;
  }
}

// =============== Schools Functions ===============
function populateSchools() {
  const optionsContainer = document.getElementById('schoolDropdownOptions');
  if (!optionsContainer) return;
  
  optionsContainer.innerHTML = '';
  
  schoolsData.forEach((school, index) => {
    const option = document.createElement('div');
    option.className = 'searchable-dropdown-option';
    option.dataset.value = JSON.stringify(school);
    option.dataset.searchText = `${school['בית ספר']} ${school['רשות']}`.toLowerCase();
    option.textContent = `${school['בית ספר']} (${school['רשות']})`;
    option.onclick = () => selectSchool(school);
    optionsContainer.appendChild(option);
  });
}

function toggleSearchableDropdown(dropdownId) {
  const dropdown = document.getElementById(dropdownId);
  const menu = dropdown.querySelector('.searchable-dropdown-menu');
  const isOpen = menu.classList.contains('open');
  
  // Close all other dropdowns
  document.querySelectorAll('.searchable-dropdown-menu.open').forEach(m => m.classList.remove('open'));
  
  if (!isOpen) {
    menu.classList.add('open');
    const searchInput = menu.querySelector('input');
    if (searchInput) {
      setTimeout(() => searchInput.focus(), 100);
    }
  }
}

function filterSchoolDropdown(searchText) {
  const options = document.querySelectorAll('#schoolDropdownOptions .searchable-dropdown-option');
  const searchLower = searchText.toLowerCase();
  
  options.forEach(option => {
    const text = option.dataset.searchText || option.textContent.toLowerCase();
    if (text.includes(searchLower)) {
      option.classList.remove('hidden');
    } else {
      option.classList.add('hidden');
    }
  });
}

function selectSchool(school) {
  const hiddenField = document.getElementById('schoolField');
  const displayField = document.getElementById('schoolFieldDisplay');
  const menu = document.getElementById('schoolDropdownMenu');
  
  hiddenField.value = JSON.stringify(school);
  displayField.textContent = school['בית ספר'];
  menu.classList.remove('open');
  
  // Clear search
  const searchInput = document.getElementById('schoolSearchInput');
  if (searchInput) searchInput.value = '';
  filterSchoolDropdown('');
  
  // Update municipality
  updateMunicipalityFromSchool();
  
  // Mark selected option
  document.querySelectorAll('#schoolDropdownOptions .searchable-dropdown-option').forEach(opt => {
    opt.classList.remove('selected');
    if (opt.dataset.value === JSON.stringify(school)) {
      opt.classList.add('selected');
    }
  });
}

function updateMunicipalityFromSchool() {
  const schoolSelect = document.getElementById('schoolField');
  const municipalityInput = document.getElementById('municipality');
  const kmField = document.getElementById('kmField');
  
  if (schoolSelect.value) {
    try {
      const school = JSON.parse(schoolSelect.value);
      municipalityInput.value = school['רשות'];
      
      if (school['בית ספר'] === 'זום') {
        kmField.value = '0';
        kmField.readOnly = true;
        kmField.style.background = '#f1f5f9';
        kmField.style.cursor = 'not-allowed';
        kmField.removeAttribute('required');
      } else {
        kmField.readOnly = false;
        kmField.style.background = 'white';
        kmField.style.cursor = 'text';
      }
    } catch(e) {
      console.error('שגיאה בעידכון רשות:', e);
    }
  }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.searchable-dropdown')) {
    document.querySelectorAll('.searchable-dropdown-menu.open').forEach(m => m.classList.remove('open'));
  }
});

// =============== Export & Clear ===============
function normalizeExportRecord(rec) {
  if (!rec) return null;
  return {
    employeeId: rec.employeeId || rec.empNum || rec.EmployeeId || '',
    employeeName: rec.employeeName || rec.empName || rec.EmployeeName || '',
    attendanceDate: rec.attendanceDate || rec.date || rec.AttendanceDate || '',
    startTime: rec.startTime || rec.start || rec.StartTime || '',
    endTime: rec.endTime || rec.end || rec.EndTime || '',
    workHours: Number(rec.workHours || rec.hours || rec.WorkHours || 0),
    activityType: rec.activityType || rec.activity || rec.ActivityType || '',
    schoolName: rec.schoolName || rec.school || rec.SchoolName || '',
    municipality: rec.municipality || rec.Municipality || '',
    programName: rec.programName || rec.program || rec.ProgramName || '',
    sessionNumber: rec.sessionNumber || rec.session || rec.SessionNumber || '',
    kilometers: Number(rec.kilometers || rec.km || rec.Kilometers || 0),
    totalExpenses: Number(rec.totalExpenses || rec.TotalExpenses || 0),
    expensesDetails: rec.expensesDetails || rec.expensesDetail || rec.ExpensesDetails || '',
    notes: rec.notes || rec.Notes || '',
    attachmentsNames: rec.attachmentsNames || formatAttachments(rec.attachments || []),
    team: rec.team || rec.Team || '',
    employmentType: normalizeEmploymentType(rec, '')
  };
}

function getMonthLabelFromKey(monthKey) {
  if (!monthKey) return 'כל התקופה';
  const [year, month] = monthKey.split('-');
  const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
  return `חודש ${monthNames[Number(month) - 1]} ${year}`;
}

function getMonthKeyFromRecords(recordsList) {
  const monthKeys = new Set();
  recordsList.forEach(rec => {
    const dateValue = rec.attendanceDate || rec.date || rec.AttendanceDate;
    if (!dateValue) return;
    const date = new Date(dateValue);
    if (Number.isNaN(date.getTime())) return;
    monthKeys.add(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
  });
  return monthKeys.size === 1 ? Array.from(monthKeys)[0] : null;
}

function createDetailedSheet(recordsList, options = {}) {
  const hideEmploymentType = options.hideEmploymentType || false;
  
  const headers = [
    'מספר עובד',
    'שם עובד',
    'תאריך',
    'שעת התחלה',
    'שעת סיום',
    'שעות עבודה',
    'סוג פעילות',
    'שם בית ספר',
    'רשות',
    'שם תכנית',
    'מספר מפגש',
    'קילומטרים',
    'הוצאות',
    'פירוט הוצאות',
    'הערות',
    'קבצים מצורפים',
    'צוות'
  ];
  
  if (!hideEmploymentType) {
    headers.push('סוג העסקה');
  }

  const data = [headers];
  recordsList.forEach(rec => {
    const row = [
      rec.employeeId || '',
      rec.employeeName || '',
      rec.attendanceDate || '',
      rec.startTime || '',
      rec.endTime || '',
      rec.workHours ? rec.workHours.toFixed(1) : '0.0',
      rec.activityType || '',
      rec.schoolName || '',
      rec.municipality || '',
      rec.programName || '',
      rec.sessionNumber || '',
      rec.kilometers || 0,
      rec.totalExpenses || 0,
      rec.expensesDetails || '',
      rec.notes || '',
      rec.attachmentsNames || '',
      rec.team || ''
    ];
    
    if (!hideEmploymentType) {
      row.push(rec.employmentType || '');
    }
    
    data.push(row);
  });

  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!cols'] = headers.map(() => ({ wch: 16 }));
  return ws;
}

function createMonthlySummarySheet(recordsList, monthKey) {
  const monthLabel = getMonthLabelFromKey(monthKey);
  const activityColumns = [...ACTIVITY_TYPES, 'אחר'];
  const data = [[
    'חודש',
    'סוג העסקה',
    'שם מדריך',
    'מספר עובד',
    ...activityColumns.map(type => `שעות ${type}`),
    'סה"כ קילומטרים'
  ]];

  const summaries = {};
  recordsList.forEach(rec => {
    const key = rec.employeeId || rec.employeeName;
    if (!summaries[key]) {
      summaries[key] = {
        employeeId: rec.employeeId || '',
        employeeName: rec.employeeName || '',
        employmentType: rec.employmentType || '',
        activityHours: activityColumns.reduce((acc, type) => {
          acc[type] = 0;
          return acc;
        }, {}),
        kilometers: 0
      };
    }

    const activity = rec.activityType || 'אחר';
    const mappedActivity = activityColumns.includes(activity) ? activity : 'אחר';
    summaries[key].activityHours[mappedActivity] += rec.workHours || 0;
    summaries[key].kilometers += rec.kilometers || 0;
  });

  Object.values(summaries).forEach(summary => {
    data.push([
      monthLabel,
      summary.employmentType,
      summary.employeeName,
      summary.employeeId,
      ...activityColumns.map(type => summary.activityHours[type].toFixed(1)),
      summary.kilometers.toFixed(1)
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!cols'] = data[0].map(() => ({ wch: 16 }));
  return ws;
}

function timeToMinutes(timeValue) {
  if (!timeValue) return null;
  const [hours, minutes] = timeValue.split(':').map(Number);
  if (Number.isNaN(hours) || Number.isNaN(minutes)) return null;
  return hours * 60 + minutes;
}

function minutesToTime(totalMinutes) {
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

function createDailyConsolidatedSheet(recordsList) {
  const data = [[
    'תאריך',
    'שם מדריך',
    'מספר עובד',
    'סוג פעילות',
    'שעת התחלה',
    'שעת סיום',
    'שעות עבודה',
    'קילומטרים',
    'הוצאות'
  ]];

  const grouped = {};
  recordsList.forEach(rec => {
    const key = `${rec.attendanceDate || ''}|${rec.employeeId || ''}|${rec.activityType || ''}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(rec);
  });

  Object.values(grouped).forEach(group => {
    const sorted = group.slice().sort((a, b) => {
      const aMinutes = timeToMinutes(a.startTime) ?? 0;
      const bMinutes = timeToMinutes(b.startTime) ?? 0;
      return aMinutes - bMinutes;
    });

    let current = null;
    sorted.forEach(rec => {
      const startMinutes = timeToMinutes(rec.startTime);
      const endMinutes = timeToMinutes(rec.endTime);

      if (!current) {
        current = {
          ...rec,
          startMinutes,
          endMinutes,
          totalKm: rec.kilometers || 0,
          totalExpenses: rec.totalExpenses || 0
        };
        return;
      }

      if (startMinutes !== null && endMinutes !== null && current.endMinutes !== null && startMinutes <= current.endMinutes) {
        current.endMinutes = Math.max(current.endMinutes, endMinutes);
        current.totalKm += rec.kilometers || 0;
        current.totalExpenses += rec.totalExpenses || 0;
      } else {
        const durationHours = current.startMinutes !== null && current.endMinutes !== null
          ? (current.endMinutes - current.startMinutes) / 60
          : current.workHours || 0;
        data.push([
          current.attendanceDate || '',
          current.employeeName || '',
          current.employeeId || '',
          current.activityType || '',
          current.startMinutes !== null ? minutesToTime(current.startMinutes) : (current.startTime || ''),
          current.endMinutes !== null ? minutesToTime(current.endMinutes) : (current.endTime || ''),
          durationHours.toFixed(1),
          current.totalKm.toFixed(1),
          current.totalExpenses.toFixed(1)
        ]);
        current = {
          ...rec,
          startMinutes,
          endMinutes,
          totalKm: rec.kilometers || 0,
          totalExpenses: rec.totalExpenses || 0
        };
      }
    });

    if (current) {
      const durationHours = current.startMinutes !== null && current.endMinutes !== null
        ? (current.endMinutes - current.startMinutes) / 60
        : current.workHours || 0;
      data.push([
        current.attendanceDate || '',
        current.employeeName || '',
        current.employeeId || '',
        current.activityType || '',
        current.startMinutes !== null ? minutesToTime(current.startMinutes) : (current.startTime || ''),
        current.endMinutes !== null ? minutesToTime(current.endMinutes) : (current.endTime || ''),
        durationHours.toFixed(1),
        current.totalKm.toFixed(1),
        current.totalExpenses.toFixed(1)
      ]);
    }
  });

  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!cols'] = data[0].map(() => ({ wch: 16 }));
  return ws;
}

function exportAttendanceWorkbook(recordsList, options = {}) {
  if (!isExportSupported()) {
    showAlert('⚠️ ייצוא נתונים אינו נתמך ב-API הנוכחי', 'error');
    return;
  }
  if (!window.XLSX) {
    showAlert('ספריית Excel לא נטענה', 'error');
    return;
  }

  const normalizedRecords = recordsList.map(normalizeExportRecord).filter(Boolean);
  if (normalizedRecords.length === 0) {
    showAlert('⚠️ אין נתונים לייצוא', 'error');
    return;
  }

  const wb = XLSX.utils.book_new();
  const monthKey = options.monthKey || getMonthKeyFromRecords(normalizedRecords);

  XLSX.utils.book_append_sheet(wb, createDetailedSheet(normalizedRecords, { hideEmploymentType: options.hideEmploymentType }), 'פירוט מלא');

  if (options.includeSummary) {
    XLSX.utils.book_append_sheet(wb, createMonthlySummarySheet(normalizedRecords, monthKey), 'סיכום חודשי');
    XLSX.utils.book_append_sheet(wb, createDailyConsolidatedSheet(normalizedRecords), 'תצוגה יומית');
  }

  const filePrefix = options.filePrefix || 'דוח_נוכחות';
  const fileDate = new Date().toISOString().slice(0, 10);
  const filename = `${filePrefix}_${fileDate}.xlsx`;
  XLSX.writeFile(wb, filename);

  showAlert('✅ הקובץ יוצא בהצלחה!', 'success');
}

function exportToExcel() {
  const user = getCurrentUserData();
  const isInstructor = user?.role === 'instructor';
  exportAttendanceWorkbook(records, {
    includeSummary: !isInstructor,
    hideEmploymentType: isInstructor,
    filePrefix: 'דוח_נוכחות'
  });
}
// =============== Excel Export Functions - FIXED VERSION ===============

/**
 * Export team approval status to Excel
 * Creates a workbook with 3 sheets:
 * 1. Approval Status Summary
 * 2. Detailed Records
 * 3. Hours Summary
 */
async function exportTeamApprovalToExcel() {
  try {
    showAlert('מכין קובץ Excel...', 'info');

    const team = localStorage.getItem('team');
    const currentMonth = new Date().toISOString().slice(0, 7); // "2026-01"
    const monthName = getHebrewMonthName(currentMonth);

    // Get records from cache (teamRecordsCache is populated by loadTeamRecords)
    const records = typeof teamRecordsCache !== 'undefined' ? teamRecordsCache : [];

    // Calculate approval data FROM records
    const approvalEmployees = calculateApprovalDataFromRecords(records);

    // Create workbook
    const wb = XLSX.utils.book_new();

    // Sheet 1: Approval Status (only if we have approvals)
    if (approvalEmployees.length > 0) {
      const approvalSheet = createApprovalSheet(approvalEmployees, monthName);
      XLSX.utils.book_append_sheet(wb, approvalSheet, 'סטטוס אישורים');
    }

    // Sheet 2: Detailed Records (only if we have records)
    if (records.length > 0) {
      const recordsSheet = createRecordsSheet(records);
      XLSX.utils.book_append_sheet(wb, recordsSheet, 'רשומות מפורטות');

      // Sheet 3: Hours Summary
      const summarySheet = createSummarySheet(records);
      XLSX.utils.book_append_sheet(wb, summarySheet, 'סיכום שעות');
    }

    if (wb.SheetNames.length === 0) {
      showAlert('אין נתונים לייצוא', 'error');
      return;
    }

    // Generate filename
    const filename = `דוח_נוכחות_צוות_${team}_${monthName}_${new Date().toISOString().slice(0, 10)}.xlsx`;

    // Download
    XLSX.writeFile(wb, filename);

    showAlert('הקובץ הורד בהצלחה!', 'success');

  } catch (error) {
    console.error('Excel export error:', error);
    showAlert('שגיאה ביצירת קובץ Excel', 'error');
  }
}

/**
 * Calculate approval data from records (since it doesn't come from API)
 */
function calculateApprovalDataFromRecords(records) {
  const employeeMap = {};
  
  records.forEach(rec => {
    const empId = rec.employeeId;
    if (!employeeMap[empId]) {
      employeeMap[empId] = {
        employeeName: rec.employeeName,
        employeeId: rec.employeeId,
        approvalDate: rec.ApprovalDate || rec.approvalDate || null,
        totalHours: 0,
        recordCount: 0
      };
    }
    
    employeeMap[empId].totalHours += Number(rec.workHours) || 0;
    employeeMap[empId].recordCount += 1;
    
    // Take the latest approval date if exists
    if (rec.ApprovalDate || rec.approvalDate) {
      const currentDate = rec.ApprovalDate || rec.approvalDate;
      if (!employeeMap[empId].approvalDate || new Date(currentDate) > new Date(employeeMap[empId].approvalDate)) {
        employeeMap[empId].approvalDate = currentDate;
      }
    }
  });
  
  return Object.values(employeeMap);
}

/**
 * Create approval status sheet
 */
function createApprovalSheet(employees, monthName) {
  const data = [];
  
  // Header
  data.push(['דוח סטטוס אישורים - ' + monthName]);
  data.push(['צוות: ' + localStorage.getItem('team')]);
  data.push(['תאריך הפקה: ' + formatDate(new Date())]);
  data.push([]); // Empty row
  
  // Column headers
  data.push([
    'שם עובד',
    'תעודת זהות',
    'תאריך אישור',
    'סטטוס',
    'סה״כ שעות',
    'סה״כ רשומות'
  ]);
  
  // Data rows
  let totalApproved = 0;
  let totalHours = 0;
  let totalRecords = 0;
  
  employees.forEach(emp => {
    const approved = emp.approvalDate ? 'אושר' : 'ממתין';
    if (emp.approvalDate) totalApproved++;
    totalHours += emp.totalHours || 0;
    totalRecords += emp.recordCount || 0;
    
    data.push([
      emp.employeeName || '',
      emp.employeeId || '',
      emp.approvalDate ? formatDate(emp.approvalDate) : '—',
      approved,
      emp.totalHours ? emp.totalHours.toFixed(1) : '0.0',
      emp.recordCount || 0
    ]);
  });
  
  // Summary row
  data.push([]); // Empty row
  data.push([
    'סה״כ',
    '',
    '',
    `${totalApproved}/${employees.length} אישרו`,
    totalHours.toFixed(1),
    totalRecords
  ]);
  
  // Create sheet
  const ws = XLSX.utils.aoa_to_sheet(data);
  
  // Set column widths
  ws['!cols'] = [
    { wch: 20 }, // שם עובד
    { wch: 15 }, // ת.ז.
    { wch: 15 }, // תאריך אישור
    { wch: 10 }, // סטטוס
    { wch: 12 }, // שעות
    { wch: 12 }  // רשומות
  ];
  
  return ws;
}

/**
 * Create detailed records sheet
 */
function createRecordsSheet(records) {
  const data = [];
  
  // Header
  data.push(['רשומות נוכחות מפורטות']);
  data.push([]); // Empty row
  
  // Column headers
  data.push([
    'שם עובד',
    'תאריך',
    'שעת התחלה',
    'שעת סיום',
    'שעות עבודה',
    'סוג פעילות',
    'שם בית ספר',
    'רשות',
    'שם תכנית',
    'קילומטרים',
    'הוצאות',
    'הערות'
  ]);
  
  // Data rows
  records.forEach(rec => {
    data.push([
      rec.employeeName || '',
      formatDate(rec.attendanceDate),
      rec.startTime || '',
      rec.endTime || '',
      rec.workHours ? Number(rec.workHours).toFixed(1) : '0.0',
      rec.activityType || '',
      rec.schoolName || '',
      rec.municipality || '',
      rec.programName || '',
      rec.kilometers || 0,
      rec.totalExpenses || 0,
      rec.notes || ''
    ]);
  });
  
  // Create sheet
  const ws = XLSX.utils.aoa_to_sheet(data);
  
  // Set column widths
  ws['!cols'] = [
    { wch: 20 }, // שם
    { wch: 12 }, // תאריך
    { wch: 10 }, // התחלה
    { wch: 10 }, // סיום
    { wch: 10 }, // שעות
    { wch: 15 }, // סוג
    { wch: 20 }, // בית ספר
    { wch: 15 }, // רשות
    { wch: 20 }, // תכנית
    { wch: 10 }, // ק״מ
    { wch: 10 }, // הוצאות
    { wch: 30 }  // הערות
  ];
  
  return ws;
}

/**
 * Create hours summary sheet
 */
function createSummarySheet(records) {
  const data = [];
  
  // Header
  data.push(['סיכום שעות ופעילות']);
  data.push([]); // Empty row
  
  // Column headers
  data.push([
    'שם עובד',
    'שעות עבודה',
    'קילומטרים',
    'הוצאות',
    'מספר מפגשים',
    'ממוצע שעות למפגש'
  ]);
  
  // Calculate summaries
  const summaries = {};
  
  records.forEach(rec => {
    const empId = rec.employeeId;
    if (!summaries[empId]) {
      summaries[empId] = {
        name: rec.employeeName,
        hours: 0,
        km: 0,
        expenses: 0,
        sessions: 0
      };
    }
    
    summaries[empId].hours += Number(rec.workHours) || 0;
    summaries[empId].km += Number(rec.kilometers) || 0;
    summaries[empId].expenses += Number(rec.totalExpenses) || 0;
    summaries[empId].sessions += 1;
  });
  
  // Data rows
  let totalHours = 0;
  let totalKm = 0;
  let totalExpenses = 0;
  let totalSessions = 0;
  
  Object.values(summaries).forEach(sum => {
    const avgHours = sum.sessions > 0 ? sum.hours / sum.sessions : 0;
    
    data.push([
      sum.name,
      sum.hours.toFixed(1),
      sum.km,
      sum.expenses,
      sum.sessions,
      avgHours.toFixed(1)
    ]);
    
    totalHours += sum.hours;
    totalKm += sum.km;
    totalExpenses += sum.expenses;
    totalSessions += sum.sessions;
  });
  
  // Summary row
  data.push([]); // Empty row
  const avgTotal = totalSessions > 0 ? totalHours / totalSessions : 0;
  data.push([
    'סה״כ',
    totalHours.toFixed(1),
    totalKm,
    totalExpenses,
    totalSessions,
    avgTotal.toFixed(1)
  ]);
  
  // Create sheet
  const ws = XLSX.utils.aoa_to_sheet(data);
  
  // Set column widths
  ws['!cols'] = [
    { wch: 20 }, // שם
    { wch: 12 }, // שעות
    { wch: 12 }, // ק״מ
    { wch: 12 }, // הוצאות
    { wch: 15 }, // מפגשים
    { wch: 15 }  // ממוצע
  ];
  
  return ws;
}

/**
 * Get Hebrew month name from YYYY-MM format
 */
function getHebrewMonthName(monthStr) {
  const months = {
    '01': 'ינואר', '02': 'פברואר', '03': 'מרץ',
    '04': 'אפריל', '05': 'מאי', '06': 'יוני',
    '07': 'יולי', '08': 'אוגוסט', '09': 'ספטמבר',
    '10': 'אוקטובר', '11': 'נובמבר', '12': 'דצמבר'
  };
  
  const [year, month] = monthStr.split('-');
  return `${months[month]} ${year}`;
}

/**
 * Quick export - just approval status (faster)
 */
async function exportApprovalStatusOnly() {
  try {
    showAlert('מכין קובץ...', 'info');

    const team = localStorage.getItem('team');
    const currentMonth = new Date().toISOString().slice(0, 7);
    const monthName = getHebrewMonthName(currentMonth);

    const records = typeof teamRecordsCache !== 'undefined' ? teamRecordsCache : [];
    const approvalEmployees = calculateApprovalDataFromRecords(records);

    if (approvalEmployees.length === 0) {
      showAlert('אין נתוני אישורים לייצוא', 'error');
      return;
    }

    const wb = XLSX.utils.book_new();
    const ws = createApprovalSheet(approvalEmployees, monthName);
    XLSX.utils.book_append_sheet(wb, ws, 'סטטוס אישורים');

    const filename = `סטטוס_אישורים_${team}_${monthName}.xlsx`;
    XLSX.writeFile(wb, filename);

    showAlert('הקובץ הורד בהצלחה!', 'success');

  } catch (error) {
    console.error('Excel export error:', error);
    showAlert('שגיאה ביצירת קובץ', 'error');
  }
}
// =============== Admin/Controller Dashboard Functions ===============
let adminEmployeeRecordsCache = {}; // Cache for expanded employee records
let adminDashboardRecordsCache = []; // Cache for export data

function loadAdminDashboard() {
  // Set default month/year if not already set
  const now = new Date();
  const monthEl = document.getElementById('dashboardMonth');
  const yearEl = document.getElementById('dashboardYear');
  console.log('loadAdminDashboard - current date:', now.getMonth() + 1, '/', now.getFullYear());
  if (monthEl && !monthEl.dataset.initialized) {
    monthEl.value = now.getMonth() + 1;
    monthEl.dataset.initialized = 'true';
    console.log('loadAdminDashboard - initialized month to:', monthEl.value);
  }
  if (yearEl && !yearEl.dataset.initialized) {
    yearEl.value = now.getFullYear();
    yearEl.dataset.initialized = 'true';
    console.log('loadAdminDashboard - initialized year to:', yearEl.value);
  }
  console.log('loadAdminDashboard - selector values: month=', monthEl?.value, 'year=', yearEl?.value);
  updateAdminDashboard();
  // Also load approvals status in the dashboard
  loadApprovalsStatusPage();
}

async function updateAdminDashboard() {
  const tbody = document.getElementById('adminDashboardTableBody');
  const mobileContainer = document.getElementById('adminMobileCardsContainer');
  if (!tbody && !mobileContainer) return;
  
  // Silent loading - dim existing content
  if (tbody && tbody.innerHTML.trim()) setSilentLoading('adminDashboardTableBody', true);
  if (mobileContainer && mobileContainer.innerHTML.trim()) setSilentLoading('adminMobileCardsContainer', true);
  showLoadingBar();
  
  const filterEmploymentType = document.getElementById('filterEmploymentType')?.value || 'all';
  const filterTeam = document.getElementById('filterTeam')?.value || 'all';
  
  // Get month/year from filters - managers/admin use dashboardMonth/Year, instructors use instructorMonth/Year
  const now = new Date();
  const user = getCurrentUserData();
  const isInstructor = user && user.role === 'instructor';
  
  // Select the correct month/year elements based on role
  const dashboardMonthEl = isInstructor 
    ? document.getElementById('instructorMonth') 
    : (document.getElementById('dashboardMonth') || document.getElementById('instructorMonth'));
  const dashboardYearEl = isInstructor 
    ? document.getElementById('instructorYear') 
    : (document.getElementById('dashboardYear') || document.getElementById('instructorYear'));
  
  console.log('updateAdminDashboard - role:', user?.role, 'monthEl:', dashboardMonthEl?.id, 'value:', dashboardMonthEl?.value);
  console.log('updateAdminDashboard - yearEl:', dashboardYearEl?.id, 'value:', dashboardYearEl?.value);
  
  const currentMonth = dashboardMonthEl ? parseInt(dashboardMonthEl.value) - 1 : now.getMonth();
  const currentYear = dashboardYearEl ? parseInt(dashboardYearEl.value) : now.getFullYear();
  
  console.log('updateAdminDashboard - filtering for month:', currentMonth, 'year:', currentYear);
  
  // Get user role to check permissions
  const userRole = localStorage.getItem('role') || '';
  
  let employeesMap = {};
  
  // Fetch employees list for employmentType data
  try {
    const empData = await apiRequest('getallemployees', {});
    if (empData.success && Array.isArray(empData.employees)) {
      empData.employees.forEach(emp => {
        const empId = emp.employeeId || emp.EmployeeId || '';
        if (empId) {
          employeesMap[empId] = {
            name: emp.employeeName || emp.EmployeeName || emp.Title || '',
            team: extractLookupValue(emp.Team || emp.team || '', ''),
            employmentType: normalizeEmploymentType(emp, ''),
            role: emp.role || ''
          };
        }
      });
      console.log('Loaded employeesMap with', Object.keys(employeesMap).length, 'employees');
    }
  } catch (e) {
    console.warn('Could not load employees list:', e.message);
  }
  
  // Fetch all records from server
  try {
    const data = await apiRequest('getsummary', {});
    
    if (!data.success || !Array.isArray(data.records)) {
      hideLoadingBar();
      setSilentLoading('adminDashboardTableBody', false);
      setSilentLoading('adminMobileCardsContainer', false);
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #64748b;">אין נתונים להצגה</td></tr>';
      return;
    }
    
    // Helper to extract value from SharePoint lookup fields
    const extractValue = (field) => {
      if (!field) return '';
      if (typeof field === 'string') return field;
      if (typeof field === 'object' && field.Value) return field.Value;
      if (typeof field === 'object' && field.value) return field.value;
      if (typeof field === 'object' && field.LookupValue) return field.LookupValue;
      return '';
    };
    
    // Filter to current month - support both DD/MM/YYYY and YYYY-MM-DD formats
    console.log('=== Admin Dashboard Date Filtering ===');
    console.log('Total records from server:', data.records.length);
    console.log('Filter for month:', currentMonth + 1, 'year:', currentYear);
    
    const currentMonthRecords = data.records.filter(rec => {
      if (!rec.attendanceDate) return false;
      const dateStr = rec.attendanceDate;
      let recMonth, recYear;
      if (dateStr.includes('/')) {
        const parts = dateStr.split('/');
        if (parts.length < 3) return false;
        recMonth = parseInt(parts[1]) - 1;
        recYear = parseInt(parts[2]);
      } else if (dateStr.includes('-')) {
        const parts = dateStr.split('-');
        if (parts.length < 3) return false;
        recYear = parseInt(parts[0]);
        recMonth = parseInt(parts[1]) - 1;
      } else {
        console.log('Unknown date format:', dateStr);
        return false;
      }
      return recMonth === currentMonth && recYear === currentYear;
    });
    
    console.log('Records after month filter:', currentMonthRecords.length);
    
    // Group by employee
    const employeeData = {};
    
    currentMonthRecords.forEach(rec => {
      const empId = rec.employeeId || 'unknown';
      const empName = extractValue(rec.employeeName) || extractValue(rec.EmployeeName) || 'לא ידוע';
      
      // Try to get employmentType and team from employees list first
      const empFromList = employeesMap[empId];
      const team = (empFromList && empFromList.team) || extractValue(rec.team) || extractValue(rec.Team) || '-';
      const empType = (empFromList && empFromList.employmentType) || normalizeEmploymentType(rec, '');
      
      if (!employeeData[empId]) {
        employeeData[empId] = {
          empId: empId,
          empName: (empFromList && empFromList.name) || empName,
          team: team,
          employmentType: empType,
          totalRecords: 0,
          totalHours: 0,
          totalKm: 0,
          totalExpenses: 0,
          records: []
        };
      } else {
        // עדכן employmentType רק אם הנוכחי לא ריק והשמור הוא ברירת מחדל
        if (empType && empType !== '' && (!employeeData[empId].employmentType || employeeData[empId].employmentType === '')) {
          employeeData[empId].employmentType = empType;
        }
        // עדכן team רק אם הנוכחי לא ריק והשמור ריק
        if (team && team !== '-' && (!employeeData[empId].team || employeeData[empId].team === '-')) {
          employeeData[empId].team = team;
        }
      }
      
      employeeData[empId].totalRecords++;
      employeeData[empId].totalHours += parseFloat(rec.workHours || rec.hours || 0);
      employeeData[empId].totalKm += parseFloat(rec.kilometers || rec.km || 0);
      employeeData[empId].totalExpenses += parseFloat(rec.totalExpenses || 0);
      employeeData[empId].records.push(rec);
    });
    
    // Apply filters
    let filteredEmployees = Object.values(employeeData);
    
    // For managers - filter to their team only (case-insensitive)
    const currentUser = getCurrentUserData();
    if (currentUser && currentUser.role === 'manager' && currentUser.team) {
      const managerTeam = currentUser.team.trim().toLowerCase();
      console.log('Dashboard manager team filter:', currentUser.team, '- Total employees before filter:', filteredEmployees.length);
      filteredEmployees = filteredEmployees.filter(emp => {
        const empTeam = (emp.team || '').trim().toLowerCase();
        return empTeam === managerTeam;
      });
      console.log('After team filter:', filteredEmployees.length, 'employees');
    }
    
    if (filterEmploymentType !== 'all') {
      filteredEmployees = filteredEmployees.filter(emp => emp.employmentType === filterEmploymentType);
    }
    
    if (filterTeam !== 'all') {
      filteredEmployees = filteredEmployees.filter(emp => {
        const empTeam = (emp.team || '').trim().toLowerCase();
        return empTeam === filterTeam.trim().toLowerCase();
      });
    }
    
    // Sort by name
    filteredEmployees.sort((a, b) => a.empName.localeCompare(b.empName, 'he'));
    
    // Store in cache
    adminEmployeeRecordsCache = {};
    filteredEmployees.forEach(emp => {
      adminEmployeeRecordsCache[emp.empId] = emp.records;
    });
    adminDashboardRecordsCache = filteredEmployees.flatMap(emp => emp.records);
    
    // Render table
    hideLoadingBar();
    setSilentLoading('adminDashboardTableBody', false);
    setSilentLoading('adminMobileCardsContainer', false);
    
    if (filteredEmployees.length === 0) {
      if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #64748b;">אין נתונים להצגה לפי הסינונים שנבחרו</td></tr>';
      if (mobileContainer) mobileContainer.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">אין נתונים להצגה</p>';
      return;
    }
    
    // Desktop table
    if (tbody) {
      tbody.innerHTML = filteredEmployees.map(emp => `
        <tr class="employee-row" onclick="toggleAdminEmployeeDetails('${emp.empId}')" style="cursor: pointer;">
          <td style="padding: 10px 8px; text-align: center;">
            <i class="fas fa-chevron-left" id="admin-chevron-${emp.empId}" style="transition: transform 0.3s; color: #64748b;"></i>
          </td>
          <td style="padding: 10px 8px; text-align: right;">${emp.empId}</td>
          <td style="padding: 10px 8px; text-align: right; font-weight: 500; color: #3b82f6;">${emp.empName}</td>
          <td style="padding: 10px 8px; text-align: center;">${emp.team}</td>
          <td style="padding: 10px 8px; text-align: center;">${emp.employmentType}</td>
          <td style="padding: 10px 8px; text-align: center; font-weight: 600;">${emp.totalHours.toFixed(1)}</td>
          <td style="padding: 10px 8px; text-align: center;">${emp.totalKm.toFixed(0)}</td>
          <td style="padding: 10px 8px; text-align: center;">${emp.totalExpenses.toFixed(0)} ₪</td>
        </tr>
        <tr id="admin-details-${emp.empId}" class="employee-details-row" style="display: none;">
          <td colspan="8" style="padding: 0; background: #f8fafc;">
            <div id="admin-details-content-${emp.empId}" style="padding: 20px;">
              <!-- Will be filled when expanded -->
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    // Mobile cards
    if (mobileContainer) {
      mobileContainer.innerHTML = filteredEmployees.map(emp => `
        <div class="content-card" style="margin-bottom: 12px; padding: 15px;" onclick="toggleMobileAdminDetails('${emp.empId}')">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #3b82f6; font-size: 16px;">${emp.empName}</span>
            <span style="background: #e2e8f0; padding: 4px 10px; border-radius: 12px; font-size: 12px;">${emp.team}</span>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; color: #475569;">
            <div><i class="fas fa-id-badge" style="width: 18px; color: #94a3b8;"></i> ${emp.empId}</div>
            <div><i class="fas fa-briefcase" style="width: 18px; color: #94a3b8;"></i> ${emp.employmentType}</div>
            <div><i class="fas fa-clock" style="width: 18px; color: #94a3b8;"></i> ${emp.totalHours.toFixed(1)} שעות</div>
            <div><i class="fas fa-road" style="width: 18px; color: #94a3b8;"></i> ${emp.totalKm.toFixed(0)} ק"מ</div>
            <div><i class="fas fa-shekel-sign" style="width: 18px; color: #94a3b8;"></i> ${emp.totalExpenses.toFixed(0)} ₪</div>
          </div>
          <div id="mobile-details-${emp.empId}" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
            <!-- יתמלא בלחיצה -->
          </div>
        </div>
      `).join('');
    }
    
  } catch (error) {
    console.error('Error loading admin dashboard:', error);
    hideLoadingBar();
    setSilentLoading('adminDashboardTableBody', false);
    setSilentLoading('adminMobileCardsContainer', false);
    if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #ef4444;">שגיאה בטעינת נתונים</td></tr>';
    if (mobileContainer) mobileContainer.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 40px;">שגיאה בטעינת נתונים</p>';
  }
}

// Toggle mobile employee details
// Toggle week details in instructor records view
function toggleWeekDetails(weekId) {
  const weekDiv = document.getElementById(weekId);
  if (!weekDiv) return;
  weekDiv.style.display = weekDiv.style.display === 'none' ? 'block' : 'none';
}

function toggleMobileAdminDetails(empId) {
  const detailsDiv = document.getElementById(`mobile-details-${empId}`);
  if (!detailsDiv) return;
  
  if (detailsDiv.style.display === 'none') {
    const records = adminEmployeeRecordsCache[empId] || [];
    if (records.length === 0) {
      detailsDiv.innerHTML = '<p style="color: #64748b; text-align: center;">אין רשומות</p>';
    } else {
      // Get current month/year from dashboard filters
      const now = new Date();
      const user = getCurrentUserData();
      const isInstructor = user && user.role === 'instructor';
      const dashboardMonth = isInstructor 
        ? document.getElementById('instructorMonth')
        : (document.getElementById('dashboardMonth') || document.getElementById('instructorMonth'));
      const dashboardYear = isInstructor
        ? document.getElementById('instructorYear')
        : (document.getElementById('dashboardYear') || document.getElementById('instructorYear'));
      const currentMonth = dashboardMonth ? parseInt(dashboardMonth.value) - 1 : now.getMonth();
      const currentYear = dashboardYear ? parseInt(dashboardYear.value) : now.getFullYear();
      
      // Group records by week of month
      const weekGroups = groupRecordsByWeek(records, currentMonth, currentYear);
      
      if (weekGroups.length === 0) {
        detailsDiv.innerHTML = '<p style="color: #64748b; text-align: center;">אין רשומות בחודש זה</p>';
      } else {
        detailsDiv.innerHTML = weekGroups.map(week => {
          const weekHours = week.records.reduce((sum, r) => sum + parseFloat(r.workHours || r.hours || 0), 0);
          const weekKm = week.records.reduce((sum, r) => sum + parseFloat(r.kilometers || r.km || 0), 0);
          const weekKey = `${week.startDay}-${week.endDay}`;
          return `
            <div style="margin-bottom: 8px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
              <div onclick="event.stopPropagation(); toggleMobileWeekDetails('${empId}', ${week.startDay}, ${week.endDay})" 
                   style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <i class="fas fa-calendar-week" style="color: #3b82f6; margin-left: 8px;"></i>
                  <strong style="font-size: 14px;">שבוע ${week.weekNum}</strong>
                  <span style="font-size: 11px; color: #64748b; margin-right: 8px;">(${week.dateRange})</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 12px; color: #475569;">${week.records.length} רשומות | ${weekHours.toFixed(1)} שעות</span>
                  <i class="fas fa-chevron-down" id="week-chevron-${empId}-${weekKey}" style="color: #64748b; transition: transform 0.3s;"></i>
                </div>
              </div>
              <div id="week-records-${empId}-${weekKey}" style="display: none; padding: 10px; background: white;">
                <!-- Will be filled when week is expanded -->
              </div>
            </div>
          `;
        }).join('');
      }
    }
    detailsDiv.style.display = 'block';
  } else {
    detailsDiv.style.display = 'none';
  }
}

// Group records by week of month - uses explicit month/year for stability
function groupRecordsByWeek(records, month, year) {
  if (!records || records.length === 0) return [];
  
  // Use passed month/year, or fallback to current date
  const now = new Date();
  const targetMonth = (month !== undefined) ? month : now.getMonth();
  const targetYear = (year !== undefined) ? year : now.getFullYear();
  
  // Calculate week ranges for this month
  const lastDayOfMonth = new Date(targetYear, targetMonth + 1, 0);
  const totalDays = lastDayOfMonth.getDate();
  
  // Create 4 week ranges (equal segments of ~7-8 days each)
  const daysPerWeek = Math.ceil(totalDays / 4);
  const weeks = [];
  
  for (let i = 0; i < 4; i++) {
    const startDay = i * daysPerWeek + 1;
    const endDay = Math.min((i + 1) * daysPerWeek, totalDays);
    weeks.push({
      weekNum: i + 1,
      startDay: startDay,
      endDay: endDay,
      dateRange: `${startDay}-${endDay}`,
      records: []
    });
  }
  
  // Sort records into weeks - only include records from the target month/year
  records.forEach(rec => {
    const recDate = parseRecordDate(rec.attendanceDate || rec.date);
    if (recDate && recDate.getMonth() === targetMonth && recDate.getFullYear() === targetYear) {
      const day = recDate.getDate();
      for (let i = 0; i < weeks.length; i++) {
        if (day >= weeks[i].startDay && day <= weeks[i].endDay) {
          weeks[i].records.push(rec);
          break;
        }
      }
    }
  });
  
  // Return only weeks with records
  return weeks.filter(w => w.records.length > 0);
}

// Parse date from DD/MM/YYYY or YYYY-MM-DD format
function parseRecordDate(dateStr) {
  if (!dateStr) return null;
  if (dateStr.includes('/')) {
    const parts = dateStr.split('/');
    if (parts.length >= 3) {
      return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
    }
  } else if (dateStr.includes('-')) {
    return new Date(dateStr);
  }
  return null;
}

// Toggle week records in mobile view - uses startDay/endDay for stability
function toggleMobileWeekDetails(empId, startDay, endDay) {
  const weekKey = `${startDay}-${endDay}`;
  const recordsDiv = document.getElementById(`week-records-${empId}-${weekKey}`);
  const chevron = document.getElementById(`week-chevron-${empId}-${weekKey}`);
  if (!recordsDiv) return;
  
  if (recordsDiv.style.display === 'none') {
    // Get current month/year from dashboard filters
    const now = new Date();
    const dashboardMonth = document.getElementById('dashboardMonth');
    const dashboardYear = document.getElementById('dashboardYear');
    const currentMonth = dashboardMonth ? parseInt(dashboardMonth.value) - 1 : now.getMonth();
    const currentYear = dashboardYear ? parseInt(dashboardYear.value) : now.getFullYear();
    
    // Get records for this employee
    const allRecords = adminEmployeeRecordsCache[empId] || [];
    
    // Filter records for this specific week by day range
    const weekRecords = allRecords.filter(rec => {
      const recDate = parseRecordDate(rec.attendanceDate || rec.date);
      if (!recDate) return false;
      if (recDate.getMonth() !== currentMonth || recDate.getFullYear() !== currentYear) return false;
      const day = recDate.getDate();
      return day >= startDay && day <= endDay;
    });
    
    if (weekRecords.length === 0) {
      recordsDiv.innerHTML = '<p style="color: #64748b; text-align: center; padding: 10px;">אין רשומות</p>';
    } else {
      // Sort by date
      weekRecords.sort((a, b) => {
        const dateA = parseRecordDate(a.attendanceDate || a.date);
        const dateB = parseRecordDate(b.attendanceDate || b.date);
        return (dateA || 0) - (dateB || 0);
      });
      
      recordsDiv.innerHTML = weekRecords.map(rec => {
        const date = formatDateHebrew(rec.attendanceDate || rec.date);
        const recId = rec.ID || rec.id || '';
        const isApproved = isStatusApproved(rec);
        const isRejected = deriveRecordStatus(rec) === 'rejected';
        const status = getStatusDisplayText(rec);
        const statusColor = isApproved ? '#22c55e' : (isRejected ? '#ef4444' : '#f59e0b');
        const hours = parseFloat(rec.workHours || rec.hours || 0).toFixed(1);
        const km = parseFloat(rec.kilometers || rec.km || 0).toFixed(0);
        
        return `<div style="padding: 10px 0; border-bottom: 1px dashed #e2e8f0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <strong style="font-size: 13px;">${date}</strong>
            <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px;">${status}</span>
          </div>
          <div style="font-size: 12px; color: #475569; margin-bottom: 8px;">
            ${rec.activityType || rec.activity || '-'} | ${hours} שעות | ${km} ק"מ
          </div>
          <div style="display: flex; gap: 8px;">
            ${!isApproved ? `<button onclick="event.stopPropagation(); editRecordFromAdmin('${recId}')" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;"><i class="fas fa-edit"></i> עריכה</button>` : ''}
            ${!isApproved ? `<button onclick="event.stopPropagation(); approveRecordFromAdmin('${recId}')" data-approve-record="${recId}" style="flex: 1; background: #22c55e; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;"><i class="fas fa-check"></i> אישור</button>` : '<span style="color: #22c55e; font-size: 12px;"><i class="fas fa-check-circle"></i> אושר</span>'}
          </div>
        </div>`;
      }).join('');
    }
    
    recordsDiv.style.display = 'block';
    if (chevron) chevron.style.transform = 'rotate(180deg)';
  } else {
    recordsDiv.style.display = 'none';
    if (chevron) chevron.style.transform = 'rotate(0deg)';
  }
}

// Format date to Hebrew format
function formatDateHebrew(dateStr) {
  if (!dateStr) return '-';
  const date = parseRecordDate(dateStr);
  if (!date) return dateStr;
  return date.toLocaleDateString('he-IL');
}

// Edit record from admin dashboard
let adminEditRecordId = null;

async function editRecordFromAdmin(recordId) {
  if (!recordId) {
    showAlert('לא נמצא מזהה רשומה', 'error');
    return;
  }
  
  // Find the record in cache
  let recordToEdit = null;
  for (const empId in adminEmployeeRecordsCache) {
    const found = adminEmployeeRecordsCache[empId].find(r => (r.ID || r.id) == recordId);
    if (found) {
      recordToEdit = found;
      break;
    }
  }
  
  if (!recordToEdit) {
    showAlert('לא נמצאה רשומה לעריכה', 'error');
    return;
  }
  
  // Store for saving
  adminEditRecordId = recordId;
  
  // Populate edit form
  const rec = recordToEdit;
  document.getElementById('editDate').value = rec.attendanceDate || rec.date || '';
  // Set time dropdowns properly
  setTimeDropdowns('editStart', rec.startTime || rec.start || '');
  setTimeDropdowns('editEnd', rec.endTime || rec.end || '');
  // Set hours - ensure proper formatting
  const hoursVal = rec.workHours || rec.hours || 0;
  document.getElementById('editHours').value = typeof hoursVal === 'number' ? hoursVal.toFixed(2) : hoursVal;
  document.getElementById('editActivity').value = rec.activityType || rec.activity || '';
  
  // Populate school dropdown
  const schoolSelect = document.getElementById('editSchool');
  schoolSelect.innerHTML = '<option value="">בחר בית ספר</option>';
  schoolsData.forEach(school => {
    const option = document.createElement('option');
    option.value = JSON.stringify(school);
    option.textContent = school['בית ספר'];
    if (school['בית ספר'] === (rec.schoolName || rec.school)) {
      option.selected = true;
    }
    schoolSelect.appendChild(option);
  });
  
  document.getElementById('editMunicipality').value = rec.municipality || '';
  document.getElementById('editProgram').value = rec.programName || rec.program || '';
  document.getElementById('editSession').value = rec.sessionNumber || rec.session || '';
  document.getElementById('editKm').value = rec.kilometers || rec.km || '';
  document.getElementById('editTotalExpenses').value = rec.totalExpenses || '';
  document.getElementById('editExpensesDetail').value = rec.expensesDetails || rec.expensesDetail || '';
  document.getElementById('editNotes').value = rec.notes || '';
  
  // Handle zoom school
  if ((rec.schoolName || rec.school) === 'זום') {
    document.getElementById('editKm').value = '0';
    document.getElementById('editKm').readOnly = true;
    document.getElementById('editKm').style.background = '#f1f5f9';
  } else {
    document.getElementById('editKm').readOnly = false;
    document.getElementById('editKm').style.background = 'white';
  }
  
  // Show modal
  document.getElementById('editModal').style.display = 'flex';
}

// Populate edit form with record data
function populateEditForm(record) {
  const setVal = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.value = val || '';
  };
  
  // Main fields - use correct form field IDs
  setVal('recDate', record.attendanceDate || '');
  setVal('startTime', record.startTime || '');
  setVal('endTime', record.endTime || '');
  setVal('hoursField', record.workHours || record.hours || '');
  setVal('activityType', record.activityType || '');
  setVal('municipality', record.municipality || '');
  setVal('programField', record.programName || '');
  setVal('sessionNum', record.sessionNumber || '');
  setVal('kmField', record.kilometers || record.km || '');
  setVal('totalExpenses', record.totalExpenses || '');
  setVal('expensesDetail', record.expensesDetails || '');
  setVal('notesField', record.notes || '');
  
  // Set start/end time dropdowns
  if (record.startTime) {
    const [sh, sm] = record.startTime.split(':');
    setVal('startHour', sh);
    setVal('startMinute', sm);
  }
  if (record.endTime) {
    const [eh, em] = record.endTime.split(':');
    setVal('endHour', eh);
    setVal('endMinute', em);
  }
  
  // Mark as editing
  const pageHeader = document.querySelector('#addRecordPage .page-header h1');
  if (pageHeader) {
    pageHeader.textContent = 'עריכת רשומה';
  }
  
  // Store record ID for update
  document.getElementById('addRecordPage').dataset.editingId = record.ID || record.id || '';
  
  showAlert('נטען לעריכה - בצע שינויים ולחץ שמור', 'info');
}

// Approve single record from admin dashboard - Optimistic UI
async function approveRecordFromAdmin(recordId) {
  console.log('approveRecordFromAdmin called with recordId:', recordId);
  
  if (!recordId) {
    showAlert('לא נמצא מזהה רשומה', 'error');
    return;
  }
  
  const user = getCurrentUserData();
  if (!user) {
    showAlert('יש להתחבר למערכת', 'error');
    return;
  }
  
  // Check permissions
  if (!['manager', 'system_admin', 'operations_controller'].includes(user.role)) {
    showAlert('אין הרשאה לאשר רשומות', 'error');
    return;
  }
  
  // Find the record in caches
  let record = null;
  let recordIndex = -1;
  let cacheSource = null;
  let empIdForCache = null;
  
  // Search in teamRecordsCache
  if (typeof teamRecordsCache !== 'undefined' && Array.isArray(teamRecordsCache)) {
    recordIndex = teamRecordsCache.findIndex(r => String(r.ID || r.id || r.recordId) === String(recordId));
    if (recordIndex !== -1) {
      record = teamRecordsCache[recordIndex];
      cacheSource = 'teamRecordsCache';
    }
  }
  
  // Search in adminEmployeeRecordsCache
  if (!record && typeof adminEmployeeRecordsCache !== 'undefined') {
    for (const empId in adminEmployeeRecordsCache) {
      recordIndex = adminEmployeeRecordsCache[empId].findIndex(r => String(r.ID || r.id || r.recordId) === String(recordId));
      if (recordIndex !== -1) {
        record = adminEmployeeRecordsCache[empId][recordIndex];
        cacheSource = 'adminEmployeeRecordsCache';
        empIdForCache = empId;
        break;
      }
    }
  }
  
  if (!record) {
    showAlert('לא נמצאה הרשומה במטמון. נסה לרענן את הדף.', 'error');
    return;
  }
  
  // Log the raw record for debugging
  console.log('=== RAW RECORD FROM CACHE ===');
  console.log('record.status:', record.status, '(type:', typeof record.status, ')');
  console.log('record.team:', record.team, '(type:', typeof record.team, ')');
  console.log('record.employeeId:', record.employeeId, 'record.empNum:', record.empNum);
  console.log('record.ID:', record.ID, 'record.id:', record.id);
  console.log('All record keys:', Object.keys(record));
  
  // Save original status for rollback
  const originalStatus = record.status;
  const originalApprovedBy = record.approvedBy;
  const originalApprovedDate = record.approvedDate;
  
  // OPTIMISTIC UPDATE: Update cache immediately
  const approvalData = {
    status: 'approved',
    approvedBy: user.empName || user.empNum,
    approvedDate: new Date().toISOString()
  };
  
  // Update record in cache (this updates by reference)
  Object.assign(record, approvalData);
  
  // Also update the other cache if record exists there (keep both caches in sync)
  const strRecordId = String(recordId);
  if (cacheSource === 'teamRecordsCache' && typeof adminEmployeeRecordsCache !== 'undefined') {
    // Found in teamRecordsCache, also update adminEmployeeRecordsCache
    for (const empId in adminEmployeeRecordsCache) {
      const otherRecord = adminEmployeeRecordsCache[empId].find(r => String(r.ID || r.id || r.recordId) === strRecordId);
      if (otherRecord) {
        Object.assign(otherRecord, approvalData);
        break;
      }
    }
  } else if (cacheSource === 'adminEmployeeRecordsCache' && typeof teamRecordsCache !== 'undefined') {
    // Found in adminEmployeeRecordsCache, also update teamRecordsCache
    const otherRecord = teamRecordsCache.find(r => String(r.ID || r.id || r.recordId) === strRecordId);
    if (otherRecord) {
      Object.assign(otherRecord, approvalData);
    }
  }
  
  // OPTIMISTIC UPDATE: Update DOM immediately
  updateApprovalButtonInDOM(recordId, true);
  showLoadingBar();
  
  // Send to API in background
  try {
    const empId = String(record.employeeId || record.empNum || '');
    const payload = {
      action: 'updaterecord',
      recordId: String(recordId),
      employeeId: empId,
      employeeName: extractLookupValue(record.employeeName || record.empName, ''),
      team: extractLookupValue(record.team, ''),
      employmentType: normalizeEmploymentType(record, ''),
      attendanceDate: extractLookupValue(record.attendanceDate || record.date, ''),
      startTime: extractLookupValue(record.startTime || record.start, ''),
      endTime: extractLookupValue(record.endTime || record.end, ''),
      workHours: Number(record.workHours || record.hours) || 0,
      activityType: extractLookupValue(record.activityType || record.activity, ''),
      schoolName: extractLookupValue(record.schoolName || record.school, ''),
      municipality: extractLookupValue(record.municipality, ''),
      programName: extractLookupValue(record.programName || record.program, ''),
      sessionNumber: Number(record.sessionNumber || record.session) || 0,
      kilometers: Number(record.kilometers || record.km) || 0,
      totalExpenses: Number(record.totalExpenses) || 0,
      expensesDetails: extractLookupValue(record.expensesDetails || record.expensesDetail, ''),
      notes: extractLookupValue(record.notes, ''),
      attachmentsNames: extractLookupValue(record.attachmentsNames, ''),
      ...approvalData
    };
    
    console.log('=== APPROVE RECORD - FULL PAYLOAD ===');
    console.log(JSON.stringify(payload, null, 2));
    
    const data = await apiRequest('updaterecord', payload);
    
    console.log('=== APPROVE RECORD - API RESPONSE ===');
    console.log(JSON.stringify(data, null, 2));
    
    if (!data.success) {
      throw new Error(data.message || data.error || 'שגיאה בעדכון הרשומה');
    }
    
    // VERIFICATION: Re-fetch the record from SharePoint to confirm persistence
    console.log('=== APPROVE RECORD - VERIFYING PERSISTENCE ===');
    try {
      const verifyData = await apiRequest('getemployeerecords', { employeeId: empId });
      if (verifyData.success && Array.isArray(verifyData.records)) {
        const updatedRecord = verifyData.records.find(r => String(r.ID || r.Id || r.id) === String(recordId));
        if (updatedRecord) {
          console.log('=== VERIFICATION - RAW RECORD KEYS ===');
          console.log('All keys:', Object.keys(updatedRecord).join(', '));
          const statusKeys = Object.keys(updatedRecord).filter(k => k.toLowerCase().includes('status'));
          console.log('Status-related keys:', statusKeys.map(k => k + '=' + JSON.stringify(updatedRecord[k])).join(', '));
          
          const derivedStatus = deriveRecordStatus(updatedRecord);
          const approvedByVal = updatedRecord.approvedBy || updatedRecord.ApprovedBy || '';
          console.log('=== VERIFICATION RESULT ===');
          console.log('Record', recordId, '- derived status:', derivedStatus);
          console.log('Record', recordId, '- approvedBy:', approvedByVal);
          if (derivedStatus !== 'approved') {
            console.error('APPROVAL NOT PERSISTED! approvedBy is empty. Derived status:', derivedStatus);
          } else {
            console.log('APPROVAL VERIFIED - approvedBy persisted successfully:', approvedByVal);
          }
        } else {
          console.warn('Could not find record', recordId, 'in verification response. Available IDs:', 
            verifyData.records.slice(0, 5).map(r => r.ID || r.Id || r.id));
        }
      }
    } catch (verifyError) {
      console.warn('Verification fetch failed (non-critical):', verifyError.message);
    }
    
    hideLoadingBar();
  } catch (error) {
    hideLoadingBar();
    console.error('Error approving record on server:', error);
    
    // ROLLBACK: Restore original status in cache
    const rollbackData = {
      status: originalStatus,
      approvedBy: originalApprovedBy,
      approvedDate: originalApprovedDate
    };
    Object.assign(record, rollbackData);
    
    // ROLLBACK: Also restore the other cache
    if (cacheSource === 'teamRecordsCache' && typeof adminEmployeeRecordsCache !== 'undefined') {
      for (const empId in adminEmployeeRecordsCache) {
        const otherRecord = adminEmployeeRecordsCache[empId].find(r => String(r.ID || r.id || r.recordId) === strRecordId);
        if (otherRecord) {
          Object.assign(otherRecord, rollbackData);
          break;
        }
      }
    } else if (cacheSource === 'adminEmployeeRecordsCache' && typeof teamRecordsCache !== 'undefined') {
      const otherRecord = teamRecordsCache.find(r => String(r.ID || r.id || r.recordId) === strRecordId);
      if (otherRecord) {
        Object.assign(otherRecord, rollbackData);
      }
    }
    
    // ROLLBACK: Restore DOM
    updateApprovalButtonInDOM(recordId, false);
    showAlert('שגיאה באישור הרשומה: ' + (error.message || ''), 'error');
  }
}

// Store original HTML for rollback - keyed by recordId
const approvalOriginalHTML = {};

// Helper function to update approval button in DOM without full refresh
function updateApprovalButtonInDOM(recordId, isApproved, saveOriginal = true) {
  const strId = String(recordId);
  
  // Find by data attribute first (preferred), then by onclick
  let approveBtn = document.querySelector(`[data-approve-record="${strId}"]`);
  if (!approveBtn) {
    approveBtn = document.querySelector(`button[onclick*="approveRecordFromAdmin('${strId}')"]`) ||
                 document.querySelector(`button[onclick*='approveRecordFromAdmin("${strId}")']`);
  }
  
  if (approveBtn) {
    const cell = approveBtn.closest('td') || approveBtn.closest('div.record-actions') || approveBtn.parentElement;
    if (cell) {
      // Save original HTML for potential rollback
      if (saveOriginal && isApproved) {
        approvalOriginalHTML[strId] = cell.innerHTML;
      }
      
      if (isApproved) {
        cell.innerHTML = '<span style="color: #22c55e; font-weight: 600;"><i class="fas fa-check-circle"></i> מאושר</span>';
      } else {
        // Restore from saved HTML or recreate button
        if (approvalOriginalHTML[strId]) {
          cell.innerHTML = approvalOriginalHTML[strId];
          delete approvalOriginalHTML[strId];
        } else {
          cell.innerHTML = `<button onclick="approveRecordFromAdmin('${strId}')" data-approve-record="${strId}" style="background: #22c55e; color: white; border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 11px;" data-testid="button-approve-${strId}"><i class="fas fa-check"></i></button>`;
        }
      }
    }
  }
  
  // Also update status badge if exists (both desktop and mobile)
  const statusBadges = document.querySelectorAll(`[data-record-status="${strId}"]`);
  statusBadges.forEach(statusBadge => {
    if (isApproved) {
      statusBadge.style.background = '#dcfce7';
      statusBadge.style.color = '#166534';
      statusBadge.innerHTML = '<i class="fas fa-check-circle"></i> מאושר';
    } else {
      statusBadge.style.background = '#fef3c7';
      statusBadge.style.color = '#92400e';
      statusBadge.innerHTML = '<i class="fas fa-clock"></i> ממתין';
    }
  });
}

// Approve team month
async function approveTeamMonth(teamName) {
  const user = getCurrentUserData();
  if (!user || user.role !== 'system_admin') {
    showAlert('אין הרשאה לבצע אישור', 'error');
    return;
  }
  
  const now = new Date();
  const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  const teamLabel = teamName === 'all' ? 'כל הצוותים' : `צוות ${teamName}`;
  
  if (!confirm(`האם לאשר את ${teamLabel} לחודש ${monthKey}?`)) {
    return;
  }
  
  try {
    showAlert(`מאשר ${teamLabel}...`, 'info');
    
    // In a real implementation, this would call the Logic App
    // For now, show success message
    const data = await apiRequest('setmanagerapproval', {
      team: teamName,
      monthKey: monthKey
    });
    
    if (data.success) {
      showAlert(`${teamLabel} אושר בהצלחה!`, 'success');
    } else {
      showAlert(data.message || 'שגיאה באישור', 'error');
    }
  } catch (error) {
    console.error('Error approving team:', error);
    showAlert('שגיאה באישור הצוות: ' + (error.message || 'נסה שוב'), 'error');
  }
}

function toggleAdminEmployeeDetails(empId) {
  const detailsRow = document.getElementById(`admin-details-${empId}`);
  const chevron = document.getElementById(`admin-chevron-${empId}`);
  const detailsContent = document.getElementById(`admin-details-content-${empId}`);
  
  if (detailsRow.style.display === 'none') {
    // Expand
    detailsRow.style.display = 'table-row';
    chevron.style.transform = 'rotate(-90deg)';
    
    // Load details if not already loaded
    if (!detailsContent.dataset.loaded) {
      const records = adminEmployeeRecordsCache[empId] || [];
      
      if (records.length === 0) {
        detailsContent.innerHTML = '<p style="text-align: center; color: #64748b;">אין ימי עבודה</p>';
      } else {
        const extractValue = (field) => {
          if (!field) return '';
          if (typeof field === 'string') return field;
          if (typeof field === 'object' && field.Value) return field.Value;
          return '';
        };
        
        detailsContent.innerHTML = `
          <table style="width: 100%; background: white; border-radius: 8px; overflow: hidden;">
            <thead>
              <tr style="background: #e0f2fe;">
                <th style="padding: 10px; text-align: right;">תאריך</th>
                <th style="padding: 10px; text-align: center;">התחלה</th>
                <th style="padding: 10px; text-align: center;">סיום</th>
                <th style="padding: 10px; text-align: center;">שעות</th>
                <th style="padding: 10px; text-align: right;">סוג פעילות</th>
                <th style="padding: 10px; text-align: right;">בית ספר</th>
                <th style="padding: 10px; text-align: center;">ק"מ</th>
                <th style="padding: 10px; text-align: center;">הוצאות</th>
                <th style="padding: 10px; text-align: center;">סטטוס</th>
                <th style="padding: 10px; text-align: center;">פעולות</th>
              </tr>
            </thead>
            <tbody>
              ${records.map(rec => {
                const recId = rec.ID || rec.id || '';
                const isApproved = isStatusApproved(rec);
                const isRejected = deriveRecordStatus(rec) === 'rejected';
                const status = getStatusDisplayText(rec);
                const statusColor = isApproved ? '#22c55e' : (isRejected ? '#ef4444' : '#f59e0b');
                return `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                  <td style="padding: 8px; text-align: right; white-space: nowrap;">${rec.attendanceDate || ''}</td>
                  <td style="padding: 8px; text-align: center;">${rec.startTime || ''}</td>
                  <td style="padding: 8px; text-align: center;">${rec.endTime || ''}</td>
                  <td style="padding: 8px; text-align: center; font-weight: 600;">${(rec.workHours || 0).toFixed(1)}</td>
                  <td style="padding: 8px; text-align: right;">${extractValue(rec.activityType) || extractValue(rec.ActivityType) || ''}</td>
                  <td style="padding: 8px; text-align: right;">${extractValue(rec.schoolName) || extractValue(rec.SchoolName) || ''}</td>
                  <td style="padding: 8px; text-align: center;">${rec.kilometers || rec.km || 0}</td>
                  <td style="padding: 8px; text-align: center;">${(rec.totalExpenses || 0).toFixed(0)} ₪</td>
                  <td style="padding: 8px; text-align: center;"><span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${status}</span></td>
                  <td style="padding: 8px; text-align: center; white-space: nowrap;">
                    ${!isApproved ? `<button onclick="event.stopPropagation(); editRecordFromAdmin('${recId}')" style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-left: 4px;" title="עריכה"><i class="fas fa-edit"></i></button>` : ''}
                    ${!isApproved ? `<button onclick="event.stopPropagation(); approveRecordFromAdmin('${recId}')" data-approve-record="${recId}" style="background: #22c55e; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;" title="אישור"><i class="fas fa-check"></i></button>` : '<span style="color: #22c55e;"><i class="fas fa-check-circle"></i></span>'}
                  </td>
                </tr>
              `;}).join('')}
            </tbody>
          </table>
        `;
      }
      detailsContent.dataset.loaded = 'true';
    }
  } else {
    // Collapse
    detailsRow.style.display = 'none';
    chevron.style.transform = 'rotate(0deg)';
  }
}

function clearAdminFilters() {
  const filterEmploymentType = document.getElementById('filterEmploymentType');
  const filterTeam = document.getElementById('filterTeam');
  
  if (filterEmploymentType) filterEmploymentType.value = 'all';
  if (filterTeam) filterTeam.value = 'all';
  
  updateAdminDashboard();
}

function exportAdminDashboardToExcel() {
  const now = new Date();
  const monthKey = getApprovalMonthKey(now.getMonth() + 1, now.getFullYear());
  const dataToExport = adminDashboardRecordsCache.length ? adminDashboardRecordsCache : records;
  exportAttendanceWorkbook(dataToExport, {
    includeSummary: true,
    monthKey,
    filePrefix: 'דוח_עובדים'
  });
}

// =============== Reports Functions ===============
let reportRecords = [];

async function initReportsPage() {
  const now = new Date();
  document.getElementById('reportMonth').value = now.getMonth() + 1;
  document.getElementById('reportYear').value = now.getFullYear();
  populateTeamFilter();
  
  // Load team records first if cache is empty (for admin/manager roles)
  const role = localStorage.getItem("role") || '';
  if (['system_admin', 'operations_controller', 'manager', 'payroll_officer'].includes(role)) {
    if (typeof teamRecordsCache === 'undefined' || teamRecordsCache.length === 0) {
      await loadTeamRecords();
    }
  }
  
  loadReportData();
}

function populateTeamFilter() {
  const teamSelect = document.getElementById('reportTeam');
  if (!teamSelect) return;
  
  const role = localStorage.getItem("role") || '';
  const userTeam = localStorage.getItem("team") || '';
  
  // Manager can only see their own team - hide filter or lock it
  if (role === 'manager' && userTeam) {
    teamSelect.innerHTML = `<option value="${userTeam}">${userTeam}</option>`;
    teamSelect.value = userTeam;
    teamSelect.disabled = true;
    return;
  }
  
  teamSelect.disabled = false;
  const currentValue = teamSelect.value;
  teamSelect.innerHTML = '<option value="all">הכל</option>';
  
  // Use constant list instead of dynamic
  TEAMS_LIST.forEach(team => {
    const option = document.createElement('option');
    option.value = team;
    option.textContent = team;
    teamSelect.appendChild(option);
  });
  
  // Restore previous selection
  if (currentValue && TEAMS_LIST.includes(currentValue)) {
    teamSelect.value = currentValue;
  }
}


function getFilteredRecordsByMonth(recordsList, month, year) {
  return recordsList.filter(rec => {
    const dateStr = rec.date || rec.attendanceDate;
    if (!dateStr) return false;
    const recDate = parseRecordDate(dateStr);
    if (!recDate) return false;
    return recDate.getMonth() + 1 === parseInt(month) && recDate.getFullYear() === parseInt(year);
  });
}

async function loadReportData() {
  const month = document.getElementById('reportMonth').value;
  const year = document.getElementById('reportYear').value;
  const employmentType = document.getElementById('reportEmploymentType')?.value || 'all';
  const team = document.getElementById('reportTeam')?.value || 'all';
  const activityType = document.getElementById('reportActivityType')?.value || 'all';
  
  const user = getCurrentUserData();
  if (!user) return;
  
  if (!isMobileView()) {
    showAlert('טוען נתוני דוח...', 'info');
  }
  
  // Helper function to get available records fallback
  function getAvailableRecords() {
    // Try teamRecordsCache first (for admins/managers), then personal records
    if (typeof teamRecordsCache !== 'undefined' && teamRecordsCache.length > 0) {
      return teamRecordsCache.map(rec => normalizeRecordFromServer(rec));
    }
    return records;
  }
  
  try {
    if (isMobileView()) {
      reportRecords = getFilteredRecordsByMonth(getAvailableRecords(), month, year);
    } else {
      const data = await apiRequest('getsummary', {});
      
      if (!data.success || !Array.isArray(data.records)) {
        reportRecords = getFilteredRecordsByMonth(getAvailableRecords(), month, year);
      } else {
        reportRecords = data.records.map(rec => normalizeRecordFromServer(rec));
      }
    }
    
    reportRecords = getFilteredRecordsByMonth(reportRecords, month, year);
    
    // Manager can only see their own team
    if (user.role === 'manager') {
      const managerTeam = (user.team || localStorage.getItem('team') || '').trim().toLowerCase();
      if (managerTeam) {
        reportRecords = reportRecords.filter(rec => {
          const recTeam = extractLookupValue(rec.team, '').trim().toLowerCase();
          return recTeam === managerTeam;
        });
      }
    }
    
    if (employmentType !== 'all') {
      reportRecords = reportRecords.filter(rec => {
        const recType = extractLookupValue(rec.employmentType, '');
        return recType === employmentType;
      });
    }
    
    if (team !== 'all') {
      reportRecords = reportRecords.filter(rec => {
        const recTeam = extractLookupValue(rec.team, '').trim().toLowerCase();
        return recTeam === team.trim().toLowerCase();
      });
    }
    
    if (activityType !== 'all') {
      reportRecords = reportRecords.filter(rec => (rec.activity || rec.activityType) === activityType);
    }
    
    updateReportStats();
    renderReportByEmployee();
    if (!isMobileView()) {
      showAlert(`נטענו ${reportRecords.length} ימי עבודה לחודש ${month}/${year}`, 'success');
    }
  } catch (error) {
    console.error('Load report data error:', error);
    reportRecords = getFilteredRecordsByMonth(getAvailableRecords(), month, year);
    updateReportStats();
    renderReportByEmployee();
  }
}

function updateReportStats() {
  const totalHours = reportRecords.reduce((sum, rec) => sum + (parseFloat(rec.hours) || 0), 0);
  const totalKm = reportRecords.reduce((sum, rec) => sum + (parseFloat(rec.km) || 0), 0);
  const totalExpenses = reportRecords.reduce((sum, rec) => sum + (parseFloat(rec.totalExpenses) || 0), 0);
  
  document.getElementById('teamTotalHours').textContent = formatHoursDisplay(totalHours);
  document.getElementById('teamTotalKm').textContent = totalKm.toFixed(1);
  document.getElementById('teamTotalExpenses').textContent = `${totalExpenses.toFixed(0)} ₪`;
}

function renderReportByEmployee() {
  const container = document.getElementById('reportsByEmployee');
  
  if (reportRecords.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px;">אין ימי עבודה לתקופה הנבחרת</p>';
    return;
  }

  if (isMobileView()) {
    const totals = {
      count: reportRecords.length,
      hours: reportRecords.reduce((s, r) => s + (parseFloat(r.hours) || 0), 0),
      km: reportRecords.reduce((s, r) => s + (parseFloat(r.km) || 0), 0),
      expenses: reportRecords.reduce((s, r) => s + (parseFloat(r.totalExpenses) || 0), 0)
    };

    container.innerHTML = `
      <div class="mobile-report-summary">
        <div style="font-weight: 600; margin-bottom: 8px;">במובייל מוצג סיכום כללי בלבד.</div>
        <div>שעות: <strong>${formatHoursDisplay(totals.hours)}</strong></div>
        <div>ק"מ: <strong>${totals.km.toFixed(0)}</strong></div>
        <div>הוצאות: <strong>${totals.expenses.toFixed(0)} ₪</strong></div>
      </div>
    `;
    return;
  }
  
  const byEmployee = {};
  reportRecords.forEach(rec => {
    const key = rec.empName || 'לא ידוע';
    if (!byEmployee[key]) {
      byEmployee[key] = { empNum: rec.empNum, hours: 0, km: 0, expenses: 0, count: 0 };
    }
    byEmployee[key].hours += parseFloat(rec.hours) || 0;
    byEmployee[key].km += parseFloat(rec.km) || 0;
    byEmployee[key].expenses += parseFloat(rec.totalExpenses) || 0;
    byEmployee[key].count++;
  });
  
  let html = `
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>שם עובד</th>
            <th>מספר עובד</th>
            <th>שעות</th>
            <th>ק"מ</th>
            <th>הוצאות</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  Object.keys(byEmployee).sort().forEach(name => {
    const emp = byEmployee[name];
    html += `
      <tr>
        <td>${name || 'לא ידוע'}</td>
        <td>${emp.empNum || '-'}</td>
        <td><strong>${formatHoursDisplay(emp.hours)}</strong></td>
        <td>${emp.km.toFixed(0)}</td>
        <td>${emp.expenses.toFixed(0)} ₪</td>
      </tr>
    `;
  });
  
  const totals = {
    count: reportRecords.length,
    hours: reportRecords.reduce((s, r) => s + (parseFloat(r.hours) || 0), 0),
    km: reportRecords.reduce((s, r) => s + (parseFloat(r.km) || 0), 0),
    expenses: reportRecords.reduce((s, r) => s + (parseFloat(r.totalExpenses) || 0), 0)
  };
  
  html += `
      <tr style="background: #f8fafc; font-weight: bold; border-top: 2px solid #3b82f6;">
        <td colspan="2">סה"כ</td>
        <td style="color: #3b82f6;">${totals.hours.toFixed(1)}</td>
        <td style="color: #3b82f6;">${totals.km.toFixed(0)}</td>
        <td style="color: #3b82f6;">${totals.expenses.toFixed(0)} ₪</td>
      </tr>
        </tbody>
      </table>
    </div>
  `;
  
  container.innerHTML = html;
}

function openExportModal() {
  if (reportRecords.length === 0) {
    showAlert('⚠️ אין נתונים לייצוא', 'error');
    return;
  }
  document.getElementById('exportModal').style.display = 'flex';
}

function closeExportModal() {
  document.getElementById('exportModal').style.display = 'none';
}

function exportReportToExcel(type = 'all') {
  if (reportRecords.length === 0) {
    showAlert('⚠️ אין נתונים לייצוא', 'error');
    return;
  }
  
  const month = document.getElementById('reportMonth').value;
  const year = document.getElementById('reportYear').value;
  const monthKey = getApprovalMonthKey(month, year);
  const prefix = type === 'grouped' ? 'דוח_נוכחות_מקובץ' : 'דוח_נוכחות_מלא';

  exportAttendanceWorkbook(reportRecords, {
    includeSummary: true,
    monthKey,
    filePrefix: prefix
  });

  closeExportModal();
}

// =============== File Upload Functions ===============
let selectedFiles = [];

function initFileUpload() {
  const dropZone = document.getElementById('fileDropZone');
  if (!dropZone) return;
  
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });
  
  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });
  
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    addFiles(files);
  });
}

function handleFileSelect(event) {
  const files = event.target.files;
  addFiles(files);
}

function addFiles(fileList) {
  const maxSize = 5 * 1024 * 1024; // 5MB
  
  for (let i = 0; i < fileList.length; i++) {
    const file = fileList[i];
    
    if (file.size > maxSize) {
      showAlert(`הקובץ ${file.name} גדול מדי (מקסימום 5MB)`, 'error');
      continue;
    }
    
    if (!selectedFiles.find(f => f.name === file.name)) {
      selectedFiles.push(file);
    }
  }
  
  renderFileList();
}

function renderFileList() {
  const container = document.getElementById('fileList');
  if (!container) return;
  
  if (selectedFiles.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  const getIcon = (name) => {
    const ext = name.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'fa-image';
    if (ext === 'pdf') return 'fa-file-pdf';
    if (['doc', 'docx'].includes(ext)) return 'fa-file-word';
    if (['xls', 'xlsx'].includes(ext)) return 'fa-file-excel';
    return 'fa-file';
  };
  
  container.innerHTML = selectedFiles.map((file, idx) => `
    <div class="file-item">
      <div class="file-item-name">
        <i class="fas ${getIcon(file.name)}" style="color: #3b82f6;"></i>
        <span>${file.name}</span>
        <small style="color: #94a3b8;">(${(file.size / 1024).toFixed(1)} KB)</small>
      </div>
      <button type="button" class="file-item-remove" onclick="removeFile(${idx})">
        <i class="fas fa-times" style="font-size: 12px;"></i>
      </button>
    </div>
  `).join('');
}

function removeFile(index) {
  selectedFiles.splice(index, 1);
  renderFileList();
}

function clearSelectedFiles() {
  selectedFiles = [];
  renderFileList();
  const input = document.getElementById('attachments');
  if (input) input.value = '';
}

async function uploadFilesToSharePoint(employeeId, attendanceDate) {
  if (selectedFiles.length === 0) return { success: true, urls: [] };
  
  const uploadedUrls = [];
  
  for (let i = 0; i < selectedFiles.length; i++) {
    const file = selectedFiles[i];
    try {
      // Convert file to base64
      const base64Content = await fileToBase64(file);
      
      // File naming: employeeId_attendanceDate.extension
      const ext = file.name.split('.').pop() || 'bin';
      const formattedDate = String(attendanceDate).replace(/\//g, '-');
      const suffix = selectedFiles.length > 1 ? `_${i + 1}` : '';
      const standardFileName = `${employeeId}_${formattedDate}${suffix}.${ext}`;
      
      const payload = {
        action: 'uploadfile',
        employeeId: String(employeeId),
        attendanceDate: String(attendanceDate),
        fileName: standardFileName,
        fileContent: base64Content
      };
      
      const response = await apiRequest('uploadfile', payload);
      
      if (response.success) {
        uploadedUrls.push(response.fileUrl);
        console.log('File uploaded successfully:', file.name);
      } else {
        console.error('Failed to upload file:', file.name);
        showAlert(`שגיאה בהעלאת ${file.name}`, 'error');
      }
    } catch (error) {
      console.error('Error uploading file:', file.name, error);
      showAlert(`שגיאה בהעלאת ${file.name}`, 'error');
    }
  }
  
  if (uploadedUrls.length > 0) {
    showAlert(`${uploadedUrls.length} קבצים הועלו בהצלחה`, 'success');
  }
  
  return { success: uploadedUrls.length > 0, urls: uploadedUrls };
}

// Helper function to convert file to base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => {
      // Remove the data:mime/type;base64, prefix
      const base64 = reader.result.split(',')[1];
      resolve(base64);
    };
    reader.onerror = error => reject(error);
  });
}

function clearAllData() {
  if (!confirm('⚠️ אזהרה! פעולה זו תמחק את כל הנתונים!\n\nהאם אתה בטוח לחלוטין?')) {
    return;
  }
  
  if (!confirm('האם אתה באמת בטוח? פעולה זו בלתי הפיכה!')) {
    return;
  }
  
  records = [];
  saveToLocalStorage();
  updateStats();
  renderRecordsTable();
  updateDashboard();
  
  showAlert('🗑️ כל הנתונים נמחקו!', 'success');
}

// =============== Initialize ===============
window.addEventListener('DOMContentLoaded', function() {
  populateSchools();
  populateTimeDropdowns();
  initFileUpload();

  const savedUser = localStorage.getItem('currentUser');
  if (savedUser) {
    try {
      const empData = JSON.parse(savedUser);

      // Validate user data structure - must have essential fields
      if (!empData || typeof empData !== 'object' || !empData.empNum || !empData.empName) {
        console.warn('Invalid user data in localStorage, clearing session');
        clearUserSession();
        return;
      }

      // Validate role is a known value
      const validRoles = ['instructor', 'manager', 'payroll_officer', 'operations_controller', 'system_admin'];
      if (empData.role && !validRoles.includes(empData.role)) {
        console.warn('Invalid role in localStorage:', empData.role, '- defaulting to instructor');
        empData.role = 'instructor';
        localStorage.setItem('currentUser', JSON.stringify(empData));
        localStorage.setItem('role', 'instructor');
      }

      currentUser = empData.empName;

      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');

      document.getElementById('userName').textContent = empData.empName;
      document.getElementById('userRole').textContent = getRoleDisplayName(empData.role || 'instructor');
      document.getElementById('userAvatar').textContent = empData.empName ? empData.empName.charAt(0) : 'ע';
      document.getElementById('mobileUserGreeting').textContent = 'שלום, ' + empData.empName;

      updateMenuByRole(empData.role || 'instructor');
      loadFromLocalStorage();
      
      // Initialize month selectors BEFORE updateStats to ensure correct filtering
      initInstructorMonthSelectors();
      
      updateStats();
      showPage(null, 'dashboard');

      // Load fresh records from server to ensure data is not stale
      if (localStorage.getItem('employeeId')) {
        loadMyRecordsFromServer();
      }
    } catch(e) {
      console.error('Error loading user session:', e);
      // Clear corrupted data and show login
      clearUserSession();
    }
  }
});

// Helper to clear user session on invalid data
function clearUserSession() {
  localStorage.removeItem('currentUser');
  localStorage.removeItem('employeeId');
  localStorage.removeItem('employeeName');
  localStorage.removeItem('role');
  localStorage.removeItem('employmentType');
  localStorage.removeItem('team');
  localStorage.removeItem('attendanceRecords');
  records = [];
  currentUser = '';
}
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('ServiceWorker registration successful');
      }, err => {
        console.log('ServiceWorker registration failed: ', err);
      });
  });
}
</script>
</body>

</html>
